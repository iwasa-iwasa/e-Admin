# 部署拡張要件定義書 v3.0（最終版）

## 📋 目次

### 1. 確定事項
- [実装方針](#実装方針)
- [採用する仕様](#採用する仕様)

### 2. 主要機能
- [全社カレンダー承認フロー](#全社カレンダー承認フロー)
- [データ共有機能](#データ共有機能)
- [繰り返し予定の動的展開](#繰り返し予定の動的展開)
- [同時編集競合処理](#同時編集競合処理)
- [監査ログ](#監査ログ)

### 3. リスク管理
- [技術的リスクと対策](#技術的リスクと対策)
- [運用的リスクと対策](#運用的リスクと対策)

### 4. 先方確認事項
- [運用面の確認事項](#運用面の確認事項)
- [技術面の確認事項](#技術面の確認事項)

### 5. 実装計画
- [開発フェーズ](#開発フェーズ)
- [工数見積もり](#工数見積もり)

---

## 実装方針

### ✅ 採用する仕様

| 項目 | 方針 | 理由 |
|------|------|------|
| 全社カレンダー投稿 | 承認フロー必須 | 品質管理・統制 |
| データ共有 | 共有方式（同一データ） | 整合性保証 |
| 繰り返し予定 | 動的展開 | DB肥大化防止 |
| 同時編集競合 | 楽観的ロック | データ損失防止 |
| 監査ログ | 共有予定のみ記録 | 最小限の追跡 |
| ユーザートレーニング | 不要 | 既に説明会実施済み |

---

## 全社カレンダー承認フロー

### データベース

```sql
CREATE TABLE company_event_requests (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    event_data JSON NOT NULL,
    requested_by BIGINT NOT NULL,
    requested_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending',
    reviewed_by BIGINT NULL,
    reviewed_at TIMESTAMP NULL,
    review_comment TEXT NULL,
    FOREIGN KEY (requested_by) REFERENCES users(id),
    FOREIGN KEY (reviewed_by) REFERENCES users(id),
    INDEX idx_status (status)
);
```

### フロー

```
部署管理者が申請 → 全社管理者に通知 → 承認/却下 → 結果通知
```

### 実装コード

```php
// 申請
public function requestCompanyEvent(Request $request)
{
    CompanyEventRequest::create([
        'event_data' => json_encode($request->validated()),
        'requested_by' => auth()->id(),
    ]);
    
    Notification::send(
        User::where('role_type', 'company_admin')->get(),
        new CompanyEventRequested()
    );
}

// 承認
public function approve(CompanyEventRequest $request)
{
    Event::create([
        ...json_decode($request->event_data, true),
        'calendar_id' => $this->getCompanyCalendar()->id,
    ]);
    
    $request->update(['status' => 'approved', 'reviewed_by' => auth()->id()]);
}
```

---

## データ共有機能

### データベース

```sql
CREATE TABLE calendar_event_shares (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    calendar_id BIGINT NOT NULL,
    event_id BIGINT NOT NULL,
    shared_by BIGINT NOT NULL,
    shared_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY (calendar_id, event_id),
    FOREIGN KEY (calendar_id) REFERENCES calendars(calendar_id) ON DELETE CASCADE,
    FOREIGN KEY (event_id) REFERENCES events(event_id) ON DELETE CASCADE,
    INDEX idx_calendar (calendar_id),
    INDEX idx_event (event_id)
);
```

### 共有先一覧UI

```vue
<template>
  <Card>
    <CardHeader>
      <CardTitle>共有先カレンダー</CardTitle>
    </CardHeader>
    <CardContent>
      <div class="space-y-2">
        <div v-for="share in shares" :key="share.id" 
             class="flex items-center justify-between p-2 border rounded">
          <div>
            <div class="font-medium">{{ share.calendar.name }}</div>
            <div class="text-xs text-gray-500">
              {{ share.shared_by.name }}が{{ formatDate(share.shared_at) }}に共有
            </div>
          </div>
          <Button variant="ghost" size="sm" @click="unshare(share.id)">
            <X class="h-4 w-4" />
          </Button>
        </div>
      </div>
    </CardContent>
  </Card>
</template>
```

---

## 繰り返し予定の動的展開

### 実装

```php
public function getExpandedEvents(string $start, string $end)
{
    $events = Event::with('recurrence')->get();
    $expanded = [];
    
    foreach ($events as $event) {
        if ($event->recurrence) {
            $expanded = array_merge(
                $expanded,
                $this->expandRecurrence($event, $start, $end)
            );
        } else {
            if ($event->start_date <= $end && $event->end_date >= $start) {
                $expanded[] = $event;
            }
        }
    }
    
    return $expanded;
}
```

---

## 同時編集競合処理

### データベース

```sql
ALTER TABLE events ADD COLUMN version INT DEFAULT 0;
ALTER TABLE shared_notes ADD COLUMN version INT DEFAULT 0;
ALTER TABLE surveys ADD COLUMN version INT DEFAULT 0;
```

### フロー

```
ユーザーA: 開く(v1) → 保存成功(v2)
ユーザーB: 開く(v1) → 保存失敗(競合) → 選択肢表示
  1. 再読み込み
  2. 強制保存
  3. 手動マージ
```

### 実装

```php
public function update(Request $request, Event $event)
{
    if ($event->version !== $request->input('version')) {
        return response()->json([
            'conflict' => true,
            'current_data' => $event->fresh(),
            'your_changes' => $request->validated(),
        ], 409);
    }
    
    $event->update([
        ...$request->validated(),
        'version' => $event->version + 1,
    ]);
}
```

---

## 監査ログ

### 記録対象（最小限）

- ✅ 他部署への予定共有
- ✅ 全社カレンダー承認/却下
- ✅ 強制保存（競合時）

### データベース

```sql
CREATE TABLE audit_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    action VARCHAR(50) NOT NULL,
    user_id BIGINT NOT NULL,
    event_id BIGINT NULL,
    calendar_id BIGINT NULL,
    details JSON NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_action (action),
    INDEX idx_created_at (created_at)
);
```

---

## 技術的リスクと対策

### 🔴 高リスク

#### 1. データ移行失敗

**リスク内容**: 既存データ（数百件）の部署システムへの移行時にエラー発生

**発生タイミング**: 
- 本番環境での移行実行時
- テーブル構造変更時
- 外部キー制約追加時

**影響**: 
- ダウンタイム延長（予定1-2分 → 最悪30分以上）
- データ損失・不整合
- サービス停止

**対策**:
```bash
# 1. 完全バックアップ（必須）
mysqldump -u user -p database > backup_$(date +%Y%m%d_%H%M%S).sql

# 2. テスト環境で3回以上検証
php artisan migrate:department-system --env=testing

# 3. ロールバック手順の準備
mysql -u user -p database < backup_20250120_020000.sql

# 4. 段階的移行（部署ごと）
php artisan migrate:department --department=総務部
php artisan migrate:department --department=営業部
```

**チェックリスト**:
- [ ] 本番データのバックアップ取得
- [ ] テスト環境での移行成功（3回）
- [ ] ロールバック手順の確認
- [ ] 移行時間の計測（テスト環境）
- [ ] メンテナンス通知の送信

---

#### 2. パフォーマンス劣化

**リスク内容**: 複雑なクエリ（部署・公開範囲・参加者の組み合わせ）で表示遅延

**インデックスとは**: データベースの「目次」のようなもの。本の目次があれば該当ページをすぐ見つけられるように、インデックスがあればデータをすぐ検索できる。

**なぜ15個以上必要か**:

| テーブル | インデックス | 理由 |
|---------|------------|------|
| users | department_id | 部署でユーザー検索 |
| users | role_type | 権限でユーザー検索 |
| events | visibility_type + owner_department_id | 公開範囲と部署の組み合わせ検索 |
| events | start_date + end_date | 期間検索 |
| events | created_by | 作成者検索 |
| event_participants | user_id | ユーザーの参加予定検索 |
| event_participants | event_id | 予定の参加者検索 |
| calendar_event_shares | calendar_id | カレンダーの共有予定検索 |
| calendar_event_shares | event_id | 予定の共有先検索 |
| shared_notes | visibility_type + owner_department_id | メモの検索 |
| surveys | visibility_type + owner_department_id | アンケート検索 |
| trash_items | owner_department_id | ゴミ箱検索 |
| audit_logs | action | ログ種別検索 |
| audit_logs | created_at | 日付検索 |
| departments | is_active | 有効部署検索 |

**具体例**:
```sql
-- インデックスなし: 全データをスキャン（遅い）
SELECT * FROM events WHERE visibility_type = 'department' AND owner_department_id = 1;
-- 実行時間: 500ms（データ1万件の場合）

-- インデックスあり: 目次から直接該当データへ（速い）
CREATE INDEX idx_events_visibility_dept ON events(visibility_type, owner_department_id);
-- 実行時間: 5ms（100倍高速化）
```

**対策**:
```sql
-- 必須インデックス（15個）
CREATE INDEX idx_users_department ON users(department_id);
CREATE INDEX idx_users_role_type ON users(role_type);
CREATE INDEX idx_events_visibility_dept ON events(visibility_type, owner_department_id);
CREATE INDEX idx_events_dates ON events(start_date, end_date);
CREATE INDEX idx_events_created_by ON events(created_by);
CREATE INDEX idx_participants_user ON event_participants(user_id);
CREATE INDEX idx_participants_event ON event_participants(event_id);
CREATE INDEX idx_shares_calendar ON calendar_event_shares(calendar_id);
CREATE INDEX idx_shares_event ON calendar_event_shares(event_id);
CREATE INDEX idx_notes_visibility_dept ON shared_notes(visibility_type, owner_department_id);
CREATE INDEX idx_surveys_visibility_dept ON surveys(visibility_type, owner_department_id);
CREATE INDEX idx_trash_department ON trash_items(owner_department_id);
CREATE INDEX idx_audit_action ON audit_logs(action);
CREATE INDEX idx_audit_created_at ON audit_logs(created_at);
CREATE INDEX idx_departments_active ON departments(is_active);
```

---

#### 3. 共有機能の複雑性

**リスク内容**: 共有先での編集権限が不明確、どこに共有したか分からない

**UI設計案**:

```vue
<!-- 予定詳細画面 -->
<template>
  <div class="space-y-4">
    <!-- 共有状態の明示 -->
    <Alert v-if="event.is_shared" variant="info">
      <Share2 class="h-4 w-4" />
      <AlertDescription>
        この予定は{{ event.shares.length }}個のカレンダーに共有されています
      </AlertDescription>
    </Alert>
    
    <!-- 共有先一覧 -->
    <Card>
      <CardHeader>
        <CardTitle class="flex items-center justify-between">
          <span>共有先カレンダー</span>
          <Button size="sm" @click="showShareDialog = true">
            <Plus class="h-4 w-4 mr-2" />
            共有先を追加
          </Button>
        </CardTitle>
      </CardHeader>
      <CardContent>
        <div class="space-y-2">
          <!-- 元のカレンダー -->
          <div class="flex items-center gap-2 p-2 bg-blue-50 rounded">
            <Calendar class="h-4 w-4 text-blue-600" />
            <div class="flex-1">
              <div class="font-medium">{{ event.calendar.name }}</div>
              <div class="text-xs text-gray-500">元のカレンダー</div>
            </div>
            <Badge>編集可能</Badge>
          </div>
          
          <!-- 共有先 -->
          <div v-for="share in event.shares" :key="share.id"
               class="flex items-center gap-2 p-2 border rounded">
            <Share2 class="h-4 w-4 text-gray-400" />
            <div class="flex-1">
              <div class="font-medium">{{ share.calendar.name }}</div>
              <div class="text-xs text-gray-500">
                {{ share.shared_by.name }}が{{ formatDate(share.shared_at) }}に共有
              </div>
            </div>
            <Badge variant="outline">閲覧のみ</Badge>
            <Button variant="ghost" size="sm" @click="unshare(share.id)">
              <X class="h-4 w-4" />
            </Button>
          </div>
        </div>
      </CardContent>
    </Card>
    
    <!-- 編集権限の説明 -->
    <Alert>
      <Info class="h-4 w-4" />
      <AlertDescription>
        <ul class="list-disc list-inside text-sm space-y-1">
          <li>元のカレンダーでは編集・削除が可能です</li>
          <li>共有先のカレンダーでは閲覧のみ可能です</li>
          <li>参加者として登録されている場合は、どこからでも編集可能です</li>
        </ul>
      </AlertDescription>
    </Alert>
  </div>
</template>
```

---

## 運用的リスクと対策

### 🔴 高リスク

#### 1. 部署管理者不在

**リスク内容**: 部署に管理者が設定されず、部署カレンダーが管理不能

**運用方針（明文化）**:

```
【部署管理者の必須設定ルール】

1. 部署作成時
   - 部署作成と同時に管理者アカウントを作成
   - 管理者が設定されるまで部署は有効化されない

2. 管理者退職時
   ステップ1: 次期管理者を選定
   ステップ2: 次期管理者を「部署管理者」に昇格
   ステップ3: 退職予定者を「一般メンバー」に降格
   ステップ4: 退職日に退職予定者を無効化

3. 管理者不在の検知
   - 毎月1日に自動チェック
   - 管理者不在の部署があれば全社管理者に通知
```

**実装**:

```php
// 部署作成時のバリデーション
public function store(Request $request)
{
    $validated = $request->validate([
        'name' => 'required|unique:departments',
        'admin_user_id' => 'required|exists:users,id',
    ]);
    
    DB::transaction(function() use ($validated) {
        $department = Department::create(['name' => $validated['name']]);
        
        User::find($validated['admin_user_id'])->update([
            'department_id' => $department->id,
            'role_type' => 'department_admin',
        ]);
    });
}

// 管理者不在チェック（月次バッチ）
public function checkMissingAdmins()
{
    $departmentsWithoutAdmin = Department::where('is_active', true)
        ->whereDoesntHave('users', function($q) {
            $q->where('role_type', 'department_admin')
              ->where('is_active', true);
        })
        ->get();
    
    if ($departmentsWithoutAdmin->isNotEmpty()) {
        Notification::send(
            User::where('role_type', 'company_admin')->get(),
            new MissingDepartmentAdmins($departmentsWithoutAdmin)
        );
    }
}
```

---

#### 2. 全社カレンダー乱用

**リスク内容**: 不適切な内容（部署の会議など）が全社カレンダーに申請される

**対策**: ガイドライン表示（先方確認必須）

```vue
<template>
  <Dialog v-model:open="showRequestDialog">
    <DialogContent class="max-w-2xl">
      <DialogHeader>
        <DialogTitle>全社カレンダーへの投稿申請</DialogTitle>
      </DialogHeader>
      
      <!-- ガイドライン（先方仕様に合わせる） -->
      <Alert variant="warning">
        <AlertCircle class="h-4 w-4" />
        <AlertTitle>全社カレンダー投稿ガイドライン</AlertTitle>
        <AlertDescription>
          <div class="space-y-2 mt-2">
            <p class="font-medium">以下の内容のみ投稿してください：</p>
            <ul class="list-disc list-inside space-y-1 text-sm">
              <li>【要確認】全社行事（例：○○）</li>
              <li>【要確認】会社休日（例：○○）</li>
              <li>【要確認】全体連絡（例：○○）</li>
            </ul>
            <p class="text-sm text-red-600 mt-2">
              ※ 部署の会議や業務予定は部署カレンダーに登録してください
            </p>
          </div>
        </AlertDescription>
      </Alert>
      
      <!-- 申請フォーム -->
      <div class="space-y-4">
        <!-- ... -->
      </div>
    </DialogContent>
  </Dialog>
</template>
```

---

## 運用面の確認事項

### 📋 先方への確認が必須

| # | 項目 | 確認内容 | 影響範囲 |
|---|------|---------|---------|
| 1 | 部署統廃合の頻度 | 年に何回程度発生するか？ | 自動移行機能の優先度 |
| 2 | 退職者処理タイミング | 退職日当日？事前処理？ | 予定の所有権移譲タイミング |
| 3 | 全社カレンダー承認期限 | 何日以内に承認が必要？ | リマインダー設定 |
| 4 | 共有予定の編集権限 | 共有先でも編集可能？閲覧のみ？ | 権限設計 |
| 5 | 全社カレンダーガイドライン | どのような内容を投稿可能とするか？ | UI表示内容 |
| 6 | 部署管理者の選定基準 | どのような基準で選定するか？ | 運用ルール |
| 7 | 部署異動の頻度 | 年に何回程度発生するか？ | 異動処理の優先度 |
| 8 | 全社カレンダーの運用責任者 | 誰が承認を行うか？ | 通知先の設定 |

---

## 技術面の確認事項

### 🔧 先方への確認が必須

| # | 項目 | 確認内容 | 影響範囲 |
|---|------|---------|---------|
| 1 | 監査ログ保持期間 | 何ヶ月保持するか？ | ストレージ容量 |
| 2 | バックアップ頻度 | 毎日？週1回？ | 復旧可能な範囲 |
| 3 | バックアップ保存先 | XServerのみ？クラウドも？ | コスト・安全性 |
| 4 | テスト環境の用意 | 本番と同じ環境を用意できるか？ | 移行テストの精度 |
| 5 | メンテナンス時間帯 | いつメンテナンスを実施するか？ | ダウンタイムの影響 |
| 6 | データ移行の実施日 | いつ実施するか？ | スケジュール調整 |
| 7 | ロールバック判断基準 | どの時点でロールバックするか？ | 障害対応 |
| 8 | パフォーマンス目標 | カレンダー表示は何秒以内？ | 最適化の目標値 |

---

## バックアップ戦略

### 比較表

| 方式 | 容量 | 月額コスト | 年間コスト | メリット | デメリット |
|------|------|----------|----------|---------|---------|
| **XServer標準** | 無制限 | 無料 | 無料 | 追加費用なし | 7日分のみ |
| **AWS S3** | 10GB | 約30円 | 約360円 | 長期保存可能 | 設定が必要 |
| **Google Cloud Storage** | 10GB | 約26円 | 約312円 | 安価 | 設定が必要 |
| **Backblaze B2** | 10GB | 約6円 | 約72円 | 最安 | 知名度低い |

### 推奨構成

```
【二重バックアップ体制】

1. XServer標準バックアップ（無料）
   - 過去7日分を自動保存
   - 短期復旧用

2. AWS S3（月額30円）
   - 過去3ヶ月分を保存
   - 長期保存・災害対策用
   - 自動アップロード（毎日深夜2時）

合計コスト: 年間360円
```

### 実装

```bash
# 毎日深夜2時に実行（cron）
0 2 * * * /path/to/backup-to-s3.sh

# backup-to-s3.sh
#!/bin/bash
DATE=$(date +%Y%m%d)
BACKUP_FILE="db_backup_$DATE.sql.gz"

# バックアップ作成
mysqldump -u user -p database | gzip > /tmp/$BACKUP_FILE

# S3にアップロード
aws s3 cp /tmp/$BACKUP_FILE s3://your-bucket/backups/$BACKUP_FILE

# 3ヶ月以上前のファイルを削除
aws s3 ls s3://your-bucket/backups/ | while read -r line; do
    createDate=$(echo $line | awk '{print $1" "$2}')
    createDate=$(date -d "$createDate" +%s)
    olderThan=$(date -d "90 days ago" +%s)
    if [[ $createDate -lt $olderThan ]]; then
        fileName=$(echo $line | awk '{print $4}')
        aws s3 rm s3://your-bucket/backups/$fileName
    fi
done

# ローカルファイル削除
rm /tmp/$BACKUP_FILE
```

---

## 開発フェーズ

### フェーズ1: 基盤整備（1.5ヶ月）
- 部署マスタ作成
- ユーザー・カレンダーの部署対応
- 既存データ移行

### フェーズ2: カレンダー拡張（2.5ヶ月）
- 承認フロー実装（2週間）
- 共有機能実装（2週間）
- 動的展開実装（1週間）
- 競合処理実装（1週間）
- 監査ログ実装（3日）

### フェーズ3: メモ・アンケート（1.5ヶ月）
- 部署対応
- 公開範囲制御

### フェーズ4: 最適化（1ヶ月）
- パフォーマンス改善
- テスト・バグ修正

**合計: 6.5ヶ月**

---

## 工数見積もり

| 項目 | 工数 | 備考 |
|------|------|------|
| 基盤整備 | 1.5ヶ月 | |
| 承認フロー | 2週間 | 新規実装 |
| 共有機能 | 2週間 | 新規実装 |
| 動的展開 | 1週間 | 既存コード調整 |
| 競合処理 | 1週間 | 新規実装 |
| 監査ログ | 3日 | 最小限実装 |
| メモ・アンケート | 1.5ヶ月 | |
| 最適化 | 1ヶ月 | |
| **合計** | **6.5ヶ月** | |

---

## まとめ

### ✅ 確定事項
- 全社カレンダー承認フロー: 実装
- データ共有方式: 実装（共有先一覧UI含む）
- 繰り返し予定動的展開: 実装
- 同時編集競合処理: 実装
- 監査ログ: 共有予定のみ記録
- バックアップ: XServer + AWS S3（年間360円）

### 📋 先方確認必須（16項目）
- 運用面: 8項目
- 技術面: 8項目

### 🎯 成功のカギ
1. 先方確認事項の早期回答
2. 段階的リリース
3. 十分なテスト
4. 二重バックアップ体制

---

**作成日**: 2025年1月  
**バージョン**: 3.0（最終版）  
**ステータス**: 先方確認待ち
