# 部署拡張要件定義書 v2.0

## 📋 目次

### 1. 基本方針
- [概要](#概要)
- [確定事項](#確定事項)
- [実装方針](#実装方針)

### 2. 主要機能
- [全社カレンダー承認フロー](#全社カレンダー承認フロー)
- [データ共有方式](#データ共有方式)
- [繰り返し予定の動的展開](#繰り返し予定の動的展開)
- [同時編集競合処理](#同時編集競合処理)
- [監査ログ](#監査ログ)

### 3. データベース設計
- [テーブル構造](#テーブル構造)
- [インデックス戦略](#インデックス戦略)

### 4. 実装計画
- [開発フェーズ](#開発フェーズ)
- [工数見積もり](#工数見積もり)

### 5. 確認事項・懸念点
- [技術的課題](#技術的課題)
- [運用上の懸念](#運用上の懸念)
- [追加検討事項](#追加検討事項)

---

## 概要

### 背景
総務部での単一部署運用から、全社展開（50名規模）への拡張。

### 目的
- 部署ごとのカレンダー・メモ・アンケート管理
- 全社公開と部署限定の使い分け
- 部署間のデータ共有とプライバシー保護

---

## 確定事項

### ✅ 採用する仕様

| 項目 | 方針 | 理由 |
|------|------|------|
| **全社カレンダー投稿** | 承認フロー必須 | 品質管理・統制 |
| **データ共有** | 共有方式（同一データ） | 整合性保証 |
| **繰り返し予定** | 動的展開 | DB肥大化防止 |
| **同時編集競合** | 楽観的ロック | データ損失防止 |
| **監査ログ** | 共有予定のみ記録 | 最小限の追跡 |

### ❌ 採用しない仕様

| 項目 | 理由 |
|------|------|
| 複数部署管理者 | 50名規模では不要 |
| 部署階層構造 | 現時点で不要 |
| PWA化 | レスポンシブで十分 |
| 外部カレンダー連携 | 要望なし |

---

## 実装方針

### 1. 全社カレンダー承認フロー

#### データベース

```sql
CREATE TABLE company_event_requests (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    event_data JSON NOT NULL COMMENT '申請内容',
    requested_by BIGINT NOT NULL,
    requested_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending',
    reviewed_by BIGINT NULL,
    reviewed_at TIMESTAMP NULL,
    review_comment TEXT NULL,
    FOREIGN KEY (requested_by) REFERENCES users(id),
    FOREIGN KEY (reviewed_by) REFERENCES users(id),
    INDEX idx_status (status),
    INDEX idx_requested_by (requested_by)
);
```

#### フロー

```
部署管理者が申請
  ↓
全社管理者に通知
  ↓
承認 or 却下
  ↓
承認 → 全社カレンダーに作成
却下 → 申請者に通知
```

#### 実装コード（最小限）

```php
// 申請
public function requestCompanyEvent(Request $request)
{
    CompanyEventRequest::create([
        'event_data' => json_encode($request->validated()),
        'requested_by' => auth()->id(),
    ]);
    
    // 全社管理者に通知
    Notification::send(
        User::where('role_type', 'company_admin')->get(),
        new CompanyEventRequested($request)
    );
}

// 承認
public function approveRequest(CompanyEventRequest $request)
{
    $eventData = json_decode($request->event_data, true);
    
    Event::create([
        ...$eventData,
        'calendar_id' => $this->getCompanyCalendar()->id,
    ]);
    
    $request->update([
        'status' => 'approved',
        'reviewed_by' => auth()->id(),
        'reviewed_at' => now(),
    ]);
}
```

---

### 2. データ共有方式

#### データベース

```sql
CREATE TABLE calendar_event_shares (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    calendar_id BIGINT NOT NULL,
    event_id BIGINT NOT NULL,
    shared_by BIGINT NOT NULL,
    shared_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY unique_share (calendar_id, event_id),
    FOREIGN KEY (calendar_id) REFERENCES calendars(calendar_id) ON DELETE CASCADE,
    FOREIGN KEY (event_id) REFERENCES events(event_id) ON DELETE CASCADE,
    FOREIGN KEY (shared_by) REFERENCES users(id),
    INDEX idx_calendar (calendar_id),
    INDEX idx_event (event_id)
);
```

#### 動作

- 1つの予定が複数カレンダーに表示
- どこから編集しても同じデータが更新
- 共有解除で非表示

#### 実装コード

```php
// 共有
public function shareToCalendar(Event $event, int $calendarId)
{
    CalendarEventShare::create([
        'calendar_id' => $calendarId,
        'event_id' => $event->event_id,
        'shared_by' => auth()->id(),
    ]);
    
    // 監査ログ記録
    AuditLog::create([
        'action' => 'event_shared',
        'event_id' => $event->event_id,
        'calendar_id' => $calendarId,
        'user_id' => auth()->id(),
    ]);
}

// 表示時
public function getEventsForCalendar(int $calendarId)
{
    return Event::where('calendar_id', $calendarId)
        ->orWhereHas('shares', fn($q) => $q->where('calendar_id', $calendarId))
        ->get();
}
```

---

### 3. 繰り返し予定の動的展開

#### 実装コード

```php
public function getExpandedEvents(string $start, string $end)
{
    $events = Event::with('recurrence')->get();
    $expanded = [];
    
    foreach ($events as $event) {
        if ($event->recurrence) {
            // 表示範囲のみ展開
            $expanded = array_merge(
                $expanded,
                $this->expandRecurrence($event, $start, $end)
            );
        } else {
            if ($event->start_date <= $end && $event->end_date >= $start) {
                $expanded[] = $event;
            }
        }
    }
    
    return $expanded;
}
```

#### メリット

- DBに1件のみ保存
- 任意期間を表示可能
- パフォーマンス向上

---

### 4. 同時編集競合処理

#### データベース

```sql
ALTER TABLE events ADD COLUMN version INT DEFAULT 0 AFTER created_by;
ALTER TABLE shared_notes ADD COLUMN version INT DEFAULT 0 AFTER author_id;
ALTER TABLE surveys ADD COLUMN version INT DEFAULT 0 AFTER created_by;
```

#### フロー

```
ユーザーA: 予定を開く (version=1)
ユーザーB: 予定を開く (version=1)
  ↓
ユーザーA: 保存 → 成功 (version=2)
  ↓
ユーザーB: 保存 → 競合検出！
  ↓
ダイアログ表示:
  1. 再読み込み（変更破棄）
  2. 強制保存（上書き）
  3. 手動マージ
```

#### 実装コード

```php
public function update(Request $request, Event $event)
{
    if ($event->version !== $request->input('version')) {
        return response()->json([
            'conflict' => true,
            'current_data' => $event->fresh(),
            'your_changes' => $request->validated(),
        ], 409);
    }
    
    $event->update([
        ...$request->validated(),
        'version' => $event->version + 1,
    ]);
}
```

---

### 5. 監査ログ

#### 記録対象（最小限）

- ✅ 他部署への予定共有
- ✅ 全社カレンダー承認/却下
- ✅ 強制保存（競合時）
- ❌ 通常の作成・編集・削除（記録しない）

#### データベース

```sql
CREATE TABLE audit_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    action VARCHAR(50) NOT NULL,
    user_id BIGINT NOT NULL,
    event_id BIGINT NULL,
    calendar_id BIGINT NULL,
    details JSON NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_action (action),
    INDEX idx_event (event_id),
    INDEX idx_created_at (created_at)
);
```

#### 実装コード

```php
// 共有時のみ記録
public function shareToCalendar(Event $event, int $calendarId)
{
    CalendarEventShare::create([...]);
    
    AuditLog::create([
        'action' => 'event_shared',
        'user_id' => auth()->id(),
        'event_id' => $event->event_id,
        'calendar_id' => $calendarId,
        'details' => json_encode([
            'event_title' => $event->title,
            'shared_to' => Calendar::find($calendarId)->calendar_name,
        ]),
    ]);
}
```

---

## テーブル構造

### 新規追加テーブル（3個）

1. `company_event_requests` - 全社カレンダー承認
2. `calendar_event_shares` - 予定共有
3. `audit_logs` - 監査ログ

### 変更テーブル（8個）

1. `departments` - 新規作成
2. `users` - department_id, role_type追加
3. `calendars` - owner_type, owner_id追加
4. `events` - visibility_type, owner_department_id, version追加
5. `shared_notes` - visibility_type, owner_department_id, version追加
6. `surveys` - visibility_type, owner_department_id, version追加
7. `trash_items` - owner_department_id, visibility_type追加
8. `user_preferences` - show_company_calendar_in_trash追加

---

## インデックス戦略

```sql
-- 部署関連
CREATE INDEX idx_users_department ON users(department_id);
CREATE INDEX idx_users_role_type ON users(role_type);
CREATE INDEX idx_departments_active ON departments(is_active);

-- カレンダー関連
CREATE INDEX idx_calendars_owner ON calendars(owner_type, owner_id);
CREATE INDEX idx_events_visibility_dept ON events(visibility_type, owner_department_id);
CREATE INDEX idx_events_dates ON events(start_date, end_date);

-- 共有関連
CREATE INDEX idx_shares_calendar ON calendar_event_shares(calendar_id);
CREATE INDEX idx_shares_event ON calendar_event_shares(event_id);

-- 監査ログ
CREATE INDEX idx_audit_action ON audit_logs(action);
CREATE INDEX idx_audit_created_at ON audit_logs(created_at);
```

---

## 開発フェーズ

### フェーズ1: 基盤整備（1.5ヶ月）

- 部署マスタ作成
- ユーザー・カレンダーの部署対応
- 既存データ移行

### フェーズ2: カレンダー拡張（2.5ヶ月）

- 公開範囲制御
- 承認フロー実装
- 共有機能実装
- 動的展開実装
- 同時編集競合処理

### フェーズ3: メモ・アンケート（1.5ヶ月）

- 部署対応
- 公開範囲制御

### フェーズ4: 最適化（1ヶ月）

- パフォーマンス改善
- テスト・バグ修正

**合計: 6.5ヶ月**

---

## 工数見積もり

| 項目 | 工数 |
|------|------|
| 基盤整備 | 1.5ヶ月 |
| 承認フロー | 2週間 |
| 共有機能 | 2週間 |
| 動的展開 | 1週間 |
| 競合処理 | 1週間 |
| 監査ログ | 3日 |
| メモ・アンケート | 1.5ヶ月 |
| 最適化 | 1ヶ月 |
| **合計** | **6.5ヶ月** |

---

## 技術的課題

### 🔴 高リスク

#### 1. データ移行の失敗

**リスク**: 既存データ（数百件）の移行時にエラー

**影響**: ダウンタイム延長、データ損失

**対策**:
- 本番データの完全バックアップ
- テスト環境で3回以上検証
- ロールバック手順の準備
- 段階的移行（部署ごと）

#### 2. パフォーマンス劣化

**リスク**: 複雑なクエリで表示遅延

**影響**: ユーザー体験低下

**対策**:
- 15個以上のインデックス追加
- Eager Loading徹底
- キャッシュ戦略（10分間）
- クエリ実行計画の確認

#### 3. 共有機能の複雑性

**リスク**: 共有先での編集権限が不明確

**影響**: 混乱、誤操作

**対策**:
- 明確なUI表示（「共有された予定」バッジ）
- ヘルプテキスト充実
- 編集権限の明示

### 🟡 中リスク

#### 4. 承認フローの遅延

**リスク**: 全社管理者が承認を忘れる

**影響**: 全社カレンダーへの投稿遅延

**対策**:
- リマインダー通知（24時間後）
- 承認待ち一覧画面
- 期限設定（3日以内）

#### 5. 動的展開のパフォーマンス

**リスク**: 繰り返し予定が多いと展開に時間がかかる

**影響**: カレンダー表示遅延

**対策**:
- 表示範囲を1ヶ月に制限
- バックグラウンド処理
- キャッシュ活用

#### 6. 同時編集競合の頻度

**リスク**: 競合が頻発してユーザーが不満

**影響**: 保存失敗の増加

**対策**:
- 編集中表示機能（WebSocket）
- 自動保存（下書き）
- 差分マージUI

---

## 運用上の懸念

### 🔴 高リスク

#### 1. 部署管理者の不在

**リスク**: 部署に管理者が設定されない

**影響**: 部署カレンダーが管理不能

**対策**:
- 部署作成時に管理者必須化
- バリデーションで強制
- 定期チェック（月1回）

#### 2. 全社カレンダーの乱用

**リスク**: 不適切な内容が申請される

**影響**: 承認作業の増加

**対策**:
- 申請時のガイドライン表示
- 却下理由のテンプレート
- 申請履歴の確認

#### 3. 共有予定の管理不全

**リスク**: どこに共有したか分からなくなる

**影響**: データの不整合

**対策**:
- 共有先一覧の表示
- 共有解除機能
- 監査ログで追跡

### 🟡 中リスク

#### 4. ユーザーの混乱

**リスク**: カレンダー選択、公開範囲で混乱

**影響**: 誤設定、問い合わせ増加

**対策**:
- スマートデフォルト
- ヘルプテキスト
- 段階的ロールアウト

#### 5. 監査ログの肥大化

**リスク**: ログが増えすぎる

**影響**: ストレージ圧迫

**対策**:
- 最小限の記録（共有のみ）
- 3ヶ月で自動削除
- 定期的なアーカイブ

---

## 追加検討事項

### ⚠️ 要確認

#### 1. 部署統廃合の頻度

**質問**: 年に何回程度発生するか？

**影響**: 自動移行機能の優先度

**推奨**: 年1回以下なら手動でも可

#### 2. 退職者の処理タイミング

**質問**: 退職日当日に処理？事前処理？

**影響**: 予定の所有権移譲タイミング

**推奨**: 退職日の1週間前に確認ダイアログ

#### 3. 全社カレンダーの承認期限

**質問**: 何日以内に承認が必要？

**影響**: リマインダーの設定

**推奨**: 3営業日以内

#### 4. 共有予定の編集権限

**質問**: 共有先でも編集可能？閲覧のみ？

**影響**: 権限設計

**推奨**: 参加者なら編集可能

#### 5. 監査ログの保持期間

**質問**: 何ヶ月保持するか？

**影響**: ストレージ容量

**推奨**: 3ヶ月（法的要件に応じて調整）

#### 6. バックアップの頻度

**質問**: 毎日？週1回？

**影響**: 復旧可能な範囲

**推奨**: 毎日深夜2時（自動）

#### 7. テスト環境の用意

**質問**: 本番と同じ環境を用意できるか？

**影響**: 移行テストの精度

**推奨**: 必須（XServerで別環境）

#### 8. ユーザートレーニング

**質問**: 新機能の説明会を実施するか？

**影響**: 導入のスムーズさ

**推奨**: 部署管理者向けに実施

---

## まとめ

### ✅ 確定事項

- 全社カレンダー承認フロー: 実装
- データ共有方式: 実装
- 繰り返し予定動的展開: 実装
- 同時編集競合処理: 実装
- 監査ログ: 共有予定のみ記録

### 📊 開発規模

- 期間: 6.5ヶ月
- 新規テーブル: 3個
- 変更テーブル: 8個
- インデックス: 15個以上

### ⚠️ 主要リスク

1. データ移行の失敗
2. パフォーマンス劣化
3. 部署管理者の不在
4. 共有機能の複雑性
5. 承認フローの遅延

### 🎯 成功のカギ

1. 段階的リリース
2. 十分なテスト
3. ユーザー教育
4. フィードバック収集

---

**作成日**: 2025年1月  
**バージョン**: 2.0  
**ステータス**: 方針確定・実装準備完了
