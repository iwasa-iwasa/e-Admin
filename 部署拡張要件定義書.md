# ä»–éƒ¨ç½²ã§ã‚‚é‹ç”¨é–‹å§‹ã™ã‚‹å ´åˆã®æ‹¡å¼µæ€§ã«ã¤ã„ã¦

## ç›®æ¬¡

### ğŸ“‹ åŸºæœ¬è¨­è¨ˆ
1. [æ¦‚è¦](#æ¦‚è¦)
2. [ç¾çŠ¶ã®èª²é¡Œ](#ç¾çŠ¶ã®èª²é¡Œ)
3. [ç›®æ¨™ã¨ã™ã‚‹çŠ¶æ…‹](#ç›®æ¨™ã¨ã™ã‚‹çŠ¶æ…‹)

### ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ
4. [ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å¤‰æ›´](#ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å¤‰æ›´)
5. [æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œæˆ¦ç•¥](#æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œæˆ¦ç•¥)

### ğŸ” æ¨©é™ãƒ»é‹ç”¨è¨­è¨ˆ
6. [æ¨©é™ç®¡ç†ã®è¨­è¨ˆ](#æ¨©é™ç®¡ç†ã®è¨­è¨ˆ)
7. [éƒ¨ç½²ç•°å‹•æ™‚ã®å‡¦ç†](#éƒ¨ç½²ç•°å‹•æ™‚ã®å‡¦ç†)
8. [é€€è·è€…ãƒ‡ãƒ¼ã‚¿å‡¦ç†](#é€€è·è€…ã®å‚åŠ è€…é™¤å¤–ã®è©³ç´°ä»•æ§˜)
9. [éƒ¨ç½²çµ±å»ƒåˆ](#éƒ¨ç½²çµ±å»ƒåˆã®è©³ç´°ä»•æ§˜)

### ğŸ¨ æ©Ÿèƒ½è¨­è¨ˆ
10. [ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»ãƒ¡ãƒ¢ãƒ»ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯](#ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ¡ãƒ¢ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯)
11. [ã‚´ãƒŸç®±ã®éƒ¨ç½²ç®¡ç†](#ã‚´ãƒŸç®±ã®éƒ¨ç½²ç®¡ç†)
12. [UI/UXè¨­è¨ˆ](#uiuxè¨­è¨ˆ)

### âš¡ æŠ€è¡“è¨­è¨ˆ
13. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¯¾ç­–](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¯¾ç­–)
14. [åŒæ™‚ç·¨é›†ç«¶åˆå‡¦ç†](#æ¥½è¦³çš„ãƒ­ãƒƒã‚¯åŒæ™‚ç·¨é›†ç«¶åˆã®è©³ç´°ãƒ•ãƒ­ãƒ¼)

### ğŸ“Š LINE WORKSæ¯”è¼ƒ
15. [LINE WORKSã¨ã®ä»•æ§˜å·®ç•°](#line-worksã¨ã®ä»•æ§˜å·®ç•°ã¾ã¨ã‚)
16. [å…¨ç¢ºèªäº‹é …ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ](#å…¨ç¢ºèªäº‹é …ã®æœ€çµ‚ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ)

### ğŸš€ å®Ÿè£…è¨ˆç”»
17. [å®Ÿè£…ã®å„ªå…ˆé †ä½](#å®Ÿè£…ã®å„ªå…ˆé †ä½)
18. [é–‹ç™ºæœŸé–“è¦‹ç©ã‚‚ã‚Š](#é–‹ç™ºæœŸé–“ã®å†è¦‹ç©ã‚‚ã‚Š)
19. [æ‡¸å¿µäº‹é …ã¨å¯¾å¿œç­–](#æ‡¸å¿µäº‹é …ã¨å¯¾å¿œç­–)

---

## æ¦‚è¦

### èƒŒæ™¯
ç¾åœ¨ã€æœ¬ã‚¢ãƒ—ãƒªã¯ç·å‹™éƒ¨ã§ã®å˜ä¸€éƒ¨ç½²é‹ç”¨ã‚’å‰æã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚å…¨ç¤¾å±•é–‹ã‚’ç›®æŒ‡ã™ã«ã‚ãŸã‚Šã€è¤‡æ•°éƒ¨ç½²ã§ã®é‹ç”¨ã«å¯¾å¿œã™ã‚‹ãŸã‚ã®æ‹¡å¼µãŒå¿…è¦ã§ã™ã€‚

### ç›®çš„
- éƒ¨ç½²ã”ã¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»å…±æœ‰ãƒ¡ãƒ¢ãƒ»ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®ç®¡ç†
- å…¨ç¤¾å…¬é–‹ã¨éƒ¨ç½²é™å®šå…¬é–‹ã®ä½¿ã„åˆ†ã‘
- éƒ¨ç½²ç®¡ç†è€…ã«ã‚ˆã‚‹è‡ªéƒ¨ç½²ã®ç®¡ç†
- éƒ¨ç½²é–“ã§ã®ãƒ‡ãƒ¼ã‚¿å…±æœ‰ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã®ä¸¡ç«‹

### å‚è€ƒä»•æ§˜
LINE WORKSã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»ãƒ¡ãƒ¢æ©Ÿèƒ½ã‚’å‚è€ƒã«ã—ã¤ã¤ã€æœ¬ã‚¢ãƒ—ãƒªã®ç‰¹æ€§ã«åˆã‚ã›ãŸè¨­è¨ˆã‚’è¡Œã„ã¾ã™ã€‚

---

## ç¾çŠ¶ã®èª²é¡Œ

### 1. éƒ¨ç½²ç®¡ç†ã®ä¸åœ¨
- `users.department`ã¯æ–‡å­—åˆ—å‹ã§ã€ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†ã•ã‚Œã¦ã„ãªã„
- è¡¨è¨˜ã‚†ã‚Œï¼ˆã€Œç·å‹™éƒ¨ã€ã€Œç·å‹™èª²ã€ï¼‰ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§
- éƒ¨ç½²ã®çµ±å»ƒåˆã‚„éšå±¤æ§‹é€ ã«å¯¾å¿œã§ããªã„

### 2. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ‰€æœ‰è€…æ¦‚å¿µã®æ¬ å¦‚
- `calendars.owner_id`ãŒå‰Šé™¤ã•ã‚Œã€å…¨å“¡ãŒåŒã˜ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å…±æœ‰
- éƒ¨ç½²ã”ã¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨ã„ã†æ¦‚å¿µãŒãªã„
- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ç®¡ç†è²¬ä»»ãŒä¸æ˜ç¢º

### 3. å…¬é–‹ç¯„å›²åˆ¶å¾¡ã®ä¸åœ¨
- ã‚¤ãƒ™ãƒ³ãƒˆãƒ»ãƒ¡ãƒ¢ãƒ»ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã«å…¬é–‹ç¯„å›²ã®æ¦‚å¿µãŒãªã„
- å‚åŠ è€…ãƒ™ãƒ¼ã‚¹ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®ã¿
- ã€Œå…¨ç¤¾å…¬é–‹ã€ã€Œéƒ¨ç½²é™å®šã€ã®åŒºåˆ¥ãŒã§ããªã„

### 4. æ¨©é™ç®¡ç†ã®ä¸è¶³
- `users.role`ã¯æ–‡å­—åˆ—å‹ã§ã€è©³ç´°ãªæ¨©é™åˆ¶å¾¡ãŒã§ããªã„
- éƒ¨ç½²ç®¡ç†è€…ã¨å…¨ç¤¾ç®¡ç†è€…ã®åŒºåˆ¥ãŒãªã„
- ç·¨é›†æ¨©é™ãŒä½œæˆè€…ã¨å‚åŠ è€…ã®ã¿

### 5. ã‚´ãƒŸç®±ã®éƒ¨ç½²ç®¡ç†ä¸åœ¨
- `trash_items`ã«éƒ¨ç½²æƒ…å ±ãŒãªã„
- å‰Šé™¤æ¨©é™ã®éƒ¨ç½²å˜ä½ã§ã®åˆ¶å¾¡ãŒã§ããªã„

---

## ç›®æ¨™ã¨ã™ã‚‹çŠ¶æ…‹

### ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ§‹æˆ
```
å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ (owner_type='company')
â”œâ”€ å…¨ä½“é€£çµ¡ã€ä¼šç¤¾è¡Œäº‹ã€ä¼‘æ—¥
â””â”€ å…¨å“¡ãŒé–²è¦§å¯èƒ½ã€å…¨ç¤¾ç®¡ç†è€…ã®ã¿ç·¨é›†å¯èƒ½

ç·å‹™éƒ¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ (owner_type='department', owner_id=1)
â”œâ”€ ç·å‹™éƒ¨ã®ä¼šè­°ã€æ¥­å‹™äºˆå®š
â”œâ”€ ç·å‹™éƒ¨ãƒ¡ãƒ³ãƒãƒ¼ãŒç·¨é›†å¯èƒ½
â””â”€ ä»–éƒ¨ç½²ã‹ã‚‰ã‚‚é–²è¦§å¯èƒ½ï¼ˆç©ºãæ™‚é–“ç¢ºèªç”¨ï¼‰

å–¶æ¥­éƒ¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ (owner_type='department', owner_id=2)
â”œâ”€ å–¶æ¥­éƒ¨ã®ä¼šè­°ã€æ¥­å‹™äºˆå®š
â”œâ”€ å–¶æ¥­éƒ¨ãƒ¡ãƒ³ãƒãƒ¼ãŒç·¨é›†å¯èƒ½
â””â”€ ä»–éƒ¨ç½²ã‹ã‚‰ã‚‚é–²è¦§å¯èƒ½
```

### å…¬é–‹ç¯„å›²ã®ç¨®é¡
1. **publicï¼ˆå…¨ç¤¾å…¬é–‹ï¼‰**: å…¨å“¡ãŒé–²è¦§å¯èƒ½
2. **departmentï¼ˆéƒ¨ç½²é™å®šï¼‰**: åŒã˜éƒ¨ç½²ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿é–²è¦§å¯èƒ½
3. **customï¼ˆã‚«ã‚¹ã‚¿ãƒ ï¼‰**: å‚åŠ è€…ã¨ã—ã¦ç™»éŒ²ã•ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼ã®ã¿é–²è¦§å¯èƒ½
4. **privateï¼ˆéå…¬é–‹ï¼‰**: ä½œæˆè€…ã®ã¿é–²è¦§å¯èƒ½ã€ä»–ã®äººã«ã¯ã€Œéè¡¨ç¤ºã€ã¨è¡¨ç¤º

### æ¨©é™ã®ç¨®é¡
1. **ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼ (member)**
   - è‡ªéƒ¨ç½²ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–²è¦§ãƒ»ç·¨é›†
   - å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–²è¦§ã®ã¿
   - è‡ªåˆ†ãŒä½œæˆã—ãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ç·¨é›†ãƒ»å‰Šé™¤

2. **éƒ¨ç½²ç®¡ç†è€… (department_admin)**
   - è‡ªéƒ¨ç½²ãƒ¡ãƒ³ãƒãƒ¼ã®ç®¡ç†
   - è‡ªéƒ¨ç½²ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»ãƒ¡ãƒ¢ãƒ»ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®ç®¡ç†
   - è‡ªéƒ¨ç½²ã®ã‚´ãƒŸç®±ç®¡ç†

3. **å…¨ç¤¾ç®¡ç†è€… (company_admin)**
   - å…¨éƒ¨ç½²ã®ç®¡ç†
   - å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ç®¡ç†
   - å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç®¡ç†
   - **æ³¨æ„**: éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®äºˆå®šã¯ç·¨é›†ä¸å¯ï¼ˆéƒ¨ç½²ã®è‡ªå¾‹æ€§ã‚’å°Šé‡ï¼‰

---

## ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å¤‰æ›´

### 1. éƒ¨ç½²ãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¿½åŠ 

```sql
CREATE TABLE departments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL UNIQUE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_active (is_active)
);
```

**ã‚«ãƒ©ãƒ èª¬æ˜:**
- `id`: éƒ¨ç½²IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰
- `name`: éƒ¨ç½²åï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ï¼‰
- `is_active`: æœ‰åŠ¹/ç„¡åŠ¹ãƒ•ãƒ©ã‚°ï¼ˆéƒ¨ç½²çµ±å»ƒåˆæ™‚ã«ä½¿ç”¨ï¼‰
- `created_at`, `updated_at`: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—

### 2. usersãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤‰æ›´

```sql
ALTER TABLE users 
    ADD COLUMN department_id BIGINT NULL AFTER email,
    ADD COLUMN role_type ENUM('member', 'department_admin', 'company_admin') 
        DEFAULT 'member' AFTER role,
    ADD FOREIGN KEY fk_users_department (department_id) 
        REFERENCES departments(id) ON DELETE SET NULL;

-- æ—¢å­˜ã® department ã‚«ãƒ©ãƒ ã¯ç§»è¡Œå¾Œã«å‰Šé™¤
-- ALTER TABLE users DROP COLUMN department;

CREATE INDEX idx_users_department ON users(department_id);
CREATE INDEX idx_users_role_type ON users(role_type);
```

**å¤‰æ›´å†…å®¹:**
- `department` (VARCHAR) â†’ `department_id` (BIGINT FK)
- `role_type` (ENUM) ã‚’è¿½åŠ ï¼ˆæ—¢å­˜ã®`role`ã¯ä¿æŒï¼‰

### 3. calendarsãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤‰æ›´

```sql
ALTER TABLE calendars
    ADD COLUMN owner_type ENUM('department', 'company') 
        NOT NULL DEFAULT 'company' AFTER calendar_type,
    ADD COLUMN owner_id BIGINT NULL AFTER owner_type 
        COMMENT 'éƒ¨ç½²IDï¼ˆå…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å ´åˆã¯NULLï¼‰',
    ADD FOREIGN KEY fk_calendars_department (owner_id) 
        REFERENCES departments(id) ON DELETE CASCADE;

CREATE INDEX idx_calendars_owner ON calendars(owner_type, owner_id);
```

**ã‚«ãƒ©ãƒ èª¬æ˜:**
- `owner_type`: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ç¨®é¡ï¼ˆdepartment=éƒ¨ç½², company=å…¨ç¤¾ï¼‰
- `owner_id`: æ‰€æœ‰è€…IDï¼ˆéƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å ´åˆã¯éƒ¨ç½²IDã€å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å ´åˆã¯NULLï¼‰

### 4. eventsãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤‰æ›´

```sql
ALTER TABLE events
    ADD COLUMN visibility_type ENUM('public', 'department', 'custom', 'private') 
        NOT NULL DEFAULT 'custom' AFTER category,
    ADD COLUMN owner_department_id BIGINT NULL AFTER visibility_type 
        COMMENT 'ä½œæˆè€…ã®æ‰€å±éƒ¨ç½²ID',
    ADD FOREIGN KEY fk_events_department (owner_department_id) 
        REFERENCES departments(id) ON DELETE SET NULL;

CREATE INDEX idx_events_visibility_dept 
    ON events(visibility_type, owner_department_id);
CREATE INDEX idx_events_created_by ON events(created_by);
```

**ã‚«ãƒ©ãƒ èª¬æ˜:**
- `visibility_type`: å…¬é–‹ç¯„å›²
- `owner_department_id`: ä½œæˆæ™‚ã®æ‰€å±éƒ¨ç½²ï¼ˆç•°å‹•å¾Œã‚‚ä¿æŒï¼‰

### 5. shared_notesãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤‰æ›´

```sql
ALTER TABLE shared_notes
    ADD COLUMN visibility_type ENUM('public', 'department', 'custom', 'private') 
        NOT NULL DEFAULT 'custom' AFTER priority,
    ADD COLUMN owner_department_id BIGINT NULL AFTER visibility_type,
    ADD FOREIGN KEY fk_notes_department (owner_department_id) 
        REFERENCES departments(id) ON DELETE SET NULL;

CREATE INDEX idx_notes_visibility_dept 
    ON shared_notes(visibility_type, owner_department_id);
CREATE INDEX idx_notes_author ON shared_notes(author_id);
```

### 6. surveysãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤‰æ›´

```sql
ALTER TABLE surveys
    ADD COLUMN visibility_type ENUM('public', 'department', 'custom', 'private') 
        NOT NULL DEFAULT 'custom' AFTER is_active,
    ADD COLUMN owner_department_id BIGINT NULL AFTER visibility_type,
    ADD FOREIGN KEY fk_surveys_department (owner_department_id) 
        REFERENCES departments(id) ON DELETE SET NULL;

CREATE INDEX idx_surveys_visibility_dept 
    ON surveys(visibility_type, owner_department_id);
CREATE INDEX idx_surveys_created_by ON surveys(created_by);
```

### 7. trash_itemsãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤‰æ›´

```sql
ALTER TABLE trash_items
    ADD COLUMN owner_department_id BIGINT NULL AFTER item_id 
        COMMENT 'å‰Šé™¤æ™‚ã®æ‰€å±éƒ¨ç½²ID',
    ADD COLUMN visibility_type VARCHAR(20) NULL AFTER owner_department_id 
        COMMENT 'å…ƒã®å…¬é–‹ç¯„å›²',
    ADD FOREIGN KEY fk_trash_department (owner_department_id) 
        REFERENCES departments(id) ON DELETE SET NULL;

CREATE INDEX idx_trash_department ON trash_items(owner_department_id);
```

### 8. user_preferencesãƒ†ãƒ¼ãƒ–ãƒ«ã®è¿½åŠ 

```sql
ALTER TABLE user_preferences
    ADD COLUMN show_company_calendar_in_trash BOOLEAN DEFAULT FALSE 
        COMMENT 'ã‚´ãƒŸç®±ã«å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®é …ç›®ã‚‚è¡¨ç¤ºã™ã‚‹ã‹';
```

---

## æ¨©é™ç®¡ç†ã®è¨­è¨ˆ

### æ¨©é™ãƒãƒˆãƒªã‚¯ã‚¹

#### ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼äºˆå®šï¼‰ã®æ¨©é™

| æ“ä½œ | ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼ | éƒ¨ç½²ç®¡ç†è€… | å…¨ç¤¾ç®¡ç†è€… |
|------|------------|-----------|-----------|
| å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–²è¦§ | âœ… | âœ… | âœ… |
| å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä½œæˆ | âŒ | âŒ | âœ… |
| å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç·¨é›† | âŒ | âŒ | âœ… |
| å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å‰Šé™¤ | âŒ | âŒ | âœ… |
| è‡ªéƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–²è¦§ | âœ… | âœ… | âœ… |
| è‡ªéƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä½œæˆ | âœ… | âœ… | âœ… |
| è‡ªéƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç·¨é›† | âœ…â€»1 | âœ…â€»2 | âŒâ€»3 |
| è‡ªéƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å‰Šé™¤ | âœ…â€»1 | âœ…â€»2 | âŒâ€»3 |
| ä»–éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–²è¦§ | âœ…â€»4 | âœ…â€»4 | âœ… |
| ä»–éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä½œæˆ | âŒ | âŒ | âŒ |
| ä»–éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç·¨é›† | âœ…â€»5 | âŒ | âŒâ€»3 |
| ä»–éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å‰Šé™¤ | âŒ | âŒ | âŒâ€»3 |

**æ³¨é‡ˆ:**
- â€»1: è‡ªåˆ†ãŒä½œæˆã—ãŸäºˆå®šã€ã¾ãŸã¯å‚åŠ è€…ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹äºˆå®šã®ã¿
- â€»2: è‡ªéƒ¨ç½²ã®å…¨ã¦ã®äºˆå®š
- â€»3: å…¨ç¤¾ç®¡ç†è€…ã¯éƒ¨ç½²ã®è‡ªå¾‹æ€§ã‚’å°Šé‡ã—ã€éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯ç·¨é›†ä¸å¯
- â€»4: å…¬é–‹ç¯„å›²ã«å¿œã˜ã¦é–²è¦§å¯èƒ½
- â€»5: å‚åŠ è€…ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿

#### å…±æœ‰ãƒ¡ãƒ¢ã®æ¨©é™

| æ“ä½œ | ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼ | éƒ¨ç½²ç®¡ç†è€… | å…¨ç¤¾ç®¡ç†è€… |
|------|------------|-----------|-----------|
| å…¨ç¤¾å…¬é–‹ãƒ¡ãƒ¢é–²è¦§ | âœ… | âœ… | âœ… |
| å…¨ç¤¾å…¬é–‹ãƒ¡ãƒ¢ä½œæˆ | âœ… | âœ… | âœ… |
| å…¨ç¤¾å…¬é–‹ãƒ¡ãƒ¢ç·¨é›† | âœ…â€»1 | âœ…â€»1 | âœ… |
| å…¨ç¤¾å…¬é–‹ãƒ¡ãƒ¢å‰Šé™¤ | âœ…â€»1 | âœ…â€»1 | âœ… |
| éƒ¨ç½²é™å®šãƒ¡ãƒ¢é–²è¦§ | âœ…â€»2 | âœ…â€»2 | âœ… |
| éƒ¨ç½²é™å®šãƒ¡ãƒ¢ä½œæˆ | âœ… | âœ… | âœ… |
| éƒ¨ç½²é™å®šãƒ¡ãƒ¢ç·¨é›† | âœ…â€»1 | âœ…â€»3 | âŒ |
| éƒ¨ç½²é™å®šãƒ¡ãƒ¢å‰Šé™¤ | âœ…â€»1 | âœ…â€»3 | âŒ |

**æ³¨é‡ˆ:**
- â€»1: è‡ªåˆ†ãŒä½œæˆã—ãŸãƒ¡ãƒ¢ã€ã¾ãŸã¯å‚åŠ è€…ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ¢ã®ã¿
- â€»2: åŒã˜éƒ¨ç½²ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿
- â€»3: è‡ªéƒ¨ç½²ã®å…¨ã¦ã®ãƒ¡ãƒ¢

#### ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®æ¨©é™

| æ“ä½œ | ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼ | éƒ¨ç½²ç®¡ç†è€… | å…¨ç¤¾ç®¡ç†è€… |
|------|------------|-----------|-----------|
| ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé–²è¦§ | âœ…â€»1 | âœ…â€»2 | âœ… |
| ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä½œæˆ | âœ… | âœ… | âœ… |
| ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç·¨é›† | âœ…â€»3 | âœ…â€»2 | âœ… |
| ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå‰Šé™¤ | âœ…â€»3 | âœ…â€»2 | âœ… |
| å›ç­”é–²è¦§ | âœ…â€»3 | âœ…â€»2 | âœ… |

**æ³¨é‡ˆ:**
- â€»1: å›ç­”å¯¾è±¡è€…ã¨ã—ã¦æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®ã¿
- â€»2: è‡ªéƒ¨ç½²ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå…¨ã¦
- â€»3: è‡ªåˆ†ãŒä½œæˆã—ãŸã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®ã¿

### æ¨©é™ãƒã‚§ãƒƒã‚¯ã®å®Ÿè£…

```php
// app/Policies/EventPolicy.php
class EventPolicy
{
    /**
     * ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç·¨é›†ã§ãã‚‹ã‹
     */
    public function update(User $user, Event $event): bool
    {
        $calendar = $event->calendar;
        
        // å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å ´åˆ
        if ($calendar->owner_type === 'company') {
            return $user->role_type === 'company_admin';
        }
        
        // éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å ´åˆ
        // 1. ä½œæˆè€…æœ¬äºº
        if ($event->created_by === $user->id) {
            return true;
        }
        
        // 2. å‚åŠ è€…ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹
        if ($event->participants->contains($user->id)) {
            return true;
        }
        
        // 3. éƒ¨ç½²ç®¡ç†è€…ï¼ˆåŒã˜éƒ¨ç½²ã®ã¿ï¼‰
        if ($user->role_type === 'department_admin' 
            && $event->owner_department_id === $user->department_id) {
            return true;
        }
        
        // 4. å…¨ç¤¾ç®¡ç†è€…ã¯éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ç·¨é›†ä¸å¯
        return false;
    }
    
    /**
     * ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã§ãã‚‹ã‹
     */
    public function delete(User $user, Event $event): bool
    {
        return $this->update($user, $event);
    }
    
    /**
     * ã‚¤ãƒ™ãƒ³ãƒˆã‚’é–²è¦§ã§ãã‚‹ã‹
     */
    public function view(User $user, Event $event): bool
    {
        // 1. å…¨ç¤¾å…¬é–‹
        if ($event->visibility_type === 'public') {
            return true;
        }
        
        // 2. éƒ¨ç½²é™å®šï¼ˆåŒã˜éƒ¨ç½²ã®ã¿ï¼‰
        if ($event->visibility_type === 'department' 
            && $event->owner_department_id === $user->department_id) {
            return true;
        }
        
        // 3. ã‚«ã‚¹ã‚¿ãƒ ï¼ˆå‚åŠ è€…ã®ã¿ï¼‰
        if ($event->visibility_type === 'custom' 
            && $event->participants->contains($user->id)) {
            return true;
        }
        
        // 4. éå…¬é–‹ï¼ˆä½œæˆè€…ã®ã¿ï¼‰
        if ($event->visibility_type === 'private' 
            && $event->created_by === $user->id) {
            return true;
        }
        
        // 5. å…¨ç¤¾ç®¡ç†è€…ã¯å…¨ã¦é–²è¦§å¯èƒ½
        if ($user->role_type === 'company_admin') {
            return true;
        }
        
        return false;
    }
}
```


---

## éƒ¨ç½²ç•°å‹•æ™‚ã®å‡¦ç†

### åŸºæœ¬æ–¹é‡
1. **ç•°å‹•å‰ã®äºˆå®š**: å…ƒã®éƒ¨ç½²ã«æ®‹ã™ + æ‰€æœ‰æ¨©ã‚’éƒ¨ç½²ç®¡ç†è€…ã«ç§»è­²
2. **ç•°å‹•å¾Œã®äºˆå®š**: æ–°ã—ã„éƒ¨ç½²ã«ç§»å‹•
3. **ç¹°ã‚Šè¿”ã—äºˆå®š**: å…ƒã®éƒ¨ç½²ã«æ®‹ã™ï¼ˆéƒ¨ç½²ã®å®šä¾‹ä¼šè­°ãªã©ã®ãŸã‚ï¼‰
4. **å‚åŠ è€…ãŒæœ¬äººã®ã¿ã®äºˆå®š**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèª

### å‡¦ç†ãƒ•ãƒ­ãƒ¼

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éƒ¨ç½²ç•°å‹•
â†“
1. ç•°å‹•æ—¥ï¼ˆä»Šæ—¥ï¼‰ã‚’åŸºæº–ã«äºˆå®šã‚’åˆ†é¡
   â”œâ”€ éå»ã®äºˆå®šï¼ˆend_date < ä»Šæ—¥ï¼‰
   â”‚  â””â”€ å…ƒã®éƒ¨ç½²ã«æ®‹ã™ + æ‰€æœ‰æ¨©ã‚’éƒ¨ç½²ç®¡ç†è€…ã«ç§»è­²
   â”‚
   â”œâ”€ æœªæ¥ã®äºˆå®šï¼ˆstart_date >= ä»Šæ—¥ï¼‰
   â”‚  â”œâ”€ ç¹°ã‚Šè¿”ã—äºˆå®š
   â”‚  â”‚  â””â”€ å…ƒã®éƒ¨ç½²ã«æ®‹ã™ï¼ˆéƒ¨ç½²ã®å®šä¾‹ä¼šè­°ã®ãŸã‚ï¼‰
   â”‚  â”‚
   â”‚  â””â”€ å˜ç™ºäºˆå®š
   â”‚     â”œâ”€ å‚åŠ è€…ãŒæœ¬äººã®ã¿
   â”‚     â”‚  â””â”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
   â”‚     â”‚     â”œâ”€ æ–°ã—ã„éƒ¨ç½²ã«ç§»å‹•
   â”‚     â”‚     â””â”€ å…ƒã®éƒ¨ç½²ã«æ®‹ã™ + æ‰€æœ‰æ¨©ç§»è­²
   â”‚     â”‚
   â”‚     â””â”€ å‚åŠ è€…ãŒè¤‡æ•°
   â”‚        â””â”€ æ–°ã—ã„éƒ¨ç½²ã«ç§»å‹•
   â”‚
   â””â”€ é€²è¡Œä¸­ã®äºˆå®šï¼ˆstart_date < ä»Šæ—¥ < end_dateï¼‰
      â””â”€ å…ƒã®éƒ¨ç½²ã«æ®‹ã™
```

### å®Ÿè£…ã‚³ãƒ¼ãƒ‰

```php
// app/Services/UserDepartmentTransferService.php
class UserDepartmentTransferService
{
    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éƒ¨ç½²ç•°å‹•å‡¦ç†
     */
    public function transferDepartment(User $user, int $newDepartmentId): array
    {
        $oldDepartmentId = $user->department_id;
        $today = Carbon::today();
        
        DB::beginTransaction();
        
        try {
            // 1. éå»ã®äºˆå®š: å…ƒã®éƒ¨ç½²ã«æ®‹ã™ + æ‰€æœ‰æ¨©ã‚’éƒ¨ç½²ç®¡ç†è€…ã«ç§»è­²
            $this->transferPastEvents($user, $oldDepartmentId, $today);
            
            // 2. ç¹°ã‚Šè¿”ã—äºˆå®š: å…ƒã®éƒ¨ç½²ã«æ®‹ã™
            $this->keepRecurringEvents($user, $oldDepartmentId);
            
            // 3. æœªæ¥ã®å˜ç™ºäºˆå®š: å‚åŠ è€…ã‚’ãƒã‚§ãƒƒã‚¯
            $soloEvents = $this->checkSoloEvents($user, $oldDepartmentId, $today);
            
            if ($soloEvents->isNotEmpty()) {
                // ç¢ºèªãŒå¿…è¦ãªäºˆå®šãŒã‚ã‚‹å ´åˆ
                DB::rollBack();
                return [
                    'requires_confirmation' => true,
                    'solo_events' => $soloEvents,
                ];
            }
            
            // 4. æœªæ¥ã®äºˆå®šï¼ˆå‚åŠ è€…ãŒè¤‡æ•°ï¼‰: æ–°ã—ã„éƒ¨ç½²ã«ç§»å‹•
            $this->transferFutureEvents($user, $oldDepartmentId, $newDepartmentId, $today);
            
            // 5. å…±æœ‰ãƒ¡ãƒ¢ã¨ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚‚åŒæ§˜ã«å‡¦ç†
            $this->transferSharedNotes($user, $oldDepartmentId, $newDepartmentId, $today);
            $this->transferSurveys($user, $oldDepartmentId, $newDepartmentId, $today);
            
            // 6. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éƒ¨ç½²ã‚’æ›´æ–°
            $user->update(['department_id' => $newDepartmentId]);
            
            DB::commit();
            
            return ['success' => true];
            
        } catch (\Exception $e) {
            DB::rollBack();
            throw $e;
        }
    }
    
    /**
     * éå»ã®äºˆå®šã‚’å‡¦ç†
     */
    private function transferPastEvents(User $user, int $oldDepartmentId, Carbon $today): void
    {
        $departmentAdmin = $this->getDepartmentAdmin($oldDepartmentId);
        
        Event::where('created_by', $user->id)
            ->where('owner_department_id', $oldDepartmentId)
            ->where('end_date', '<', $today)
            ->update(['created_by' => $departmentAdmin->id]);
    }
    
    /**
     * ç¹°ã‚Šè¿”ã—äºˆå®šã‚’å…ƒã®éƒ¨ç½²ã«æ®‹ã™
     */
    private function keepRecurringEvents(User $user, int $oldDepartmentId): void
    {
        $departmentAdmin = $this->getDepartmentAdmin($oldDepartmentId);
        
        Event::where('created_by', $user->id)
            ->where('owner_department_id', $oldDepartmentId)
            ->whereHas('recurrence')
            ->update(['created_by' => $departmentAdmin->id]);
    }
    
    /**
     * å‚åŠ è€…ãŒæœ¬äººã®ã¿ã®äºˆå®šã‚’ãƒã‚§ãƒƒã‚¯
     */
    private function checkSoloEvents(User $user, int $oldDepartmentId, Carbon $today)
    {
        return Event::where('created_by', $user->id)
            ->where('owner_department_id', $oldDepartmentId)
            ->where('start_date', '>=', $today)
            ->whereDoesntHave('recurrence')
            ->whereHas('participants', function($q) use ($user) {
                $q->where('user_id', $user->id);
            }, '=', 1)
            ->get();
    }
    
    /**
     * æœªæ¥ã®äºˆå®šã‚’æ–°ã—ã„éƒ¨ç½²ã«ç§»å‹•
     */
    private function transferFutureEvents(
        User $user, 
        int $oldDepartmentId, 
        int $newDepartmentId, 
        Carbon $today
    ): void {
        $newCalendar = $this->getDepartmentCalendar($newDepartmentId);
        
        Event::where('created_by', $user->id)
            ->where('owner_department_id', $oldDepartmentId)
            ->where('start_date', '>=', $today)
            ->whereDoesntHave('recurrence')
            ->whereHas('participants', function($q) {
                // å‚åŠ è€…ãŒ2äººä»¥ä¸Š
            }, '>', 1)
            ->update([
                'owner_department_id' => $newDepartmentId,
                'calendar_id' => $newCalendar->calendar_id,
            ]);
    }
    
    /**
     * éƒ¨ç½²ç®¡ç†è€…ã‚’å–å¾—
     */
    private function getDepartmentAdmin(int $departmentId): User
    {
        $admin = User::where('department_id', $departmentId)
            ->where('role_type', 'department_admin')
            ->first();
            
        if (!$admin) {
            // éƒ¨ç½²ç®¡ç†è€…ãŒã„ãªã„å ´åˆã¯å…¨ç¤¾ç®¡ç†è€…
            $admin = User::where('role_type', 'company_admin')->first();
        }
        
        if (!$admin) {
            throw new \Exception('ç®¡ç†è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        
        return $admin;
    }
    
    /**
     * éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å–å¾—
     */
    private function getDepartmentCalendar(int $departmentId): Calendar
    {
        return Calendar::where('owner_type', 'department')
            ->where('owner_id', $departmentId)
            ->firstOrFail();
    }
    
    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠã«åŸºã¥ã„ã¦å˜ç‹¬äºˆå®šã‚’å‡¦ç†
     */
    public function handleSoloEventsChoice(
        User $user, 
        array $eventIds, 
        string $choice,
        int $newDepartmentId
    ): void {
        $events = Event::whereIn('event_id', $eventIds)->get();
        
        if ($choice === 'transfer') {
            // æ–°ã—ã„éƒ¨ç½²ã«ç§»å‹•
            $newCalendar = $this->getDepartmentCalendar($newDepartmentId);
            
            foreach ($events as $event) {
                $event->update([
                    'owner_department_id' => $newDepartmentId,
                    'calendar_id' => $newCalendar->calendar_id,
                ]);
            }
        } else {
            // å…ƒã®éƒ¨ç½²ã«æ®‹ã™ + æ‰€æœ‰æ¨©ç§»è­²
            $departmentAdmin = $this->getDepartmentAdmin($user->department_id);
            
            foreach ($events as $event) {
                $event->update(['created_by' => $departmentAdmin->id]);
            }
        }
    }
}
```

### ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆUIï¼‰

```vue
<template>
  <Dialog v-model:open="showTransferConfirm">
    <DialogContent class="max-w-2xl">
      <DialogHeader>
        <DialogTitle>éƒ¨ç½²ç•°å‹•ã®ç¢ºèª</DialogTitle>
        <DialogDescription>
          ä»¥ä¸‹ã®äºˆå®šã¯å‚åŠ è€…ãŒã‚ãªãŸã®ã¿ã§ã™ã€‚ç•°å‹•å¾Œã®æ‰±ã„ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
        </DialogDescription>
      </DialogHeader>
      
      <div class="space-y-4">
        <div class="max-h-60 overflow-y-auto space-y-2 border rounded-lg p-4">
          <div
            v-for="event in soloEvents"
            :key="event.event_id"
            class="p-3 bg-gray-50 rounded"
          >
            <div class="font-medium">{{ event.title }}</div>
            <div class="text-sm text-gray-500">
              {{ formatDate(event.start_date) }} - {{ formatDate(event.end_date) }}
            </div>
            <div class="text-xs text-gray-400 mt-1">
              {{ event.calendar.calendar_name }}
            </div>
          </div>
        </div>
        
        <RadioGroup v-model="transferOption">
          <div class="space-y-3">
            <div class="flex items-start space-x-3 p-3 border rounded-lg hover:bg-gray-50">
              <RadioGroupItem value="transfer" id="transfer" />
              <Label for="transfer" class="flex-1 cursor-pointer">
                <div class="font-medium">æ–°ã—ã„éƒ¨ç½²ã«ç§»å‹•</div>
                <div class="text-sm text-gray-500">
                  {{ newDepartment.name }}ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç§»å‹•ã—ã€å¼•ãç¶šãç·¨é›†ã§ãã¾ã™
                </div>
              </Label>
            </div>
            
            <div class="flex items-start space-x-3 p-3 border rounded-lg hover:bg-gray-50">
              <RadioGroupItem value="keep" id="keep" />
              <Label for="keep" class="flex-1 cursor-pointer">
                <div class="font-medium">å…ƒã®éƒ¨ç½²ã«æ®‹ã™</div>
                <div class="text-sm text-gray-500">
                  {{ oldDepartment.name }}ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«æ®‹ã—ã€æ‰€æœ‰æ¨©ã‚’éƒ¨ç½²ç®¡ç†è€…ã«ç§»è­²ã—ã¾ã™
                  ï¼ˆã‚ãªãŸã¯ç·¨é›†ã§ããªããªã‚Šã¾ã™ï¼‰
                </div>
              </Label>
            </div>
          </div>
        </RadioGroup>
      </div>
      
      <DialogFooter>
        <Button variant="outline" @click="showTransferConfirm = false">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </Button>
        <Button @click="confirmTransfer">
          ç¢ºå®š
        </Button>
      </DialogFooter>
    </DialogContent>
  </Dialog>
</template>

<script setup lang="ts">
const transferOption = ref('transfer')

const confirmTransfer = async () => {
  await axios.post('/api/users/transfer-solo-events', {
    event_ids: soloEvents.value.map(e => e.event_id),
    choice: transferOption.value,
    new_department_id: newDepartment.value.id,
  })
  
  showTransferConfirm.value = false
  // éƒ¨ç½²ç•°å‹•ã‚’å®Œäº†
  await completeDepartmentTransfer()
}
</script>
```

---

## æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œæˆ¦ç•¥

### å‰ææ¡ä»¶
- ç¾åœ¨ã¯ç·å‹™éƒ¨ã®ã¿ã§é‹ç”¨
- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯æ•°ç™¾ä»¶ç¨‹åº¦ã¨æƒ³å®š
- ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ã¯æœ€å°é™ã«æŠ‘ãˆã‚‹

### ç§»è¡Œæ‰‹é †

#### ã‚¹ãƒ†ãƒƒãƒ—1: éƒ¨ç½²ãƒã‚¹ã‚¿ã®ä½œæˆ

```sql
-- ç·å‹™éƒ¨ã‚’ä½œæˆ
INSERT INTO departments (name, is_active) VALUES ('ç·å‹™éƒ¨', TRUE);

-- ä»–ã®éƒ¨ç½²ã‚‚å¿…è¦ã«å¿œã˜ã¦ä½œæˆ
INSERT INTO departments (name, is_active) VALUES 
    ('å–¶æ¥­éƒ¨', TRUE),
    ('é–‹ç™ºéƒ¨', TRUE),
    ('çµŒç†éƒ¨', TRUE);
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éƒ¨ç½²IDã‚’è¨­å®š

```php
// æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç·å‹™éƒ¨ã«å‰²ã‚Šå½“ã¦
$somubuDept = Department::where('name', 'ç·å‹™éƒ¨')->first();

User::whereNotNull('department')
    ->where('department', 'ç·å‹™éƒ¨')
    ->update(['department_id' => $somubuDept->id]);

// ä»–ã®éƒ¨ç½²ã‚‚åŒæ§˜ã«å‡¦ç†
```

#### ã‚¹ãƒ†ãƒƒãƒ—3: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ä½œæˆ

```php
// å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ä½œæˆ
Calendar::create([
    'calendar_name' => 'å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼',
    'calendar_type' => 'shared',
    'owner_type' => 'company',
    'owner_id' => null,
]);

// ç·å‹™éƒ¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ä½œæˆ
$somubuDept = Department::where('name', 'ç·å‹™éƒ¨')->first();
Calendar::create([
    'calendar_name' => 'ç·å‹™éƒ¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼',
    'calendar_type' => 'shared',
    'owner_type' => 'department',
    'owner_id' => $somubuDept->id,
]);
```

#### ã‚¹ãƒ†ãƒƒãƒ—4: æ—¢å­˜ã‚¤ãƒ™ãƒ³ãƒˆã®ç§»è¡Œ

```php
// ç§»è¡Œã‚³ãƒãƒ³ãƒ‰
php artisan make:command MigrateToDepartmentSystem

// app/Console/Commands/MigrateToDepartmentSystem.php
class MigrateToDepartmentSystem extends Command
{
    protected $signature = 'migrate:department-system';
    protected $description = 'éƒ¨ç½²ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ç§»è¡Œ';
    
    public function handle()
    {
        $this->info('ç§»è¡Œã‚’é–‹å§‹ã—ã¾ã™...');
        
        // ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹
        Artisan::call('down', [
            '--message' => 'ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ä¸­ï¼ˆç´„5åˆ†ï¼‰',
            '--retry' => 60,
        ]);
        
        DB::transaction(function() {
            $this->migrateEvents();
            $this->migrateSharedNotes();
            $this->migrateSurveys();
        });
        
        // ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰è§£é™¤
        Artisan::call('up');
        
        $this->info('ç§»è¡ŒãŒå®Œäº†ã—ã¾ã—ãŸï¼');
    }
    
    private function migrateEvents()
    {
        $somubuDept = Department::where('name', 'ç·å‹™éƒ¨')->first();
        $somubuCalendar = Calendar::where('owner_type', 'department')
            ->where('owner_id', $somubuDept->id)
            ->first();
        
        Event::whereNull('owner_department_id')
            ->chunkById(100, function($events) use ($somubuDept, $somubuCalendar) {
                foreach ($events as $event) {
                    $creator = User::find($event->created_by);
                    
                    $event->update([
                        'calendar_id' => $somubuCalendar->calendar_id,
                        'owner_department_id' => $creator?->department_id ?? $somubuDept->id,
                        'visibility_type' => $this->determineVisibilityType($event),
                    ]);
                }
            });
        
        $this->info('Events: ' . Event::count() . 'ä»¶ã‚’ç§»è¡Œ');
    }
    
    private function migrateSharedNotes()
    {
        $somubuDept = Department::where('name', 'ç·å‹™éƒ¨')->first();
        
        SharedNote::whereNull('owner_department_id')
            ->chunkById(100, function($notes) use ($somubuDept) {
                foreach ($notes as $note) {
                    $author = User::find($note->author_id);
                    
                    $note->update([
                        'owner_department_id' => $author?->department_id ?? $somubuDept->id,
                        'visibility_type' => $this->determineVisibilityType($note),
                    ]);
                }
            });
        
        $this->info('SharedNotes: ' . SharedNote::count() . 'ä»¶ã‚’ç§»è¡Œ');
    }
    
    private function migrateSurveys()
    {
        $somubuDept = Department::where('name', 'ç·å‹™éƒ¨')->first();
        
        Survey::whereNull('owner_department_id')
            ->chunkById(100, function($surveys) use ($somubuDept) {
                foreach ($surveys as $survey) {
                    $creator = User::find($survey->created_by);
                    
                    $survey->update([
                        'owner_department_id' => $creator?->department_id ?? $somubuDept->id,
                        'visibility_type' => $this->determineVisibilityType($survey),
                    ]);
                }
            });
        
        $this->info('Surveys: ' . Survey::count() . 'ä»¶ã‚’ç§»è¡Œ');
    }
    
    /**
     * ç¾åœ¨ã®å®Ÿè£…ã‹ã‚‰ visibility_type ã‚’æ¨æ¸¬
     */
    private function determineVisibilityType($model): string
    {
        // å‚åŠ è€…ãŒ0äºº â†’ publicï¼ˆå…¨å“¡ãŒé–²è¦§å¯èƒ½ã ã£ãŸï¼‰
        if (!$model->participants()->exists()) {
            return 'public';
        }
        
        // å‚åŠ è€…ãŒã„ã‚‹ â†’ customï¼ˆç‰¹å®šã®ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ï¼‰
        return 'custom';
    }
}
```

#### ã‚¹ãƒ†ãƒƒãƒ—5: å®Ÿè¡Œ

```bash
# æœ¬ç•ªç’°å¢ƒã§ã®å®Ÿè¡Œ
php artisan migrate:department-system

# æ‰€è¦æ™‚é–“: æ•°ç™¾ä»¶ãªã‚‰1-2åˆ†ç¨‹åº¦
# ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ : 1-2åˆ†
```

### ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

```bash
# ä¸‡ãŒä¸€å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆ
php artisan migrate:rollback

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ
mysql -u user -p database < backup.sql
```


---

## ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»ãƒ¡ãƒ¢ãƒ»ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯

### ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è¡¨ç¤º

#### çµ±åˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰

å…¨ã¦ã®äºˆå®šã‚’1ã¤ã®ãƒ“ãƒ¥ãƒ¼ã«è¡¨ç¤ºã—ã€ãƒ€ãƒ–ãƒ«ãƒ–ãƒƒã‚­ãƒ³ã‚°ã‚’é˜²æ­¢ã—ã¾ã™ã€‚

```php
// app/Http/Controllers/CalendarController.php
public function getEventsApi(Request $request)
{
    $user = auth()->user();
    $start = $request->query('start');
    $end = $request->query('end');
    
    // é–²è¦§å¯èƒ½ãªå…¨ã¦ã®äºˆå®šã‚’å–å¾—
    $events = Event::with(['creator', 'participants', 'calendar', 'recurrence'])
        ->where(function($query) use ($user) {
            $query
                // 1. å…¨ç¤¾å…¬é–‹
                ->where('visibility_type', 'public')
                
                // 2. è‡ªåˆ†ã®éƒ¨ç½²ã®éƒ¨ç½²é™å®š
                ->orWhere(function($q) use ($user) {
                    $q->where('visibility_type', 'department')
                      ->where('owner_department_id', $user->department_id);
                })
                
                // 3. å‚åŠ è€…ã¨ã—ã¦ç™»éŒ²
                ->orWhereHas('participants', function($q) use ($user) {
                    $q->where('user_id', $user->id);
                })
                
                // 4. è‡ªåˆ†ãŒä½œæˆ
                ->orWhere('created_by', $user->id);
        })
        ->whereBetween('start_date', [$start, $end])
        ->get();
    
    // ç¹°ã‚Šè¿”ã—äºˆå®šã‚’å±•é–‹
    $expandedEvents = $this->eventService->getExpandedEvents($start, $end, null);
    
    return response()->json($expandedEvents);
}
```

#### ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

```vue
<template>
  <div class="calendar-view">
    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¸æŠ -->
    <div class="calendar-selector">
      <Select v-model="selectedCalendar">
        <SelectTrigger>
          <SelectValue placeholder="ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é¸æŠ" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="all">
            <Globe class="h-4 w-4 inline mr-2" />
            å…¨ã¦ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
          </SelectItem>
          <SelectItem value="company">
            <Building class="h-4 w-4 inline mr-2" />
            å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
          </SelectItem>
          <SelectItem :value="`dept-${user.department_id}`">
            <Users class="h-4 w-4 inline mr-2" />
            {{ user.department.name }}ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
          </SelectItem>
        </SelectContent>
      </Select>
    </div>
    
    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º -->
    <FullCalendar :options="calendarOptions" />
  </div>
</template>

<script setup lang="ts">
const selectedCalendar = ref('all')

const calendarOptions = computed(() => ({
  events: async (info) => {
    const response = await axios.get('/api/calendar/events', {
      params: {
        start: info.startStr,
        end: info.endStr,
        calendar_filter: selectedCalendar.value,
      }
    })
    return response.data
  },
  // ... ãã®ä»–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
}))
</script>
```

### å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è¡¨ç¤º

#### å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å°‚ç”¨ãƒšãƒ¼ã‚¸

```vue
<!-- resources/js/Pages/CompanyCalendar.vue -->
<template>
  <AppLayout title="å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼">
    <div class="space-y-4">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold">å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
        <Button
          v-if="canCreateCompanyEvent"
          @click="showCreateDialog = true"
        >
          <Plus class="h-4 w-4 mr-2" />
          å…¨ä½“é€£çµ¡ã‚’è¿½åŠ 
        </Button>
      </div>
      
      <Alert>
        <Info class="h-4 w-4" />
        <AlertDescription>
          å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ã¯ä¼šç¤¾è¡Œäº‹ã€ä¼‘æ—¥ã€å…¨ä½“é€£çµ¡ã®ã¿ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
        </AlertDescription>
      </Alert>
      
      <FullCalendar
        :options="{
          events: companyEvents,
          // ...
        }"
      />
    </div>
  </AppLayout>
</template>

<script setup lang="ts">
const canCreateCompanyEvent = computed(() => {
  return user.value.role_type === 'company_admin'
})

const companyEvents = async (info) => {
  const response = await axios.get('/api/calendar/company-events', {
    params: {
      start: info.startStr,
      end: info.endStr,
    }
  })
  return response.data
}
</script>
```

### å…±æœ‰ãƒ¡ãƒ¢ã®è¡¨ç¤º

#### å…¨ç¤¾ãƒ¡ãƒ¢ã¨éƒ¨ç½²ãƒ¡ãƒ¢ã®çµ±åˆè¡¨ç¤º

```php
// app/Http/Controllers/SharedNoteController.php
public function index(Request $request)
{
    $user = auth()->user();
    $filter = $request->query('filter', 'all'); // all, company, department, my
    
    $query = SharedNote::with(['author', 'tags', 'participants'])
        ->where('is_deleted', false);
    
    switch ($filter) {
        case 'company':
            // å…¨ç¤¾å…¬é–‹ã®ãƒ¡ãƒ¢ã®ã¿
            $query->where('visibility_type', 'public');
            break;
            
        case 'department':
            // è‡ªéƒ¨ç½²ã®ãƒ¡ãƒ¢ã®ã¿
            $query->where('visibility_type', 'department')
                  ->where('owner_department_id', $user->department_id);
            break;
            
        case 'my':
            // è‡ªåˆ†ãŒä½œæˆã—ãŸãƒ¡ãƒ¢ã®ã¿
            $query->where('author_id', $user->id);
            break;
            
        default:
            // å…¨ã¦ï¼ˆé–²è¦§å¯èƒ½ãªã‚‚ã®ï¼‰
            $query->where(function($q) use ($user) {
                $q->where('visibility_type', 'public')
                  ->orWhere(function($subQ) use ($user) {
                      $subQ->where('visibility_type', 'department')
                           ->where('owner_department_id', $user->department_id);
                  })
                  ->orWhereHas('participants', function($subQ) use ($user) {
                      $subQ->where('user_id', $user->id);
                  })
                  ->orWhere('author_id', $user->id);
            });
    }
    
    $notes = $query->orderBy('created_at', 'desc')->paginate(20);
    
    return Inertia::render('SharedNotes/Index', [
        'notes' => $notes,
        'filter' => $filter,
    ]);
}
```

#### UIå®Ÿè£…

```vue
<template>
  <div class="shared-notes">
    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <Tabs v-model="activeFilter">
      <TabsList>
        <TabsTrigger value="all">
          å…¨ã¦
          <Badge class="ml-2">{{ counts.all }}</Badge>
        </TabsTrigger>
        <TabsTrigger value="company">
          å…¨ç¤¾
          <Badge class="ml-2">{{ counts.company }}</Badge>
        </TabsTrigger>
        <TabsTrigger value="department">
          {{ user.department.name }}
          <Badge class="ml-2">{{ counts.department }}</Badge>
        </TabsTrigger>
        <TabsTrigger value="my">
          è‡ªåˆ†ã®ãƒ¡ãƒ¢
          <Badge class="ml-2">{{ counts.my }}</Badge>
        </TabsTrigger>
      </TabsList>
    </Tabs>
    
    <!-- ãƒ¡ãƒ¢ä¸€è¦§ -->
    <div class="notes-grid">
      <NoteCard
        v-for="note in notes"
        :key="note.note_id"
        :note="note"
      />
    </div>
  </div>
</template>

<script setup lang="ts">
const activeFilter = ref('all')

watch(activeFilter, (newFilter) => {
  router.get(route('notes.index', { filter: newFilter }))
})
</script>
```

### ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®è¡¨ç¤º

#### å…¨ç¤¾ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¨éƒ¨ç½²ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®åˆ†é›¢

```php
// app/Http/Controllers/SurveyController.php
public function index(Request $request)
{
    $user = auth()->user();
    $scope = $request->query('scope', 'my'); // my, department, company
    
    $query = Survey::with(['creator', 'questions', 'responses'])
        ->where('is_deleted', false)
        ->where('is_active', true);
    
    switch ($scope) {
        case 'company':
            // å…¨ç¤¾ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ
            $query->where('visibility_type', 'public');
            break;
            
        case 'department':
            // éƒ¨ç½²ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ
            $query->where('visibility_type', 'department')
                  ->where('owner_department_id', $user->department_id);
            break;
            
        case 'my':
            // è‡ªåˆ†ãŒå›ç­”å¯¾è±¡ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ
            $query->whereHas('respondents', function($q) use ($user) {
                $q->where('user_id', $user->id);
            });
            break;
    }
    
    $surveys = $query->orderBy('created_at', 'desc')->get();
    
    return Inertia::render('Surveys/Index', [
        'surveys' => $surveys,
        'scope' => $scope,
    ]);
}
```

---

## ã‚´ãƒŸç®±ã®éƒ¨ç½²ç®¡ç†

### åŸºæœ¬æ–¹é‡

1. **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**: è‡ªéƒ¨ç½²ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ã¿è¡¨ç¤º
2. **è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³**: å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚‚å«ã‚ã‚‹ã‹é¸æŠå¯èƒ½
3. **æ¨©é™**: éƒ¨ç½²ç®¡ç†è€…ã¯è‡ªéƒ¨ç½²ã®å…¨ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç®¡ç†ã€ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼ã¯è‡ªåˆ†ãŒå‰Šé™¤ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã®ã¿

### ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```sql
-- trash_items ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ æ¸ˆã¿
ALTER TABLE trash_items
    ADD COLUMN owner_department_id BIGINT NULL,
    ADD COLUMN visibility_type VARCHAR(20) NULL;

-- user_preferences ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ 
ALTER TABLE user_preferences
    ADD COLUMN show_company_calendar_in_trash BOOLEAN DEFAULT FALSE;
```

### å‰Šé™¤æ™‚ã®å‡¦ç†

```php
// app/Services/EventService.php
public function deleteEvent(Event $event)
{
    $user = auth()->user();
    
    // ã‚´ãƒŸç®±ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆ
    TrashItem::create([
        'user_id' => $user->id,
        'item_type' => 'event',
        'is_shared' => true,
        'item_id' => $event->event_id,
        'original_title' => $event->title,
        'owner_department_id' => $event->owner_department_id,
        'visibility_type' => $event->visibility_type,
        'deleted_at' => now(),
        'permanent_delete_at' => now()->addDays(30),
    ]);
    
    $event->delete();
}
```

### ã‚´ãƒŸç®±ã®è¡¨ç¤º

```php
// app/Http/Controllers/TrashController.php
public function index(Request $request)
{
    $user = auth()->user();
    $preferences = $user->preferences ?? new UserPreference();
    
    $query = TrashItem::with(['user'])
        ->where(function($q) use ($user, $preferences) {
            // 1. è‡ªåˆ†ãŒå‰Šé™¤ã—ãŸã‚¢ã‚¤ãƒ†ãƒ 
            $q->where('user_id', $user->id);
            
            // 2. éƒ¨ç½²ç®¡ç†è€…ã®å ´åˆ: è‡ªéƒ¨ç½²ã®å…¨ã‚¢ã‚¤ãƒ†ãƒ 
            if ($user->role_type === 'department_admin') {
                $q->orWhere('owner_department_id', $user->department_id);
            }
            
            // 3. å…¨ç¤¾ç®¡ç†è€…ã®å ´åˆ: å…¨ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ 
            if ($user->role_type === 'company_admin') {
                $q->orWhereNotNull('id');
            }
        });
    
    // è¨­å®šã«å¿œã˜ã¦å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å«ã‚ã‚‹
    if (!$preferences->show_company_calendar_in_trash) {
        $query->where(function($q) {
            $q->where('visibility_type', '!=', 'public')
              ->orWhereNull('visibility_type');
        });
    }
    
    $trashItems = $query->orderBy('deleted_at', 'desc')->get();
    
    return Inertia::render('Trash/Index', [
        'trashItems' => $trashItems,
        'showCompanyItems' => $preferences->show_company_calendar_in_trash,
    ]);
}
```

### ã‚´ãƒŸç®±è¨­å®šUI

```vue
<template>
  <div class="trash-view">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold">ã‚´ãƒŸç®±</h1>
      
      <!-- è¨­å®š -->
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button variant="outline" size="sm">
            <Settings class="h-4 w-4 mr-2" />
            è¡¨ç¤ºè¨­å®š
          </Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent align="end">
          <DropdownMenuLabel>è¡¨ç¤ºã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ </DropdownMenuLabel>
          <DropdownMenuSeparator />
          <DropdownMenuCheckboxItem
            :checked="showCompanyItems"
            @update:checked="toggleCompanyItems"
          >
            å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚‚è¡¨ç¤º
          </DropdownMenuCheckboxItem>
        </DropdownMenuContent>
      </DropdownMenu>
    </div>
    
    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <Tabs v-model="activeFilter">
      <TabsList>
        <TabsTrigger value="all">å…¨ã¦</TabsTrigger>
        <TabsTrigger value="event">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</TabsTrigger>
        <TabsTrigger value="note">ãƒ¡ãƒ¢</TabsTrigger>
        <TabsTrigger value="survey">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</TabsTrigger>
      </TabsList>
    </Tabs>
    
    <!-- ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§ -->
    <div class="space-y-2 mt-4">
      <TrashItemCard
        v-for="item in filteredItems"
        :key="item.id"
        :item="item"
        @restore="handleRestore"
        @delete="handlePermanentDelete"
      />
    </div>
  </div>
</template>

<script setup lang="ts">
const showCompanyItems = ref(props.showCompanyItems)

const toggleCompanyItems = async (checked: boolean) => {
  await axios.post('/api/user/preferences', {
    show_company_calendar_in_trash: checked,
  })
  
  showCompanyItems.value = checked
  router.reload()
}
</script>
```

---

## ä»–éƒ¨ç½²ã«ã¾ãŸãŒã‚‹äºˆå®šã®æ‰±ã„

### å•é¡Œç‚¹ã®ç¢ºèª

ç¾åœ¨ã®`event_participants`ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã‚¤ãƒ™ãƒ³ãƒˆã®å¤šå¯¾å¤šã®é–¢ä¿‚ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ãŒã€**ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨ã‚¤ãƒ™ãƒ³ãƒˆã®é–¢ä¿‚ã¯1å¯¾å¤š**ã§ã™ã€‚

```sql
-- ç¾åœ¨ã®æ§‹é€ 
events:
  - event_id: 1
  - calendar_id: 2 (å–¶æ¥­éƒ¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼)
  - title: "å–¶æ¥­éƒ¨ãƒ»é–‹ç™ºéƒ¨ åˆåŒä¼šè­°"

event_participants:
  - event_id: 1, user_id: 10 (å–¶æ¥­éƒ¨ãƒ¡ãƒ³ãƒãƒ¼)
  - event_id: 1, user_id: 20 (é–‹ç™ºéƒ¨ãƒ¡ãƒ³ãƒãƒ¼)

å•é¡Œ: é–‹ç™ºéƒ¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ã¯è¡¨ç¤ºã•ã‚Œãªã„
```

### è§£æ±ºç­–: å‚åŠ è€…ãƒ™ãƒ¼ã‚¹ã®è¡¨ç¤º

ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ ã›ãšã€**å‚åŠ è€…ãŒã„ã‚Œã°ã€ãã®äººã®éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ã‚‚è¡¨ç¤º**ã™ã‚‹æ–¹å¼ã‚’æ¡ç”¨ã—ã¾ã™ã€‚

```php
// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºæ™‚ã®ã‚¯ã‚¨ãƒª
public function getEventsForCalendar(int $calendarId, User $user)
{
    $calendar = Calendar::findOrFail($calendarId);
    
    $events = Event::with(['creator', 'participants', 'calendar'])
        ->where(function($query) use ($calendar, $user) {
            // 1. ã“ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç›´æ¥ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹äºˆå®š
            $query->where('calendar_id', $calendarId);
            
            // 2. å‚åŠ è€…ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹äºˆå®šï¼ˆä»–éƒ¨ç½²ã®äºˆå®šã‚‚å«ã‚€ï¼‰
            if ($calendar->owner_type === 'department') {
                $query->orWhereHas('participants', function($q) use ($calendar) {
                    $q->whereHas('user', function($subQ) use ($calendar) {
                        $subQ->where('department_id', $calendar->owner_id);
                    });
                });
            }
            
            // 3. å…¨ç¤¾å…¬é–‹ã®äºˆå®š
            $query->orWhere('visibility_type', 'public');
        })
        ->get();
    
    return $events;
}
```

### å…±åŒç·¨é›†ã®å®Ÿè£…

å‚åŠ è€…ã¯å…¨å“¡ç·¨é›†å¯èƒ½ã«ã—ã¾ã™ï¼ˆç¾åœ¨ã®å®Ÿè£…ã‚’æ´»ç”¨ï¼‰ã€‚

```php
// app/Policies/EventPolicy.php
public function update(User $user, Event $event): bool
{
    // 1. ä½œæˆè€…æœ¬äºº
    if ($event->created_by === $user->id) {
        return true;
    }
    
    // 2. å‚åŠ è€…ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ï¼ˆä»–éƒ¨ç½²ã§ã‚‚ç·¨é›†å¯èƒ½ï¼‰
    if ($event->participants->contains($user->id)) {
        return true;
    }
    
    // 3. éƒ¨ç½²ç®¡ç†è€…ï¼ˆåŒã˜éƒ¨ç½²ã®ã¿ï¼‰
    if ($user->role_type === 'department_admin' 
        && $event->owner_department_id === $user->department_id) {
        return true;
    }
    
    return false;
}
```

### é–“é•ãˆã¦ä½œæˆã—ãŸå ´åˆã®å¯¾å¿œ

å‚åŠ è€…ã‚’è¿½åŠ ã™ã‚Œã°ã€ãã®äººã‚‚ç·¨é›†å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

```vue
<template>
  <Dialog v-model:open="showEditParticipants">
    <DialogContent>
      <DialogHeader>
        <DialogTitle>å‚åŠ è€…ã‚’è¿½åŠ </DialogTitle>
        <DialogDescription>
          å‚åŠ è€…ã‚’è¿½åŠ ã™ã‚‹ã¨ã€ãã®äººã‚‚äºˆå®šã‚’ç·¨é›†ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™
        </DialogDescription>
      </DialogHeader>
      
      <!-- ä»–éƒ¨ç½²ãƒ¡ãƒ³ãƒãƒ¼ã‚‚æ¤œç´¢å¯èƒ½ -->
      <UserSearch
        v-model="selectedUsers"
        :exclude="currentParticipants"
        placeholder="åå‰ã¾ãŸã¯éƒ¨ç½²åã§æ¤œç´¢..."
      />
      
      <DialogFooter>
        <Button @click="addParticipants">è¿½åŠ </Button>
      </DialogFooter>
    </DialogContent>
  </Dialog>
</template>
```


---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¯¾ç­–

### N+1å•é¡Œã®é˜²æ­¢

#### å•é¡Œã®ä¾‹

```php
// æ‚ªã„ä¾‹
$events = Event::where('visibility_type', 'public')->get();

foreach ($events as $event) {
    echo $event->creator->name;  // Nå›ã®ã‚¯ã‚¨ãƒª
    echo $event->participants->count();  // Nå›ã®ã‚¯ã‚¨ãƒª
}
// åˆè¨ˆ: 1 + N + N = 2N + 1 å›ã®ã‚¯ã‚¨ãƒª
```

#### è§£æ±ºç­–: Eager Loading

```php
// è‰¯ã„ä¾‹
$events = Event::with(['creator', 'participants', 'calendar'])
    ->where('visibility_type', 'public')
    ->get();

foreach ($events as $event) {
    echo $event->creator->name;  // ã‚¯ã‚¨ãƒªãªã—
    echo $event->participants->count();  // ã‚¯ã‚¨ãƒªãªã—
}
// åˆè¨ˆ: 3å›ã®ã‚¯ã‚¨ãƒª
```

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¿½åŠ 

```sql
-- events ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE INDEX idx_events_visibility_dept ON events(visibility_type, owner_department_id);
CREATE INDEX idx_events_created_by ON events(created_by);
CREATE INDEX idx_events_dates ON events(start_date, end_date);
CREATE INDEX idx_events_calendar ON events(calendar_id);

-- event_participants ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE INDEX idx_participants_user ON event_participants(user_id);
CREATE INDEX idx_participants_event ON event_participants(event_id);

-- shared_notes ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE INDEX idx_notes_visibility_dept ON shared_notes(visibility_type, owner_department_id);
CREATE INDEX idx_notes_author ON shared_notes(author_id);
CREATE INDEX idx_notes_deleted ON shared_notes(is_deleted);

-- shared_note_participants ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE INDEX idx_note_participants_user ON shared_note_participants(user_id);
CREATE INDEX idx_note_participants_note ON shared_note_participants(note_id);

-- surveys ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE INDEX idx_surveys_visibility_dept ON surveys(visibility_type, owner_department_id);
CREATE INDEX idx_surveys_created_by ON surveys(created_by);
CREATE INDEX idx_surveys_active ON surveys(is_active, is_deleted);

-- survey_respondents ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE INDEX idx_respondents_user ON survey_respondents(user_id);
CREATE INDEX idx_respondents_survey ON survey_respondents(survey_id);

-- trash_items ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE INDEX idx_trash_user ON trash_items(user_id);
CREATE INDEX idx_trash_department ON trash_items(owner_department_id);
CREATE INDEX idx_trash_type ON trash_items(item_type);

-- users ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE INDEX idx_users_department ON users(department_id);
CREATE INDEX idx_users_role_type ON users(role_type);
CREATE INDEX idx_users_active ON users(is_active);

-- departments ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE INDEX idx_departments_active ON departments(is_active);
```

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

```php
// app/Services/CacheService.php
class CacheService
{
    /**
     * éƒ¨ç½²ã®å…¬é–‹äºˆå®šã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
     */
    public function getDepartmentPublicEvents(int $departmentId, string $start, string $end)
    {
        $cacheKey = "dept_{$departmentId}_public_events_{$start}_{$end}";
        
        return Cache::remember($cacheKey, now()->addMinutes(10), function() use ($departmentId, $start, $end) {
            return Event::with(['creator', 'participants'])
                ->where(function($q) use ($departmentId) {
                    $q->where('visibility_type', 'public')
                      ->orWhere(function($subQ) use ($departmentId) {
                          $subQ->where('visibility_type', 'department')
                               ->where('owner_department_id', $departmentId);
                      });
                })
                ->whereBetween('start_date', [$start, $end])
                ->get();
        });
    }
    
    /**
     * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
     */
    public function clearDepartmentCache(int $departmentId)
    {
        // éƒ¨ç½²é–¢é€£ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å…¨ã¦ã‚¯ãƒªã‚¢
        Cache::tags(["department_{$departmentId}"])->flush();
    }
}

// ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆãƒ»æ›´æ–°æ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
public function store(StoreEventRequest $request)
{
    $event = $this->eventService->createEvent($request->validated());
    
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
    app(CacheService::class)->clearDepartmentCache($event->owner_department_id);
    
    return redirect()->back();
}
```

### ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–

```php
// è¤‡é›‘ãªã‚¯ã‚¨ãƒªã‚’æœ€é©åŒ–
public function getEventsApi(Request $request)
{
    $user = auth()->user();
    
    // ã‚µãƒ–ã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨ã—ã¦åŠ¹ç‡åŒ–
    $events = Event::with(['creator:id,name', 'participants:id,name', 'calendar:calendar_id,calendar_name'])
        ->where(function($query) use ($user) {
            $query
                ->where('visibility_type', 'public')
                ->orWhere(function($q) use ($user) {
                    $q->where('visibility_type', 'department')
                      ->where('owner_department_id', $user->department_id);
                })
                ->orWhere('created_by', $user->id)
                ->orWhereHas('participants', function($q) use ($user) {
                    $q->where('user_id', $user->id);
                });
        })
        ->whereBetween('start_date', [$request->start, $request->end])
        ->get();
    
    return response()->json($events);
}
```

---

## UI/UXè¨­è¨ˆ

### ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¸æŠã®ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

```vue
<template>
  <form @submit.prevent="handleSubmit">
    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¸æŠ -->
    <div class="space-y-2">
      <Label>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é¸æŠ</Label>
      <RadioGroup v-model="form.calendar_id">
        <!-- è‡ªåˆ†ã®éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ -->
        <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
          <RadioGroupItem :value="userDepartmentCalendar.calendar_id" id="dept-calendar" />
          <Label for="dept-calendar" class="flex-1 cursor-pointer">
            <div class="flex items-center gap-2">
              <Building class="h-4 w-4 text-blue-600" />
              <span class="font-medium">{{ userDepartmentCalendar.calendar_name }}</span>
            </div>
            <div class="text-sm text-gray-500 mt-1">
              é€šå¸¸ã®æ¥­å‹™äºˆå®šã€ä¼šè­°ãªã©ã¯ã“ã¡ã‚‰
            </div>
          </Label>
        </div>
        
        <!-- å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
        <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
          <RadioGroupItem :value="companyCalendar.calendar_id" id="company-calendar" />
          <Label for="company-calendar" class="flex-1 cursor-pointer">
            <div class="flex items-center gap-2">
              <Globe class="h-4 w-4 text-green-600" />
              <span class="font-medium">{{ companyCalendar.calendar_name }}</span>
            </div>
            <div class="text-sm text-gray-500 mt-1">
              å…¨ä½“é€£çµ¡ã€ä¼šç¤¾è¡Œäº‹ã€ä¼‘æ—¥ã®ã¿
            </div>
          </Label>
        </div>
      </RadioGroup>
      
      <!-- å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¸æŠæ™‚ã®æ³¨æ„ -->
      <Alert v-if="form.calendar_id === companyCalendar.calendar_id" variant="warning">
        <AlertCircle class="h-4 w-4" />
        <AlertTitle>å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ã¤ã„ã¦</AlertTitle>
        <AlertDescription>
          å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯å…¨å“¡ãŒé–²è¦§ã—ã¾ã™ã€‚å…¨ä½“é€£çµ¡ã‚„ä¼šç¤¾è¡Œäº‹ã®ã¿ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
        </AlertDescription>
      </Alert>
    </div>
    
    <!-- å…¬é–‹ç¯„å›²ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«å¿œã˜ã¦è‡ªå‹•è¨­å®šï¼‰ -->
    <div v-if="form.calendar_id === userDepartmentCalendar.calendar_id" class="space-y-2">
      <Label>å…¬é–‹ç¯„å›²</Label>
      <RadioGroup v-model="form.visibility_type">
        <div class="space-y-2">
          <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
            <RadioGroupItem value="department" id="dept-visibility" />
            <Label for="dept-visibility" class="flex-1 cursor-pointer">
              <div class="font-medium">éƒ¨ç½²å†…ã®ã¿</div>
              <div class="text-sm text-gray-500">
                {{ user.department.name }}ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿é–²è¦§å¯èƒ½
              </div>
            </Label>
          </div>
          
          <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
            <RadioGroupItem value="custom" id="custom-visibility" />
            <Label for="custom-visibility" class="flex-1 cursor-pointer">
              <div class="font-medium">ç‰¹å®šã®ãƒ¡ãƒ³ãƒãƒ¼</div>
              <div class="text-sm text-gray-500">
                å‚åŠ è€…ã¨ã—ã¦é¸æŠã—ãŸãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ï¼ˆä»–éƒ¨ç½²ã‚‚é¸æŠå¯èƒ½ï¼‰
              </div>
            </Label>
          </div>
          
          <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
            <RadioGroupItem value="private" id="private-visibility" />
            <Label for="private-visibility" class="flex-1 cursor-pointer">
              <div class="font-medium">éå…¬é–‹</div>
              <div class="text-sm text-gray-500">
                è‡ªåˆ†ã®ã¿é–²è¦§å¯èƒ½ï¼ˆä»–ã®äººã«ã¯ã€Œéè¡¨ç¤ºã€ã¨è¡¨ç¤ºï¼‰
              </div>
            </Label>
          </div>
        </div>
      </RadioGroup>
    </div>
    
    <!-- å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å ´åˆã¯è‡ªå‹•çš„ã« public -->
    <input v-else type="hidden" v-model="form.visibility_type" value="public" />
    
    <!-- å‚åŠ è€…é¸æŠï¼ˆcustom ã®å ´åˆã®ã¿ï¼‰ -->
    <div v-if="form.visibility_type === 'custom'" class="space-y-2">
      <Label>å‚åŠ è€…ã‚’é¸æŠ</Label>
      <UserSearchAndSelect
        v-model="form.participants"
        :allow-other-departments="true"
      />
    </div>
  </form>
</template>

<script setup lang="ts">
const form = ref({
  calendar_id: props.userDepartmentCalendar.calendar_id,  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
  visibility_type: 'department',  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯éƒ¨ç½²å†…å…¬é–‹
  participants: [],
  // ...
})

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å¤‰æ›´æ™‚ã«å…¬é–‹ç¯„å›²ã‚’è‡ªå‹•è¨­å®š
watch(() => form.value.calendar_id, (newCalendarId) => {
  if (newCalendarId === props.companyCalendar.calendar_id) {
    form.value.visibility_type = 'public'
  } else {
    form.value.visibility_type = 'department'
  }
})
</script>
```

### ãƒ˜ãƒ«ãƒ—ã¨ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹

```vue
<template>
  <div class="help-section">
    <Collapsible>
      <CollapsibleTrigger class="flex items-center gap-2 text-sm text-blue-600 hover:text-blue-700">
        <HelpCircle class="h-4 w-4" />
        ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨å…¬é–‹ç¯„å›²ã®ä½¿ã„åˆ†ã‘ã«ã¤ã„ã¦
      </CollapsibleTrigger>
      <CollapsibleContent class="mt-2 p-4 bg-blue-50 rounded-lg space-y-3">
        <div>
          <h4 class="font-medium text-sm mb-1">ğŸ“… éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h4>
          <p class="text-sm text-gray-600">
            é€šå¸¸ã®æ¥­å‹™äºˆå®šã€ä¼šè­°ã€ã‚¿ã‚¹ã‚¯ãªã©ã‚’ç™»éŒ²ã—ã¾ã™ã€‚
          </p>
        </div>
        
        <div>
          <h4 class="font-medium text-sm mb-1">ğŸŒ å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h4>
          <p class="text-sm text-gray-600">
            å…¨ä½“é€£çµ¡ã€ä¼šç¤¾è¡Œäº‹ã€ä¼‘æ—¥ãªã©ã€å…¨å“¡ã«çŸ¥ã‚‰ã›ãŸã„äºˆå®šã®ã¿ç™»éŒ²ã—ã¾ã™ã€‚
          </p>
        </div>
        
        <Separator />
        
        <div>
          <h4 class="font-medium text-sm mb-2">å…¬é–‹ç¯„å›²ã®é¸ã³æ–¹</h4>
          <ul class="space-y-2 text-sm text-gray-600">
            <li class="flex items-start gap-2">
              <Badge variant="outline" class="mt-0.5">éƒ¨ç½²å†…</Badge>
              <span>éƒ¨ç½²ã®ãƒ¡ãƒ³ãƒãƒ¼å…¨å“¡ãŒé–²è¦§ã§ãã¾ã™</span>
            </li>
            <li class="flex items-start gap-2">
              <Badge variant="outline" class="mt-0.5">ç‰¹å®šã®ãƒ¡ãƒ³ãƒãƒ¼</Badge>
              <span>é¸æŠã—ãŸãƒ¡ãƒ³ãƒãƒ¼ã®ã¿é–²è¦§ã§ãã¾ã™ï¼ˆä»–éƒ¨ç½²ã‚‚é¸æŠå¯èƒ½ï¼‰</span>
            </li>
            <li class="flex items-start gap-2">
              <Badge variant="outline" class="mt-0.5">éå…¬é–‹</Badge>
              <span>è‡ªåˆ†ã®ã¿é–²è¦§ã§ãã¾ã™ï¼ˆä»–ã®äººã«ã¯ã€Œéè¡¨ç¤ºã€ã¨è¡¨ç¤ºã•ã‚Œã€ç©ºãæ™‚é–“ã®ã¿ã‚ã‹ã‚Šã¾ã™ï¼‰</span>
            </li>
          </ul>
        </div>
      </CollapsibleContent>
    </Collapsible>
  </div>
</template>
```

---

## å®Ÿè£…ã®å„ªå…ˆé †ä½

### ãƒ•ã‚§ãƒ¼ã‚º1: åŸºç›¤æ•´å‚™ï¼ˆ1.5ãƒ¶æœˆï¼‰

**ç›®æ¨™**: éƒ¨ç½²ç®¡ç†ã®åŸºç›¤ã‚’æ§‹ç¯‰

1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¤‰æ›´**
   - `departments`ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
   - `users.department_id`è¿½åŠ 
   - `users.role_type`è¿½åŠ 

2. **éƒ¨ç½²ãƒã‚¹ã‚¿ç®¡ç†ç”»é¢**
   - éƒ¨ç½²ã®ä½œæˆãƒ»ç·¨é›†ãƒ»ç„¡åŠ¹åŒ–
   - éƒ¨ç½²ç®¡ç†è€…ã®è¨­å®š

3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ç”»é¢ã®æ›´æ–°**
   - éƒ¨ç½²é¸æŠï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ï¼‰
   - å½¹å‰²é¸æŠï¼ˆmember/department_admin/company_adminï¼‰

4. **Observerå®Ÿè£…**
   - `DepartmentObserver`ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è‡ªå‹•ç”Ÿæˆï¼‰

5. **æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œ**
   - ç§»è¡Œã‚³ãƒãƒ³ãƒ‰ã®ä½œæˆ
   - ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã®æ¤œè¨¼
   - æœ¬ç•ªç’°å¢ƒã§ã®å®Ÿè¡Œ

**æˆæœç‰©**:
- éƒ¨ç½²ãƒã‚¹ã‚¿ãŒç¨¼åƒ
- æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒéƒ¨ç½²ã«ç´ä»˜ã‘
- éƒ¨ç½²ã”ã¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒè‡ªå‹•ç”Ÿæˆ

### ãƒ•ã‚§ãƒ¼ã‚º2: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ‹¡å¼µï¼ˆ2ãƒ¶æœˆï¼‰

**ç›®æ¨™**: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®éƒ¨ç½²å¯¾å¿œ

1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¤‰æ›´**
   - `calendars`ã«`owner_type`, `owner_id`è¿½åŠ 
   - `events`ã«`visibility_type`, `owner_department_id`è¿½åŠ 

2. **æ¨©é™ç®¡ç†**
   - `EventPolicy`ã®å®Ÿè£…
   - æ¨©é™ãƒã‚§ãƒƒã‚¯ã®è¿½åŠ 

3. **ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯**
   - çµ±åˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼
   - ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
   - å…¬é–‹ç¯„å›²ã«å¿œã˜ãŸé–²è¦§åˆ¶å¾¡

4. **ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆãƒ»ç·¨é›†UI**
   - ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¸æŠ
   - å…¬é–‹ç¯„å›²é¸æŠ
   - ä»–éƒ¨ç½²ãƒ¡ãƒ³ãƒãƒ¼æ¤œç´¢

5. **éƒ¨ç½²ç•°å‹•å‡¦ç†**
   - `UserDepartmentTransferService`å®Ÿè£…
   - ç•°å‹•æ™‚ã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°

**æˆæœç‰©**:
- éƒ¨ç½²ã”ã¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒæ©Ÿèƒ½
- å…¬é–‹ç¯„å›²åˆ¶å¾¡ãŒå‹•ä½œ
- éƒ¨ç½²ç•°å‹•ãŒæ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹

### ãƒ•ã‚§ãƒ¼ã‚º3: ãƒ¡ãƒ¢ãƒ»ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ‹¡å¼µï¼ˆ1ãƒ¶æœˆï¼‰

**ç›®æ¨™**: å…±æœ‰ãƒ¡ãƒ¢ã¨ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®éƒ¨ç½²å¯¾å¿œ

1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¤‰æ›´**
   - `shared_notes`ã«`visibility_type`, `owner_department_id`è¿½åŠ 
   - `surveys`ã«`visibility_type`, `owner_department_id`è¿½åŠ 

2. **æ¨©é™ç®¡ç†**
   - `SharedNotePolicy`, `SurveyPolicy`ã®å®Ÿè£…

3. **è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯**
   - ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
   - å…¬é–‹ç¯„å›²ã«å¿œã˜ãŸé–²è¦§åˆ¶å¾¡

4. **UIæ›´æ–°**
   - å…¬é–‹ç¯„å›²é¸æŠ
   - ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¿ãƒ–

**æˆæœç‰©**:
- å…±æœ‰ãƒ¡ãƒ¢ã®éƒ¨ç½²å¯¾å¿œå®Œäº†
- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®éƒ¨ç½²å¯¾å¿œå®Œäº†

### ãƒ•ã‚§ãƒ¼ã‚º4: ã‚´ãƒŸç®±ãƒ»æœ€é©åŒ–ï¼ˆ1ãƒ¶æœˆï¼‰

**ç›®æ¨™**: ã‚´ãƒŸç®±ã®éƒ¨ç½²ç®¡ç†ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

1. **ã‚´ãƒŸç®±ã®éƒ¨ç½²ç®¡ç†**
   - `trash_items`ã«éƒ¨ç½²æƒ…å ±è¿½åŠ 
   - è¡¨ç¤ºè¨­å®šã®å®Ÿè£…

2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**
   - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¿½åŠ 
   - Eager Loadingã®é©ç”¨
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å®Ÿè£…

3. **ãƒ†ã‚¹ãƒˆã¨ãƒã‚°ä¿®æ­£**
   - çµ±åˆãƒ†ã‚¹ãƒˆ
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
   - ãƒã‚°ä¿®æ­£

**æˆæœç‰©**:
- ã‚´ãƒŸç®±ã®éƒ¨ç½²ç®¡ç†å®Œäº†
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„
- å®‰å®šç¨¼åƒ

**åˆè¨ˆé–‹ç™ºæœŸé–“: 5.5ãƒ¶æœˆ**

---

## æ‡¸å¿µäº‹é …ã¨å¯¾å¿œç­–

### 1. éƒ¨ç½²ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®åˆæœŸè¨­å®š

**è¦ä»¶**: å„éƒ¨ç½²ã«å¿…ãšéƒ¨ç½²ç®¡ç†è€…ã‚’è¨­å®š

**å¯¾å¿œç­–**:
```php
// éƒ¨ç½²ä½œæˆæ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
public function store(StoreDepartmentRequest $request)
{
    $validated = $request->validate([
        'name' => 'required|unique:departments',
        'admin_user_id' => 'required|exists:users,id',
    ]);
    
    DB::transaction(function() use ($validated) {
        $department = Department::create([
            'name' => $validated['name'],
        ]);
        
        // ç®¡ç†è€…ã‚’è¨­å®š
        User::find($validated['admin_user_id'])->update([
            'department_id' => $department->id,
            'role_type' => 'department_admin',
        ]);
    });
}
```

### 2. å…¨ç¤¾ç®¡ç†è€…ã®æ¨©é™ç¯„å›²

**è¦ä»¶**: å…¨ç¤¾ç®¡ç†è€…ã¯å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã¿ç·¨é›†å¯èƒ½ã€éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯ç·¨é›†ä¸å¯

**ç†ç”±**: éƒ¨ç½²ã®è‡ªå¾‹æ€§ã‚’å°Šé‡

**å¯¾å¿œç­–**:
```php
public function update(User $user, Event $event): bool
{
    $calendar = $event->calendar;
    
    // å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å ´åˆ
    if ($calendar->owner_type === 'company') {
        return $user->role_type === 'company_admin';
    }
    
    // éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å ´åˆ
    // å…¨ç¤¾ç®¡ç†è€…ã§ã‚‚ç·¨é›†ä¸å¯
    if ($user->role_type === 'company_admin') {
        return false;
    }
    
    // é€šå¸¸ã®æ¨©é™ãƒã‚§ãƒƒã‚¯
    return $this->normalCanEdit($user, $event);
}
```

### 3. éƒ¨ç½²ã®ç„¡åŠ¹åŒ–æ™‚ã®æ‰±ã„

**è¦ä»¶**: ç„¡åŠ¹åŒ–ã•ã‚ŒãŸéƒ¨ç½²ã®ãƒ‡ãƒ¼ã‚¿ã¯é–²è¦§ã®ã¿å¯èƒ½

**å¯¾å¿œç­–**:
```php
public function canEdit(User $user, Event $event): bool
{
    $department = Department::find($event->owner_department_id);
    
    // ç„¡åŠ¹åŒ–ã•ã‚ŒãŸéƒ¨ç½²ã®äºˆå®šã¯ç·¨é›†ä¸å¯
    if (!$department || !$department->is_active) {
        // å…¨ç¤¾ç®¡ç†è€…ã®ã¿ä¾‹å¤–çš„ã«ç·¨é›†å¯èƒ½
        return $user->role_type === 'company_admin';
    }
    
    // é€šå¸¸ã®æ¨©é™ãƒã‚§ãƒƒã‚¯
    return $this->normalCanEdit($user, $event);
}

// é–²è¦§ã¯å¯èƒ½
public function view(User $user, Event $event): bool
{
    // ç„¡åŠ¹åŒ–ã•ã‚ŒãŸéƒ¨ç½²ã§ã‚‚é–²è¦§ã¯å¯èƒ½
    return $this->normalCanView($user, $event);
}
```

### 4. ç¹°ã‚Šè¿”ã—äºˆå®šã®éƒ¨ç½²ç•°å‹•æ™‚ã®æ‰±ã„

**è¦ä»¶**: ç¹°ã‚Šè¿”ã—äºˆå®šã¯å…ƒã®éƒ¨ç½²ã«æ®‹ã™

**ç†ç”±**: éƒ¨ç½²ã®å®šä¾‹ä¼šè­°ãªã©ã¯éƒ¨ç½²ã«ç´ä»˜ããŸã‚

**å¯¾å¿œç­–**:
```php
private function keepRecurringEvents(User $user, int $oldDepartmentId): void
{
    $departmentAdmin = $this->getDepartmentAdmin($oldDepartmentId);
    
    // ç¹°ã‚Šè¿”ã—äºˆå®šã¯å…¨ã¦å…ƒã®éƒ¨ç½²ã«æ®‹ã—ã€æ‰€æœ‰æ¨©ã‚’éƒ¨ç½²ç®¡ç†è€…ã«ç§»è­²
    Event::where('created_by', $user->id)
        ->where('owner_department_id', $oldDepartmentId)
        ->whereHas('recurrence')
        ->update(['created_by' => $departmentAdmin->id]);
}
```

### 5. ã‚´ãƒŸç®±ã®è¡¨ç¤ºè¨­å®š

**è¦ä»¶**: éƒ¨ç½²å†…ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ã¿è¡¨ç¤ºã€è¨­å®šã§å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚‚å«ã‚ã‚‹ã‹é¸æŠå¯èƒ½

**å¯¾å¿œç­–**:
```php
// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: éƒ¨ç½²å†…ã®ã¿
$query->where('owner_department_id', $user->department_id);

// è¨­å®šã§å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚‚å«ã‚ã‚‹
if ($preferences->show_company_calendar_in_trash) {
    $query->orWhere('visibility_type', 'public');
}
```

### 6. ä»–éƒ¨ç½²ã«ã¾ãŸãŒã‚‹äºˆå®š

**è¦ä»¶**: å‚åŠ è€…ãŒã„ã‚Œã°ã€ãã®äººã®éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ã‚‚è¡¨ç¤º

**å¯¾å¿œç­–**:
```php
// å‚åŠ è€…ãƒ™ãƒ¼ã‚¹ã®è¡¨ç¤ºï¼ˆä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«ä¸è¦ï¼‰
$query->orWhereHas('participants', function($q) use ($calendar) {
    $q->whereHas('user', function($subQ) use ($calendar) {
        $subQ->where('department_id', $calendar->owner_id);
    });
});
```

### 7. ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ä¿è¨¼

**æ‡¸å¿µ**: éƒ¨ç½²å‰Šé™¤æ™‚ã«é–¢é€£ãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã‚‹

**å¯¾å¿œç­–**:
```php
// éƒ¨ç½²å‰Šé™¤å‰ã®ãƒã‚§ãƒƒã‚¯
public function destroy(Department $department)
{
    $eventCount = Event::where('owner_department_id', $department->id)->count();
    $noteCount = SharedNote::where('owner_department_id', $department->id)->count();
    $surveyCount = Survey::where('owner_department_id', $department->id)->count();
    $userCount = User::where('department_id', $department->id)->count();
    
    if ($eventCount > 0 || $noteCount > 0 || $surveyCount > 0 || $userCount > 0) {
        throw ValidationException::withMessages([
            'department' => "ã“ã®éƒ¨ç½²ã«ã¯äºˆå®š{$eventCount}ä»¶ã€ãƒ¡ãƒ¢{$noteCount}ä»¶ã€ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ{$surveyCount}ä»¶ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼{$userCount}äººãŒå­˜åœ¨ã—ã¾ã™ã€‚å…ˆã«ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã¾ãŸã¯ç§»å‹•ã—ã¦ãã ã•ã„ã€‚"
        ]);
    }
    
    $department->delete();
}
```

### 8. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®åŠ£åŒ–

**æ‡¸å¿µ**: è¤‡é›‘ãªã‚¯ã‚¨ãƒªã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒä½ä¸‹

**å¯¾å¿œç­–**:
- é©åˆ‡ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¿½åŠ 
- Eager Loadingã®å¾¹åº•
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ´»ç”¨
- ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–

### 9. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ··ä¹±

**æ‡¸å¿µ**: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚„å…¬é–‹ç¯„å›²ã®é¸æŠã§æ··ä¹±

**å¯¾å¿œç­–**:
- ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®š
- ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆã®å……å®Ÿ
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ˜ç¢ºåŒ–
- æ®µéšçš„ãªãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ

---

## ã¾ã¨ã‚

### å®Ÿç¾å¯èƒ½æ€§

âœ… **æŠ€è¡“çš„ã«å®Ÿç¾å¯èƒ½**
- æ—¢å­˜ã®å®Ÿè£…ã‚’æ´»ã‹ã—ã¤ã¤æ‹¡å¼µ
- LINE WORKSã®ä»•æ§˜ã‚’å‚è€ƒã«ã—ãŸè¨­è¨ˆ
- æ®µéšçš„ãªå®Ÿè£…ãŒå¯èƒ½

### é–‹ç™ºæœŸé–“

**åˆè¨ˆ: 5.5ãƒ¶æœˆ**
- ãƒ•ã‚§ãƒ¼ã‚º1: åŸºç›¤æ•´å‚™ï¼ˆ1.5ãƒ¶æœˆï¼‰
- ãƒ•ã‚§ãƒ¼ã‚º2: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ‹¡å¼µï¼ˆ2ãƒ¶æœˆï¼‰
- ãƒ•ã‚§ãƒ¼ã‚º3: ãƒ¡ãƒ¢ãƒ»ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ‹¡å¼µï¼ˆ1ãƒ¶æœˆï¼‰
- ãƒ•ã‚§ãƒ¼ã‚º4: ã‚´ãƒŸç®±ãƒ»æœ€é©åŒ–ï¼ˆ1ãƒ¶æœˆï¼‰

### ä¸»è¦ãªå¤‰æ›´ç‚¹

1. **éƒ¨ç½²ãƒã‚¹ã‚¿ã®è¿½åŠ **: ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†ã«ã‚ˆã‚‹æ­£ç¢ºãªéƒ¨ç½²ç®¡ç†
2. **ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ‰€æœ‰è€…æ¦‚å¿µ**: éƒ¨ç½²ã”ã¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
3. **å…¬é–‹ç¯„å›²åˆ¶å¾¡**: public/department/custom/private ã®4æ®µéš
4. **æ¨©é™ç®¡ç†**: member/department_admin/company_admin ã®3æ®µéš
5. **éƒ¨ç½²ç•°å‹•å‡¦ç†**: éå»ãƒ»æœªæ¥ãƒ»ç¹°ã‚Šè¿”ã—äºˆå®šã®é©åˆ‡ãªå‡¦ç†
6. **ã‚´ãƒŸç®±ã®éƒ¨ç½²ç®¡ç†**: éƒ¨ç½²å˜ä½ã§ã®ç®¡ç†

### æ³¨æ„äº‹é …

1. **éƒ¨ç½²ç®¡ç†è€…ã¯å¿…é ˆ**: å„éƒ¨ç½²ã«å¿…ãšè¨­å®š
2. **å…¨ç¤¾ç®¡ç†è€…ã®æ¨©é™**: å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã¿ç·¨é›†å¯èƒ½
3. **éƒ¨ç½²ç„¡åŠ¹åŒ–**: é–²è¦§ã®ã¿å¯èƒ½
4. **ç¹°ã‚Šè¿”ã—äºˆå®š**: å…ƒã®éƒ¨ç½²ã«æ®‹ã™
5. **ã‚´ãƒŸç®±**: éƒ¨ç½²å†…ã®ã¿è¡¨ç¤ºï¼ˆè¨­å®šã§å¤‰æ›´å¯èƒ½ï¼‰
6. **ä»–éƒ¨ç½²ã«ã¾ãŸãŒã‚‹äºˆå®š**: å‚åŠ è€…ãƒ™ãƒ¼ã‚¹ã§è¡¨ç¤º
7. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§å¯¾å¿œ

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **è¦ä»¶ã®æœ€çµ‚ç¢ºèª**: é‹ç”¨æ–¹é‡ã®ç¢ºèª
2. **ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã®æ¤œè¨¼**: ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ†ã‚¹ãƒˆ
3. **æ®µéšçš„ãªå®Ÿè£…**: ãƒ•ã‚§ãƒ¼ã‚º1ã‹ã‚‰é †æ¬¡å®Ÿè£…
4. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°**: æ–°æ©Ÿèƒ½ã®èª¬æ˜ã¨ç ”ä¿®

---

**ä½œæˆæ—¥**: 2025å¹´1æœˆ
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: è¦ä»¶å®šç¾©å®Œäº†


### 10. éƒ¨ç½²åå¤‰æ›´æ™‚ã®å½±éŸ¿

**è¦ä»¶**: éƒ¨ç½²åãŒå¤‰æ›´ã•ã‚Œã¦ã‚‚ã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã€æ–°ã—ã„åå‰ã§è¡¨ç¤ºã•ã‚Œã‚‹

**å¯¾å¿œç­–**:
```php
// DepartmentObserver ã§å®Ÿè£…æ¸ˆã¿
public function updated(Department $department)
{
    if ($department->isDirty('name')) {
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åã‚‚è‡ªå‹•æ›´æ–°
        Calendar::where('owner_type', 'department')
            ->where('owner_id', $department->id)
            ->update([
                'calendar_name' => $department->name . 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼'
            ]);
    }
}
```

**å‹•ä½œ**:
- éƒ¨ç½²åå¤‰æ›´ â†’ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åã‚‚è‡ªå‹•æ›´æ–°
- æ—¢å­˜ã®äºˆå®šãƒ»ãƒ¡ãƒ¢ãƒ»ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¯æ–°ã—ã„éƒ¨ç½²åã§è¡¨ç¤º
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸Šã¯`department_id`ã§ç´ä»˜ã„ã¦ã„ã‚‹ãŸã‚ã€åå‰å¤‰æ›´ã®å½±éŸ¿ãªã—

### 11. å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¸ã®æŠ•ç¨¿æ¨©é™

**è¦ä»¶**: å…¨ç¤¾ç®¡ç†è€…ã¨éƒ¨ç½²ç®¡ç†è€…ãŒå…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«æŠ•ç¨¿å¯èƒ½

**å¯¾å¿œç­–**:
```php
// EventPolicy
public function create(User $user, Calendar $calendar): bool
{
    // å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å ´åˆ
    if ($calendar->owner_type === 'company') {
        // å…¨ç¤¾ç®¡ç†è€…ã¾ãŸã¯éƒ¨ç½²ç®¡ç†è€…
        return in_array($user->role_type, ['company_admin', 'department_admin']);
    }
    
    // éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å ´åˆ
    return $user->department_id === $calendar->owner_id;
}
```

### 12. é€€è·è€…ã®ãƒ‡ãƒ¼ã‚¿æ‰±ã„

**è¦ä»¶**: 
- é€€è·è€…ãŒä½œæˆã—ãŸãƒ‡ãƒ¼ã‚¿ã¯éƒ¨ç½²ç®¡ç†è€…ã«æ‰€æœ‰æ¨©ã‚’ç§»è­²
- æœªæ¥ã®äºˆå®šã‹ã‚‰å‚åŠ è€…ã¨ã—ã¦è‡ªå‹•é™¤å¤–

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆï¼ˆå‚åŠ è€…è‡ªå‹•é™¤å¤–ï¼‰**:
1. **å±¥æ­´ã®å–ªå¤±**: ã€Œèª°ãŒå‚åŠ äºˆå®šã ã£ãŸã‹ã€ã®è¨˜éŒ²ãŒå¤±ã‚ã‚Œã‚‹
2. **é€šçŸ¥ã®å•é¡Œ**: é™¤å¤–ã•ã‚ŒãŸäº‹å®ŸãŒä»–ã®å‚åŠ è€…ã«é€šçŸ¥ã•ã‚Œãªã„å¯èƒ½æ€§
3. **å¾©å¸°æ™‚ã®å•é¡Œ**: ä¸€æ™‚çš„ãªä¼‘è·ã®å ´åˆã€å¾©å¸°æ™‚ã«å†ç™»éŒ²ãŒå¿…è¦

**æ¨å¥¨å¯¾å¿œ**:
```php
public function deactivateUser(User $user, string $reason)
{
    DB::transaction(function() use ($user, $reason) {
        // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç„¡åŠ¹åŒ–
        $user->update([
            'is_active' => false,
            'deactivated_at' => now(),
            'reason' => $reason,
        ]);
        
        // 2. æœªæ¥ã®äºˆå®šã®æ‰€æœ‰æ¨©ã‚’éƒ¨ç½²ç®¡ç†è€…ã«ç§»è­²
        $departmentAdmin = $this->getDepartmentAdmin($user->department_id);
        
        Event::where('created_by', $user->id)
            ->where('start_date', '>=', now())
            ->update(['created_by' => $departmentAdmin->id]);
        
        SharedNote::where('author_id', $user->id)
            ->update(['author_id' => $departmentAdmin->id]);
        
        Survey::where('created_by', $user->id)
            ->where('is_active', true)
            ->update(['created_by' => $departmentAdmin->id]);
        
        // 3. æœªæ¥ã®äºˆå®šã‹ã‚‰å‚åŠ è€…ã¨ã—ã¦é™¤å¤–
        DB::table('event_participants')
            ->where('user_id', $user->id)
            ->whereIn('event_id', function($query) {
                $query->select('event_id')
                      ->from('events')
                      ->where('start_date', '>=', now());
            })
            ->delete();
        
        // 4. ãƒ­ã‚°ã‚’è¨˜éŒ²
        UserLog::create([
            'user_id' => $user->id,
            'action' => 'deactivated',
            'details' => json_encode([
                'reason' => $reason,
                'transferred_events' => Event::where('created_by', $departmentAdmin->id)->count(),
            ]),
            'changed_by' => auth()->id(),
        ]);
    });
}
```

**ä»£æ›¿æ¡ˆ**: å‚åŠ è€…ã¨ã—ã¦æ®‹ã™ãŒã€è¡¨ç¤ºæ™‚ã«ã€Œé€€è·æ¸ˆã¿ã€ã¨è¡¨ç¤º
```php
// ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤ºæ™‚
$participants = $event->participants->map(function($user) {
    return [
        'id' => $user->id,
        'name' => $user->name,
        'is_active' => $user->is_active,
        'display_name' => $user->is_active ? $user->name : $user->name . 'ï¼ˆé€€è·æ¸ˆã¿ï¼‰',
    ];
});
```

### 13. éƒ¨ç½²é–“ã®ãƒ‡ãƒ¼ã‚¿è¤‡è£½

**è¦ä»¶**: éƒ¨ç½²ç®¡ç†è€…ãŒä»–éƒ¨ç½²ã®ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªéƒ¨ç½²ã«è¤‡è£½å¯èƒ½

**å®Ÿè£…æ–¹é‡**: è¤‡è£½æ©Ÿèƒ½ï¼ˆæ‰¿èªä¸è¦ã€ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…ï¼‰

**å¯¾å¿œç­–**:
```php
// app/Http/Controllers/EventController.php
public function duplicate(Event $event)
{
    $user = auth()->user();
    
    // æ¨©é™ãƒã‚§ãƒƒã‚¯: éƒ¨ç½²ç®¡ç†è€…ã®ã¿
    if ($user->role_type !== 'department_admin') {
        abort(403, 'éƒ¨ç½²ç®¡ç†è€…ã®ã¿è¤‡è£½ã§ãã¾ã™');
    }
    
    // è¤‡è£½æ¸ˆã¿ãƒã‚§ãƒƒã‚¯
    $alreadyDuplicated = Event::where('original_event_id', $event->event_id)
        ->where('owner_department_id', $user->department_id)
        ->exists();
    
    if ($alreadyDuplicated) {
        return back()->with('error', 'ã“ã®äºˆå®šã¯æ—¢ã«è¤‡è£½æ¸ˆã¿ã§ã™');
    }
    
    // è¤‡è£½ã‚’ä½œæˆ
    $duplicated = Event::create([
        'calendar_id' => $this->getDepartmentCalendar($user->department_id)->calendar_id,
        'original_event_id' => $event->event_id,  // å…ƒã®ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’è¨˜éŒ²
        'title' => $event->title . 'ï¼ˆè¤‡è£½ï¼‰',
        'description' => $event->description,
        'location' => $event->location,
        'category' => $event->category,
        'importance' => $event->importance,
        'start_date' => $event->start_date,
        'end_date' => $event->end_date,
        'start_time' => $event->start_time,
        'end_time' => $event->end_time,
        'is_all_day' => $event->is_all_day,
        'visibility_type' => 'department',  // éƒ¨ç½²é™å®šã«è¨­å®š
        'owner_department_id' => $user->department_id,
        'created_by' => $user->id,
    ]);
    
    // ç¹°ã‚Šè¿”ã—è¨­å®šã‚‚è¤‡è£½
    if ($event->recurrence) {
        $duplicated->recurrence()->create([
            'recurrence_type' => $event->recurrence->recurrence_type,
            'recurrence_interval' => $event->recurrence->recurrence_interval,
            'by_day' => $event->recurrence->by_day,
            'by_set_pos' => $event->recurrence->by_set_pos,
            'end_date' => $event->recurrence->end_date,
        ]);
    }
    
    return back()->with('success', 'äºˆå®šã‚’è¤‡è£½ã—ã¾ã—ãŸ');
}
```

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¤‰æ›´**:
```sql
ALTER TABLE events
    ADD COLUMN original_event_id BIGINT NULL COMMENT 'è¤‡è£½å…ƒã®ã‚¤ãƒ™ãƒ³ãƒˆID',
    ADD INDEX idx_original_event (original_event_id);

ALTER TABLE shared_notes
    ADD COLUMN original_note_id BIGINT NULL COMMENT 'è¤‡è£½å…ƒã®ãƒ¡ãƒ¢ID',
    ADD INDEX idx_original_note (original_note_id);
```

**UIå®Ÿè£…**:
```vue
<template>
  <DropdownMenu>
    <DropdownMenuTrigger>
      <Button variant="ghost" size="sm">
        <MoreVertical class="h-4 w-4" />
      </Button>
    </DropdownMenuTrigger>
    <DropdownMenuContent>
      <DropdownMenuItem @click="handleEdit">ç·¨é›†</DropdownMenuItem>
      <DropdownMenuItem @click="handleDelete">å‰Šé™¤</DropdownMenuItem>
      
      <!-- éƒ¨ç½²ç®¡ç†è€…ã®ã¿è¡¨ç¤º -->
      <DropdownMenuItem 
        v-if="canDuplicate"
        @click="handleDuplicate"
        :disabled="isDuplicated"
      >
        <Copy class="h-4 w-4 mr-2" />
        {{ isDuplicated ? 'è¤‡è£½æ¸ˆã¿' : 'è‡ªéƒ¨ç½²ã«è¤‡è£½' }}
      </DropdownMenuItem>
    </DropdownMenuContent>
  </DropdownMenu>
</template>

<script setup lang="ts">
const canDuplicate = computed(() => {
  return user.value.role_type === 'department_admin' 
    && event.value.owner_department_id !== user.value.department_id
})

const isDuplicated = computed(() => {
  // APIã§ç¢ºèªã™ã‚‹ã‹ã€propsã§æ¸¡ã™
  return event.value.is_duplicated_by_current_department
})
</script>
```

### 14. ç›£æŸ»ãƒ­ã‚°ã®è©³ç´°

**è¦ä»¶**: é‡è¦ãªå¤‰æ›´ã®ã¿ãƒ­ã‚°ã‚’è¨˜éŒ²ã€éƒ¨ç½²ç®¡ç†è€…ã¨å…¨ç¤¾ç®¡ç†è€…ãŒé–²è¦§å¯èƒ½

**è¨˜éŒ²å¯¾è±¡**:
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç„¡åŠ¹åŒ–ãƒ»æœ‰åŠ¹åŒ–
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éƒ¨ç½²å¤‰æ›´
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²å¤‰æ›´
4. éƒ¨ç½²ã®ä½œæˆãƒ»å¤‰æ›´ãƒ»å‰Šé™¤
5. å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¸ã®äºˆå®šä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤

**ãƒ‡ãƒ¼ã‚¿æ§‹é€ **:
```sql
-- æ—¢å­˜ã® user_logs ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ‹¡å¼µ
ALTER TABLE user_logs
    ADD COLUMN action_type VARCHAR(50) NOT NULL COMMENT 'user_change, department_change, company_event, etc',
    ADD COLUMN target_type VARCHAR(50) NULL COMMENT 'User, Department, Event, etc',
    ADD COLUMN target_id BIGINT NULL COMMENT 'å¯¾è±¡ã®ID',
    ADD COLUMN old_value TEXT NULL COMMENT 'å¤‰æ›´å‰ã®å€¤ï¼ˆJSONï¼‰',
    ADD COLUMN new_value TEXT NULL COMMENT 'å¤‰æ›´å¾Œã®å€¤ï¼ˆJSONï¼‰',
    ADD INDEX idx_action_type (action_type),
    ADD INDEX idx_target (target_type, target_id);
```

**å®Ÿè£…**:
```php
// app/Services/AuditLogService.php
class AuditLogService
{
    public function logUserChange(User $user, string $action, array $changes)
    {
        UserLog::create([
            'user_id' => $user->id,
            'action_type' => 'user_change',
            'action' => $action,
            'target_type' => 'User',
            'target_id' => $user->id,
            'old_value' => json_encode($changes['old'] ?? []),
            'new_value' => json_encode($changes['new'] ?? []),
            'changed_by' => auth()->id(),
        ]);
    }
    
    public function logDepartmentChange(Department $department, string $action, array $changes = [])
    {
        UserLog::create([
            'user_id' => null,
            'action_type' => 'department_change',
            'action' => $action,
            'target_type' => 'Department',
            'target_id' => $department->id,
            'old_value' => json_encode($changes['old'] ?? []),
            'new_value' => json_encode($changes['new'] ?? []),
            'changed_by' => auth()->id(),
        ]);
    }
    
    public function logCompanyEvent(Event $event, string $action)
    {
        // å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®äºˆå®šã®ã¿è¨˜éŒ²
        if ($event->calendar->owner_type !== 'company') {
            return;
        }
        
        UserLog::create([
            'user_id' => null,
            'action_type' => 'company_event',
            'action' => $action,
            'target_type' => 'Event',
            'target_id' => $event->event_id,
            'new_value' => json_encode([
                'title' => $event->title,
                'start_date' => $event->start_date,
                'end_date' => $event->end_date,
            ]),
            'changed_by' => auth()->id(),
        ]);
    }
}

// ä½¿ç”¨ä¾‹
// ãƒ¦ãƒ¼ã‚¶ãƒ¼éƒ¨ç½²å¤‰æ›´æ™‚
$auditLog->logUserChange($user, 'department_changed', [
    'old' => ['department_id' => 1, 'department_name' => 'ç·å‹™éƒ¨'],
    'new' => ['department_id' => 2, 'department_name' => 'å–¶æ¥­éƒ¨'],
]);
```

**é–²è¦§æ¨©é™**:
```php
// app/Http/Controllers/AuditLogController.php
public function index(Request $request)
{
    $user = auth()->user();
    
    $query = UserLog::with(['user', 'changer'])
        ->orderBy('created_at', 'desc');
    
    // éƒ¨ç½²ç®¡ç†è€…: è‡ªéƒ¨ç½²é–¢é€£ã®ãƒ­ã‚°ã®ã¿
    if ($user->role_type === 'department_admin') {
        $query->where(function($q) use ($user) {
            // è‡ªéƒ¨ç½²ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å¤‰æ›´
            $q->whereHas('user', function($subQ) use ($user) {
                $subQ->where('department_id', $user->department_id);
            })
            // ã¾ãŸã¯è‡ªéƒ¨ç½²ã®å¤‰æ›´
            ->orWhere(function($subQ) use ($user) {
                $subQ->where('target_type', 'Department')
                     ->where('target_id', $user->department_id);
            });
        });
    }
    // å…¨ç¤¾ç®¡ç†è€…: å…¨ã¦ã®ãƒ­ã‚°
    elseif ($user->role_type !== 'company_admin') {
        abort(403);
    }
    
    $logs = $query->paginate(50);
    
    return Inertia::render('AuditLogs/Index', [
        'logs' => $logs,
    ]);
}
```

### 15. ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ: ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– vs PWA

**æ¯”è¼ƒè¡¨**:

| é …ç›® | ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ | PWA |
|------|-------------------|-----|
| **å®Ÿè£…ã‚³ã‚¹ãƒˆ** | ä½ï¼ˆCSSã®èª¿æ•´ã®ã¿ï¼‰ | ä¸­ï¼ˆService Workerç­‰ã®è¿½åŠ å®Ÿè£…ï¼‰ |
| **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ** | âŒ ä¸å¯ | âœ… å¯èƒ½ |
| **ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥** | âŒ ä¸å¯ | âœ… å¯èƒ½ |
| **ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ ** | âŒ ä¸å¯ | âœ… å¯èƒ½ï¼ˆã‚¢ãƒ—ãƒªé¢¨ï¼‰ |
| **ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«** | ä¸è¦ | ä»»æ„ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ï¼‰ |
| **èª­ã¿è¾¼ã¿é€Ÿåº¦** | é€šå¸¸ | é«˜é€Ÿï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ï¼‰ |
| **é–‹ç™ºæœŸé–“** | çŸ­ã„ï¼ˆ+2é€±é–“ï¼‰ | é•·ã„ï¼ˆ+1ãƒ¶æœˆï¼‰ |
| **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹** | å®¹æ˜“ | ã‚„ã‚„è¤‡é›‘ |

**æ¨å¥¨**: ã¾ãšãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã§å®Ÿè£…ã€å¿…è¦ã«å¿œã˜ã¦PWAåŒ–

**ç†ç”±**:
1. 50åè¦æ¨¡ãªã‚‰ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã§ååˆ†
2. PWAã¯å¾Œã‹ã‚‰è¿½åŠ å¯èƒ½
3. é–‹ç™ºã‚³ã‚¹ãƒˆã‚’æŠ‘ãˆã‚‰ã‚Œã‚‹
4. ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ã¯ç¾æ™‚ç‚¹ã§ä¸è¦ã¨åˆ¤æ–­

**ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ**:
```css
/* Tailwind CSS ã§ã®ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆ */
/* sm: 640px, md: 768px, lg: 1024px, xl: 1280px */

/* ãƒ¢ãƒã‚¤ãƒ«å„ªå…ˆ */
.calendar-view {
  @apply flex flex-col;
}

/* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆä»¥ä¸Š */
@screen md {
  .calendar-view {
    @apply flex-row;
  }
}

/* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ— */
@screen lg {
  .calendar-view {
    @apply grid grid-cols-12 gap-4;
  }
}
```

### 16. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ç½å®³å¾©æ—§è¨ˆç”»

**ç¾çŠ¶**: XServerã§ã®é‹ç”¨ã€æ˜æ–‡åŒ–ã•ã‚ŒãŸè¨ˆç”»ãªã—

**æ¨å¥¨å¯¾å¿œ**:

#### 1. XServerã®è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ´»ç”¨
```
XServerã®æ¨™æº–æ©Ÿèƒ½:
- è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: éå»7æ—¥åˆ†ï¼ˆç„¡æ–™ï¼‰
- æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: ç®¡ç†ç”»é¢ã‹ã‚‰å®Ÿè¡Œå¯èƒ½
```

#### 2. è¿½åŠ ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥
```bash
# cron ã§æ¯æ—¥å®Ÿè¡Œ
0 2 * * * /path/to/backup-script.sh

# backup-script.sh
#!/bin/bash
DATE=$(date +%Y%m%d)
BACKUP_DIR="/path/to/backups"

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
mysqldump -u user -p database > $BACKUP_DIR/db_$DATE.sql

# åœ§ç¸®
gzip $BACKUP_DIR/db_$DATE.sql

# 7æ—¥ä»¥ä¸Šå‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤
find $BACKUP_DIR -name "db_*.sql.gz" -mtime +7 -delete
```

#### 3. å¾©æ—§æ‰‹é †æ›¸ï¼ˆå¿…é ˆï¼‰
```markdown
# ç½å®³å¾©æ—§æ‰‹é †

## 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¾©æ—§
```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ
gunzip db_20250120.sql.gz
mysql -u user -p database < db_20250120.sql
```

## 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å¾©æ—§
```bash
# ã‚³ãƒ¼ãƒ‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤
git pull origin main
composer install
php artisan migrate
php artisan cache:clear
```

## 3. å‹•ä½œç¢ºèª
- ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½ã‹
- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º
- ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ç¢ºèª
```

#### 4. å®šæœŸçš„ãªãƒ†ã‚¹ãƒˆ
- æœˆ1å›: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®å¾©æ—§ãƒ†ã‚¹ãƒˆ
- å››åŠæœŸ1å›: å®Œå…¨ãªç½å®³å¾©æ—§è¨“ç·´

#### 5. ã‚¯ãƒ©ã‚¦ãƒ‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
```
ã‚³ã‚¹ãƒˆè©¦ç®—:
- AWS S3: ç´„$0.023/GB/æœˆ
- 10GBã®ãƒ‡ãƒ¼ã‚¿: ç´„$0.23/æœˆï¼ˆç´„30å††/æœˆï¼‰
- å¹´é–“: ç´„360å††

â†’ å…ˆæ–¹ã«ææ¡ˆã™ã‚‹ä¾¡å€¤ã‚ã‚Š
```

---

## è¿½åŠ ã®æ‡¸å¿µäº‹é …

### 21. éƒ¨ç½²çµ±å»ƒåˆæ™‚ã®ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ

**æ‡¸å¿µ**: éƒ¨ç½²ãŒçµ±åˆã•ã‚Œã‚‹å ´åˆã€ãƒ‡ãƒ¼ã‚¿ã‚’ã©ã†æ‰±ã†ã‹ï¼Ÿ

**ã‚·ãƒŠãƒªã‚ª**: ã€Œç¬¬ä¸€å–¶æ¥­éƒ¨ã€ã¨ã€Œç¬¬äºŒå–¶æ¥­éƒ¨ã€ãŒã€Œå–¶æ¥­éƒ¨ã€ã«çµ±åˆ

**ç¢ºèªäº‹é …**:
- çµ±åˆå‰ã®éƒ¨ç½²ã®ãƒ‡ãƒ¼ã‚¿ã¯æ–°ã—ã„éƒ¨ç½²ã«ç§»è¡Œï¼Ÿ
- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯çµ±åˆï¼Ÿåˆ¥ã€…ã«ä¿æŒï¼Ÿ
- éå»ã®ãƒ­ã‚°ã¯ï¼Ÿ

**æ¨å¥¨å¯¾å¿œ**:
```php
public function mergeDepartments(array $sourceDepartmentIds, int $targetDepartmentId)
{
    DB::transaction(function() use ($sourceDepartmentIds, $targetDepartmentId) {
        // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç§»å‹•
        User::whereIn('department_id', $sourceDepartmentIds)
            ->update(['department_id' => $targetDepartmentId]);
        
        // 2. ãƒ‡ãƒ¼ã‚¿ã‚’ç§»å‹•
        Event::whereIn('owner_department_id', $sourceDepartmentIds)
            ->update(['owner_department_id' => $targetDepartmentId]);
        
        SharedNote::whereIn('owner_department_id', $sourceDepartmentIds)
            ->update(['owner_department_id' => $targetDepartmentId]);
        
        Survey::whereIn('owner_department_id', $sourceDepartmentIds)
            ->update(['owner_department_id' => $targetDepartmentId]);
        
        // 3. å…ƒã®éƒ¨ç½²ã‚’ç„¡åŠ¹åŒ–ï¼ˆå‰Šé™¤ã¯ã—ãªã„ï¼‰
        Department::whereIn('id', $sourceDepartmentIds)
            ->update(['is_active' => false]);
        
        // 4. ãƒ­ã‚°ã‚’è¨˜éŒ²
        foreach ($sourceDepartmentIds as $sourceId) {
            $this->auditLog->logDepartmentChange(
                Department::find($sourceId),
                'merged',
                ['merged_into' => $targetDepartmentId]
            );
        }
    });
}
```

### 22. å¤§é‡ãƒ‡ãƒ¼ã‚¿æŠ•å…¥æ™‚ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

**æ‡¸å¿µ**: ç¹°ã‚Šè¿”ã—äºˆå®šãŒå¤§é‡ã«å±•é–‹ã•ã‚Œã‚‹å ´åˆã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

**ã‚·ãƒŠãƒªã‚ª**: æ¯æ—¥ã®å®šä¾‹ä¼šè­°ã‚’1å¹´åˆ†å±•é–‹ = 365ä»¶

**ç¢ºèªäº‹é …**:
- ç¾åœ¨ã®å®Ÿè£…ã§å•é¡Œãªã„ã‹ï¼Ÿ
- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã¯é©åˆ‡ã‹ï¼Ÿ
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯åŠ¹ã„ã¦ã„ã‚‹ã‹ï¼Ÿ

**æ¨å¥¨å¯¾å¿œ**:
- ç¹°ã‚Šè¿”ã—äºˆå®šã¯å±•é–‹ã›ãšã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§è¡¨ç¤ºæ™‚ã«å±•é–‹
- ã¾ãŸã¯ã€å±•é–‹ã¯3ãƒ¶æœˆåˆ†ã®ã¿ã«åˆ¶é™

### 23. åŒæ™‚ç·¨é›†ã®ç«¶åˆ

**æ‡¸å¿µ**: è¤‡æ•°äººãŒåŒæ™‚ã«åŒã˜äºˆå®šã‚’ç·¨é›†ã—ãŸå ´åˆ

**ç¢ºèªäº‹é …**:
- æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ï¼ˆOptimistic Lockingï¼‰ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
- æœ€å¾Œã«ä¿å­˜ã—ãŸäººã®å†…å®¹ã§ä¸Šæ›¸ãã•ã‚Œã‚‹ï¼Ÿ

**æ¨å¥¨å¯¾å¿œ**:
```php
// Eloquent ã®æ¥½è¦³çš„ãƒ­ãƒƒã‚¯
Schema::table('events', function (Blueprint $table) {
    $table->integer('version')->default(0);
});

// æ›´æ–°æ™‚
public function update(UpdateEventRequest $request, Event $event)
{
    $currentVersion = $request->input('version');
    
    if ($event->version !== $currentVersion) {
        return back()->with('error', 'ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç·¨é›†ã—ã¦ã„ã¾ã™ã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
    }
    
    $event->update([
        ...$request->validated(),
        'version' => $event->version + 1,
    ]);
}
```

---

## ç¢ºå®šäº‹é …ã¾ã¨ã‚

### å®Ÿè£…ã™ã‚‹æ©Ÿèƒ½
1. âœ… éƒ¨ç½²åå¤‰æ›´æ™‚ã®è‡ªå‹•åæ˜ 
2. âœ… éƒ¨ç½²ç®¡ç†è€…ã‚‚å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«æŠ•ç¨¿å¯èƒ½
3. âœ… é€€è·è€…ãƒ‡ãƒ¼ã‚¿ã¯éƒ¨ç½²ç®¡ç†è€…ã«ç§»è­²ã€æœªæ¥ã®äºˆå®šã‹ã‚‰é™¤å¤–
4. âœ… éƒ¨ç½²é–“ãƒ‡ãƒ¼ã‚¿è¤‡è£½æ©Ÿèƒ½ï¼ˆæ‰¿èªä¸è¦ï¼‰
5. âœ… ç›£æŸ»ãƒ­ã‚°ï¼ˆé‡è¦ãªå¤‰æ›´ã®ã¿ï¼‰
6. âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆPWAã¯ä¿ç•™ï¼‰
7. âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©æ—§æ‰‹é †ã®æ˜æ–‡åŒ–

### ä¿ç•™ãƒ»ä¸è¦ãªæ©Ÿèƒ½
1. âŒ è¤‡æ•°ã®éƒ¨ç½²ç®¡ç†è€…ï¼ˆ50åè¦æ¨¡ã§ã¯ä¸è¦ï¼‰
2. âŒ éƒ¨ç½²ã®éšå±¤æ§‹é€ ï¼ˆç¾æ™‚ç‚¹ã§ã¯ä¸è¦ï¼‰
3. âŒ å¤–éƒ¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æºï¼ˆç¾æ™‚ç‚¹ã§ã¯ä¸è¦ï¼‰
4. âŒ PWAåŒ–ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã§é–‹å§‹ï¼‰
5. â¸ï¸ éƒ¨ç½²çµ±å»ƒåˆæ©Ÿèƒ½ï¼ˆå¿…è¦ã«ãªã£ãŸã‚‰å®Ÿè£…ï¼‰

### è¿½åŠ ç¢ºèªãŒå¿…è¦ãªé …ç›®
1. âš ï¸ éƒ¨ç½²çµ±å»ƒåˆæ™‚ã®ãƒ‡ãƒ¼ã‚¿ç§»è¡Œæ–¹é‡
2. âš ï¸ å¤§é‡ãƒ‡ãƒ¼ã‚¿æŠ•å…¥æ™‚ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¯¾ç­–
3. âš ï¸ åŒæ™‚ç·¨é›†ã®ç«¶åˆè§£æ±ºæ–¹æ³•

---

**æ›´æ–°æ—¥**: 2025å¹´1æœˆ
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.1
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: è¿½åŠ è¦ä»¶åæ˜ å®Œäº†


---

## é€€è·è€…ã®å‚åŠ è€…é™¤å¤–ã®è©³ç´°ä»•æ§˜

### å‡¦ç†å†…å®¹

**ãƒˆãƒªã‚¬ãƒ¼**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç„¡åŠ¹åŒ–æ™‚ï¼ˆ`is_active = false`ã«å¤‰æ›´ï¼‰

**è‡ªå‹•å‡¦ç†ã•ã‚Œã‚‹å†…å®¹**:

1. **æ‰€æœ‰æ¨©ã®ç§»è­²**
   - é€€è·è€…ãŒä½œæˆã—ãŸæœªæ¥ã®äºˆå®š â†’ éƒ¨ç½²ç®¡ç†è€…ã«ç§»è­²
   - é€€è·è€…ãŒä½œæˆã—ãŸå…±æœ‰ãƒ¡ãƒ¢ â†’ éƒ¨ç½²ç®¡ç†è€…ã«ç§»è­²
   - é€€è·è€…ãŒä½œæˆã—ãŸã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ â†’ éƒ¨ç½²ç®¡ç†è€…ã«ç§»è­²

2. **å‚åŠ è€…ã‹ã‚‰ã®é™¤å¤–**
   - æœªæ¥ã®äºˆå®šï¼ˆ`start_date >= ä»Šæ—¥`ï¼‰ã‹ã‚‰è‡ªå‹•çš„ã«é™¤å¤–
   - éå»ã®äºˆå®šã¯å±¥æ­´ã¨ã—ã¦ä¿æŒï¼ˆé™¤å¤–ã—ãªã„ï¼‰

3. **ãƒ­ã‚°ã®è¨˜éŒ²**
   - ç„¡åŠ¹åŒ–ã®ç†ç”±
   - ç§»è­²ã—ãŸäºˆå®šãƒ»ãƒ¡ãƒ¢ãƒ»ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®ä»¶æ•°
   - é™¤å¤–ã—ãŸäºˆå®šã®ä»¶æ•°

### å®Ÿè£…ã‚³ãƒ¼ãƒ‰

```php
// app/Services/UserDeactivationService.php
public function deactivateUser(User $user, string $reason): array
{
    $stats = [
        'transferred_events' => 0,
        'transferred_notes' => 0,
        'transferred_surveys' => 0,
        'removed_from_events' => 0,
    ];
    
    DB::transaction(function() use ($user, $reason, &$stats) {
        $today = Carbon::today();
        $departmentAdmin = $this->getDepartmentAdmin($user->department_id);
        
        // 1. æœªæ¥ã®äºˆå®šã®æ‰€æœ‰æ¨©ã‚’ç§»è­²
        $futureEvents = Event::where('created_by', $user->id)
            ->where('start_date', '>=', $today)
            ->get();
        
        foreach ($futureEvents as $event) {
            $event->update(['created_by' => $departmentAdmin->id]);
            $stats['transferred_events']++;
        }
        
        // 2. å…±æœ‰ãƒ¡ãƒ¢ã®æ‰€æœ‰æ¨©ã‚’ç§»è­²
        $notes = SharedNote::where('author_id', $user->id)
            ->where('is_deleted', false)
            ->get();
        
        foreach ($notes as $note) {
            $note->update(['author_id' => $departmentAdmin->id]);
            $stats['transferred_notes']++;
        }
        
        // 3. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®æ‰€æœ‰æ¨©ã‚’ç§»è­²
        $surveys = Survey::where('created_by', $user->id)
            ->where('is_active', true)
            ->where('is_deleted', false)
            ->get();
        
        foreach ($surveys as $survey) {
            $survey->update(['created_by' => $departmentAdmin->id]);
            $stats['transferred_surveys']++;
        }
        
        // 4. æœªæ¥ã®äºˆå®šã‹ã‚‰å‚åŠ è€…ã¨ã—ã¦é™¤å¤–
        $removedCount = DB::table('event_participants')
            ->where('user_id', $user->id)
            ->whereIn('event_id', function($query) use ($today) {
                $query->select('event_id')
                      ->from('events')
                      ->where('start_date', '>=', $today);
            })
            ->delete();
        
        $stats['removed_from_events'] = $removedCount;
        
        // 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç„¡åŠ¹åŒ–
        $user->update([
            'is_active' => false,
            'deactivated_at' => now(),
            'reason' => $reason,
        ]);
        
        // 6. ãƒ­ã‚°ã‚’è¨˜éŒ²
        UserLog::create([
            'user_id' => $user->id,
            'action_type' => 'user_change',
            'action' => 'deactivated',
            'target_type' => 'User',
            'target_id' => $user->id,
            'new_value' => json_encode([
                'reason' => $reason,
                'stats' => $stats,
            ]),
            'changed_by' => auth()->id(),
        ]);
    });
    
    return $stats;
}
```

### UIè¡¨ç¤º

```vue
<template>
  <Dialog v-model:open="showDeactivateDialog">
    <DialogContent>
      <DialogHeader>
        <DialogTitle>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç„¡åŠ¹åŒ–</DialogTitle>
        <DialogDescription>
          {{ user.name }}ã•ã‚“ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™
        </DialogDescription>
      </DialogHeader>
      
      <div class="space-y-4">
        <Alert variant="warning">
          <AlertCircle class="h-4 w-4" />
          <AlertTitle>è‡ªå‹•å‡¦ç†ã•ã‚Œã‚‹å†…å®¹</AlertTitle>
          <AlertDescription>
            <ul class="list-disc list-inside space-y-1 mt-2">
              <li>ä½œæˆã—ãŸæœªæ¥ã®äºˆå®š â†’ éƒ¨ç½²ç®¡ç†è€…ã«ç§»è­²</li>
              <li>ä½œæˆã—ãŸå…±æœ‰ãƒ¡ãƒ¢ â†’ éƒ¨ç½²ç®¡ç†è€…ã«ç§»è­²</li>
              <li>ä½œæˆã—ãŸã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ â†’ éƒ¨ç½²ç®¡ç†è€…ã«ç§»è­²</li>
              <li>å‚åŠ äºˆå®šã®æœªæ¥ã®äºˆå®š â†’ è‡ªå‹•çš„ã«é™¤å¤–</li>
            </ul>
          </AlertDescription>
        </Alert>
        
        <div class="space-y-2">
          <Label for="reason">ç„¡åŠ¹åŒ–ã®ç†ç”±</Label>
          <Textarea
            id="reason"
            v-model="reason"
            placeholder="ä¾‹ï¼šé€€è·ã€ä¼‘è·ãªã©"
            rows="3"
          />
        </div>
      </div>
      
      <DialogFooter>
        <Button variant="outline" @click="showDeactivateDialog = false">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </Button>
        <Button variant="destructive" @click="handleDeactivate">
          ç„¡åŠ¹åŒ–
        </Button>
      </DialogFooter>
    </DialogContent>
  </Dialog>
  
  <!-- å‡¦ç†å®Œäº†ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <Dialog v-model:open="showResultDialog">
    <DialogContent>
      <DialogHeader>
        <DialogTitle>ç„¡åŠ¹åŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ</DialogTitle>
      </DialogHeader>
      
      <div class="space-y-2">
        <p class="text-sm text-gray-600">ä»¥ä¸‹ã®å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã—ãŸï¼š</p>
        <ul class="list-disc list-inside space-y-1 text-sm">
          <li>äºˆå®šã®æ‰€æœ‰æ¨©ç§»è­²: {{ result.transferred_events }}ä»¶</li>
          <li>ãƒ¡ãƒ¢ã®æ‰€æœ‰æ¨©ç§»è­²: {{ result.transferred_notes }}ä»¶</li>
          <li>ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®æ‰€æœ‰æ¨©ç§»è­²: {{ result.transferred_surveys }}ä»¶</li>
          <li>äºˆå®šã‹ã‚‰é™¤å¤–: {{ result.removed_from_events }}ä»¶</li>
        </ul>
      </div>
      
      <DialogFooter>
        <Button @click="showResultDialog = false">é–‰ã˜ã‚‹</Button>
      </DialogFooter>
    </DialogContent>
  </Dialog>
</template>
```

---

## éƒ¨ç½²çµ±å»ƒåˆã®è©³ç´°ä»•æ§˜

### å‡¦ç†å†…å®¹

**ãƒˆãƒªã‚¬ãƒ¼**: ç®¡ç†è€…ãŒéƒ¨ç½²çµ±åˆã‚’å®Ÿè¡Œ

**è‡ªå‹•å‡¦ç†ã•ã‚Œã‚‹å†…å®¹**:

1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç§»å‹•**
   - çµ±åˆå…ƒã®éƒ¨ç½²ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ çµ±åˆå…ˆã®éƒ¨ç½²ã«ç§»å‹•

2. **ãƒ‡ãƒ¼ã‚¿ã®ç§»å‹•**
   - äºˆå®šï¼ˆeventsï¼‰ã®`owner_department_id` â†’ çµ±åˆå…ˆã«å¤‰æ›´
   - å…±æœ‰ãƒ¡ãƒ¢ï¼ˆshared_notesï¼‰ã®`owner_department_id` â†’ çµ±åˆå…ˆã«å¤‰æ›´
   - ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼ˆsurveysï¼‰ã®`owner_department_id` â†’ çµ±åˆå…ˆã«å¤‰æ›´
   - ã‚´ãƒŸç®±ï¼ˆtrash_itemsï¼‰ã®`owner_department_id` â†’ çµ±åˆå…ˆã«å¤‰æ›´

3. **ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ‰±ã„**
   - çµ±åˆå…ƒã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯å‰Šé™¤ã›ãšç„¡åŠ¹åŒ–ï¼ˆ`is_active = false`ï¼‰
   - çµ±åˆå…ˆã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«å…¨ãƒ‡ãƒ¼ã‚¿ãŒçµ±åˆã•ã‚Œã‚‹

4. **çµ±åˆå…ƒã®éƒ¨ç½²**
   - å‰Šé™¤ã›ãšç„¡åŠ¹åŒ–ï¼ˆ`is_active = false`ï¼‰
   - å±¥æ­´ã¨ã—ã¦ä¿æŒ

5. **ãƒ­ã‚°ã®è¨˜éŒ²**
   - çµ±åˆå…ƒã¨çµ±åˆå…ˆã®éƒ¨ç½²ID
   - ç§»å‹•ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
   - ç§»å‹•ã—ãŸãƒ‡ãƒ¼ã‚¿ä»¶æ•°

### å®Ÿè£…ã‚³ãƒ¼ãƒ‰

```php
// app/Services/DepartmentMergeService.php
public function mergeDepartments(
    array $sourceDepartmentIds, 
    int $targetDepartmentId,
    string $reason = ''
): array
{
    $stats = [
        'moved_users' => 0,
        'moved_events' => 0,
        'moved_notes' => 0,
        'moved_surveys' => 0,
        'moved_trash_items' => 0,
    ];
    
    DB::transaction(function() use ($sourceDepartmentIds, $targetDepartmentId, $reason, &$stats) {
        
        // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç§»å‹•
        $movedUsers = User::whereIn('department_id', $sourceDepartmentIds)
            ->update(['department_id' => $targetDepartmentId]);
        $stats['moved_users'] = $movedUsers;
        
        // 2. äºˆå®šã‚’ç§»å‹•
        $movedEvents = Event::whereIn('owner_department_id', $sourceDepartmentIds)
            ->update([
                'owner_department_id' => $targetDepartmentId,
                'calendar_id' => $this->getTargetCalendar($targetDepartmentId)->calendar_id,
            ]);
        $stats['moved_events'] = $movedEvents;
        
        // 3. å…±æœ‰ãƒ¡ãƒ¢ã‚’ç§»å‹•
        $movedNotes = SharedNote::whereIn('owner_department_id', $sourceDepartmentIds)
            ->update(['owner_department_id' => $targetDepartmentId]);
        $stats['moved_notes'] = $movedNotes;
        
        // 4. ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’ç§»å‹•
        $movedSurveys = Survey::whereIn('owner_department_id', $sourceDepartmentIds)
            ->update(['owner_department_id' => $targetDepartmentId]);
        $stats['moved_surveys'] = $movedSurveys;
        
        // 5. ã‚´ãƒŸç®±ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç§»å‹•
        $movedTrash = TrashItem::whereIn('owner_department_id', $sourceDepartmentIds)
            ->update(['owner_department_id' => $targetDepartmentId]);
        $stats['moved_trash_items'] = $movedTrash;
        
        // 6. çµ±åˆå…ƒã®éƒ¨ç½²ã‚’ç„¡åŠ¹åŒ–ï¼ˆå‰Šé™¤ã¯ã—ãªã„ï¼‰
        foreach ($sourceDepartmentIds as $sourceId) {
            $sourceDept = Department::find($sourceId);
            $sourceDept->update(['is_active' => false]);
            
            // 7. çµ±åˆå…ƒã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚‚ç„¡åŠ¹åŒ–
            Calendar::where('owner_type', 'department')
                ->where('owner_id', $sourceId)
                ->delete();
            
            // 8. ãƒ­ã‚°ã‚’è¨˜éŒ²
            UserLog::create([
                'user_id' => null,
                'action_type' => 'department_change',
                'action' => 'merged',
                'target_type' => 'Department',
                'target_id' => $sourceId,
                'old_value' => json_encode([
                    'department_id' => $sourceId,
                    'department_name' => $sourceDept->name,
                ]),
                'new_value' => json_encode([
                    'merged_into' => $targetDepartmentId,
                    'reason' => $reason,
                    'stats' => $stats,
                ]),
                'changed_by' => auth()->id(),
            ]);
        }
    });
    
    return $stats;
}
```

### UIè¡¨ç¤º

```vue
<template>
  <Dialog v-model:open="showMergeDialog">
    <DialogContent class="max-w-2xl">
      <DialogHeader>
        <DialogTitle>éƒ¨ç½²ã®çµ±åˆ</DialogTitle>
        <DialogDescription>
          è¤‡æ•°ã®éƒ¨ç½²ã‚’1ã¤ã«çµ±åˆã—ã¾ã™
        </DialogDescription>
      </DialogHeader>
      
      <div class="space-y-4">
        <div class="space-y-2">
          <Label>çµ±åˆå…ƒã®éƒ¨ç½²ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</Label>
          <MultiSelect
            v-model="sourceDepartments"
            :options="availableDepartments"
            placeholder="çµ±åˆã™ã‚‹éƒ¨ç½²ã‚’é¸æŠ..."
          />
        </div>
        
        <div class="space-y-2">
          <Label>çµ±åˆå…ˆã®éƒ¨ç½²</Label>
          <Select v-model="targetDepartment">
            <SelectTrigger>
              <SelectValue placeholder="çµ±åˆå…ˆã‚’é¸æŠ" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem
                v-for="dept in availableDepartments"
                :key="dept.id"
                :value="dept.id"
              >
                {{ dept.name }}
              </SelectItem>
            </SelectContent>
          </Select>
        </div>
        
        <div class="space-y-2">
          <Label>çµ±åˆã®ç†ç”±</Label>
          <Textarea
            v-model="reason"
            placeholder="ä¾‹ï¼šçµ„ç¹”å†ç·¨ã®ãŸã‚"
            rows="2"
          />
        </div>
        
        <Alert variant="warning">
          <AlertCircle class="h-4 w-4" />
          <AlertTitle>è‡ªå‹•å‡¦ç†ã•ã‚Œã‚‹å†…å®¹</AlertTitle>
          <AlertDescription>
            <ul class="list-disc list-inside space-y-1 mt-2">
              <li>çµ±åˆå…ƒã®å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ çµ±åˆå…ˆã«ç§»å‹•</li>
              <li>çµ±åˆå…ƒã®å…¨äºˆå®šãƒ»ãƒ¡ãƒ¢ãƒ»ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ â†’ çµ±åˆå…ˆã«ç§»å‹•</li>
              <li>çµ±åˆå…ƒã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ â†’ çµ±åˆå…ˆã«çµ±åˆ</li>
              <li>çµ±åˆå…ƒã®éƒ¨ç½² â†’ ç„¡åŠ¹åŒ–ï¼ˆå±¥æ­´ã¨ã—ã¦ä¿æŒï¼‰</li>
            </ul>
          </AlertDescription>
        </Alert>
        
        <Alert>
          <Info class="h-4 w-4" />
          <AlertDescription>
            ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚æ…é‡ã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
          </AlertDescription>
        </Alert>
      </div>
      
      <DialogFooter>
        <Button variant="outline" @click="showMergeDialog = false">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </Button>
        <Button 
          variant="destructive" 
          @click="handleMerge"
          :disabled="!canMerge"
        >
          çµ±åˆã‚’å®Ÿè¡Œ
        </Button>
      </DialogFooter>
    </DialogContent>
  </Dialog>
  
  <!-- å‡¦ç†å®Œäº†ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <Dialog v-model:open="showResultDialog">
    <DialogContent>
      <DialogHeader>
        <DialogTitle>éƒ¨ç½²ã®çµ±åˆãŒå®Œäº†ã—ã¾ã—ãŸ</DialogTitle>
      </DialogHeader>
      
      <div class="space-y-2">
        <p class="text-sm text-gray-600">ä»¥ä¸‹ã®å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã—ãŸï¼š</p>
        <ul class="list-disc list-inside space-y-1 text-sm">
          <li>ç§»å‹•ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼: {{ result.moved_users }}äºº</li>
          <li>ç§»å‹•ã—ãŸäºˆå®š: {{ result.moved_events }}ä»¶</li>
          <li>ç§»å‹•ã—ãŸãƒ¡ãƒ¢: {{ result.moved_notes }}ä»¶</li>
          <li>ç§»å‹•ã—ãŸã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ: {{ result.moved_surveys }}ä»¶</li>
          <li>ç§»å‹•ã—ãŸã‚´ãƒŸç®±ã‚¢ã‚¤ãƒ†ãƒ : {{ result.moved_trash_items }}ä»¶</li>
        </ul>
      </div>
      
      <DialogFooter>
        <Button @click="handleComplete">é–‰ã˜ã‚‹</Button>
      </DialogFooter>
    </DialogContent>
  </Dialog>
</template>

<script setup lang="ts">
const canMerge = computed(() => {
  return sourceDepartments.value.length > 0 
    && targetDepartment.value 
    && !sourceDepartments.value.includes(targetDepartment.value)
})

const handleMerge = async () => {
  const response = await axios.post('/api/departments/merge', {
    source_department_ids: sourceDepartments.value,
    target_department_id: targetDepartment.value,
    reason: reason.value,
  })
  
  result.value = response.data
  showMergeDialog.value = false
  showResultDialog.value = true
}
</script>
```

---

## LINE WORKSã¨ã®ä»•æ§˜å·®ç•°ã¾ã¨ã‚

### ğŸ”´ ä¸»è¦ãªå·®ç•°ï¼ˆè¦å¯¾å¿œï¼‰

| é …ç›® | LINE WORKS | æœ¬ã‚¢ãƒ—ãƒª | å½±éŸ¿åº¦ | å¯¾å¿œæ–¹é‡ |
|------|-----------|---------|--------|---------|
| **å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æŠ•ç¨¿** | æ‰¿èªãƒ•ãƒ­ãƒ¼å¿…é ˆ | éƒ¨ç½²ç®¡ç†è€…ãŒç›´æ¥æŠ•ç¨¿ | é«˜ | âœ… æ‰¿èªåˆ¶ã«å¤‰æ›´ |
| **ä»–éƒ¨ç½²ã¸ã®å…±æœ‰** | å…±æœ‰ï¼ˆåŒä¸€ãƒ‡ãƒ¼ã‚¿ï¼‰ | è¤‡è£½ï¼ˆç‹¬ç«‹ã‚³ãƒ”ãƒ¼ï¼‰ | é«˜ | âœ… å…±æœ‰æ–¹å¼ã«å¤‰æ›´ |
| **ç¹°ã‚Šè¿”ã—äºˆå®šå±•é–‹** | è¡¨ç¤ºç¯„å›²ã®ã¿å‹•çš„å±•é–‹ | 3ãƒ¶æœˆåˆ†äº‹å‰å±•é–‹ | ä¸­ | âœ… å‹•çš„å±•é–‹ã«å¤‰æ›´ |

### ğŸŸ¡ ä¸­ç¨‹åº¦ã®å·®ç•°ï¼ˆç¾çŠ¶ç¶­æŒå¯ï¼‰

| é …ç›® | LINE WORKS | æœ¬ã‚¢ãƒ—ãƒª | ç†ç”± |
|------|-----------|---------|------|
| **é€€è·è€…ã®å‚åŠ è€…é™¤å¤–** | æ‰‹å‹•é™¤å¤– | è‡ªå‹•é™¤å¤– | 50åè¦æ¨¡ã§ã¯è‡ªå‹•åŒ–ãŒåŠ¹ç‡çš„ |
| **éƒ¨ç½²çµ±å»ƒåˆ** | æ‰‹å‹•ç§»è¡Œ | è‡ªå‹•ç§»è¡Œ | 50åè¦æ¨¡ã§ã¯è‡ªå‹•åŒ–ãŒåŠ¹ç‡çš„ |
| **åŒæ™‚ç·¨é›†ç«¶åˆ** | æœ€çµ‚æ›´æ–°å„ªå…ˆ+é€šçŸ¥ | æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ | ã‚ˆã‚Šå®‰å…¨ãªæ–¹å¼ã‚’æ¡ç”¨ |

### ğŸŸ¢ å·®ç•°ãªã—ï¼ˆå•é¡Œãªã—ï¼‰

| é …ç›® | ä¸¡è€…å…±é€š |
|------|---------|
| éƒ¨ç½²ã”ã¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ | âœ… |
| å…¬é–‹ç¯„å›²åˆ¶å¾¡ | âœ… |
| æ¨©é™ç®¡ç†ï¼ˆ3æ®µéšï¼‰ | âœ… |
| éƒ¨ç½²ç•°å‹•æ™‚ã®å‡¦ç† | âœ… |
| ã‚´ãƒŸç®±ã®éƒ¨ç½²ç®¡ç† | âœ… |

### è©³ç´°ãªå·®ç•°èª¬æ˜

#### 1. å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æŠ•ç¨¿ã®æ‰¿èªãƒ•ãƒ­ãƒ¼

**LINE WORKS**:
```
éƒ¨ç½²ç®¡ç†è€…ãŒæŠ•ç¨¿ç”³è«‹
â†“
å…¨ç¤¾ç®¡ç†è€…ãŒæ‰¿èª
â†“
å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¡¨ç¤º
```

**æœ¬ã‚¢ãƒ—ãƒªï¼ˆå½“åˆï¼‰**:
```
éƒ¨ç½²ç®¡ç†è€…ãŒç›´æ¥æŠ•ç¨¿
â†“
å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«å³åº§ã«è¡¨ç¤º
```

**å¤‰æ›´å¾Œ**:
```
éƒ¨ç½²ç®¡ç†è€…ãŒæŠ•ç¨¿ç”³è«‹
â†“
å…¨ç¤¾ç®¡ç†è€…ãŒæ‰¿èª/å´ä¸‹
â†“
æ‰¿èªã•ã‚ŒãŸã‚‰å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¡¨ç¤º
```

**å®Ÿè£…ã®è¿½åŠ **:
- `company_event_requests`ãƒ†ãƒ¼ãƒ–ãƒ«
- æ‰¿èª/å´ä¸‹æ©Ÿèƒ½
- é€šçŸ¥æ©Ÿèƒ½

#### 2. ä»–éƒ¨ç½²ã¸ã®å…±æœ‰æ–¹å¼

**LINE WORKS**:
```
å–¶æ¥­éƒ¨ã®äºˆå®šã‚’ä½œæˆ
â†“
é–‹ç™ºéƒ¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«å…±æœ‰
â†“
ã©ã¡ã‚‰ã‹ã‚‰ç·¨é›†ã—ã¦ã‚‚åŒã˜äºˆå®šãŒæ›´æ–°ã•ã‚Œã‚‹
```

**æœ¬ã‚¢ãƒ—ãƒªï¼ˆå½“åˆï¼‰**:
```
å–¶æ¥­éƒ¨ã®äºˆå®šã‚’ä½œæˆ
â†“
é–‹ç™ºéƒ¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¤‡è£½
â†“
ãã‚Œãã‚Œç‹¬ç«‹ã—ãŸäºˆå®šã¨ã—ã¦ç®¡ç†
```

**å¤‰æ›´å¾Œ**:
```
å–¶æ¥­éƒ¨ã®äºˆå®šã‚’ä½œæˆ
â†“
é–‹ç™ºéƒ¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«å…±æœ‰ï¼ˆcalendar_event_sharesï¼‰
â†“
ã©ã¡ã‚‰ã‹ã‚‰ç·¨é›†ã—ã¦ã‚‚åŒã˜äºˆå®šãŒæ›´æ–°ã•ã‚Œã‚‹
```

**å®Ÿè£…ã®è¿½åŠ **:
- `calendar_event_shares`ãƒ†ãƒ¼ãƒ–ãƒ«
- å…±æœ‰æ©Ÿèƒ½
- å…±æœ‰å…ˆã§ã®ç·¨é›†æ¨©é™

#### 3. ç¹°ã‚Šè¿”ã—äºˆå®šã®å±•é–‹

**LINE WORKS**:
```
ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºæ™‚ã«ã€è¡¨ç¤ºç¯„å›²ï¼ˆä¾‹ï¼š2025å¹´1æœˆï¼‰ã®ã¿å±•é–‹
â†“
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ2æœˆã‚’è¡¨ç¤ºã—ãŸã‚‰ã€2æœˆåˆ†ã‚’å±•é–‹
```

**æœ¬ã‚¢ãƒ—ãƒªï¼ˆå½“åˆï¼‰**:
```
ç¹°ã‚Šè¿”ã—äºˆå®šä½œæˆæ™‚ã«3ãƒ¶æœˆåˆ†ã‚’äº‹å‰å±•é–‹
â†“
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«365ä»¶ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã‚‹
```

**å¤‰æ›´å¾Œ**:
```
ç¹°ã‚Šè¿”ã—äºˆå®šã¯ãƒ«ãƒ¼ãƒ«ã®ã¿ä¿å­˜
â†“
ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºæ™‚ã«ã€è¡¨ç¤ºç¯„å›²ã®ã¿å‹•çš„ã«å±•é–‹
â†“
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¯1ä»¶ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã¿
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è‚¥å¤§åŒ–ã‚’é˜²ã
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
- æŸ”è»ŸãªæœŸé–“å¤‰æ›´

---

## å®Ÿè£…å„ªå…ˆåº¦ã®æ›´æ–°

### é«˜å„ªå…ˆåº¦ï¼ˆå¿…é ˆï¼‰
1. âœ… éƒ¨ç½²ãƒã‚¹ã‚¿ã®è¿½åŠ 
2. âœ… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ‰€æœ‰è€…æ¦‚å¿µ
3. âœ… å…¬é–‹ç¯„å›²åˆ¶å¾¡
4. âœ… æ¨©é™ç®¡ç†
5. ğŸ†• **å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ‰¿èªãƒ•ãƒ­ãƒ¼**
6. ğŸ†• **å…±æœ‰æ–¹å¼ã®å®Ÿè£…**
7. ğŸ†• **å‹•çš„å±•é–‹ã®å®Ÿè£…**

### ä¸­å„ªå…ˆåº¦ï¼ˆæ¨å¥¨ï¼‰
1. âœ… éƒ¨ç½²ç•°å‹•å‡¦ç†
2. âœ… é€€è·è€…ãƒ‡ãƒ¼ã‚¿å‡¦ç†
3. âœ… ç›£æŸ»ãƒ­ã‚°
4. âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©æ—§

### ä½å„ªå…ˆåº¦ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
1. â¸ï¸ éƒ¨ç½²çµ±å»ƒåˆæ©Ÿèƒ½
2. â¸ï¸ PWAåŒ–
3. â¸ï¸ å¤–éƒ¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æº

---

**æ›´æ–°æ—¥**: 2025å¹´1æœˆ
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.2
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: LINE WORKSä»•æ§˜å·®ç•°å¯¾å¿œå®Œäº†


---

## æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ï¼ˆåŒæ™‚ç·¨é›†ç«¶åˆï¼‰ã®è©³ç´°ãƒ•ãƒ­ãƒ¼

### å‡¦ç†ãƒ•ãƒ­ãƒ¼

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼A: äºˆå®šã‚’é–‹ãï¼ˆversion=1ï¼‰
ãƒ¦ãƒ¼ã‚¶ãƒ¼B: åŒã˜äºˆå®šã‚’é–‹ãï¼ˆversion=1ï¼‰
â†“
ãƒ¦ãƒ¼ã‚¶ãƒ¼A: ç·¨é›†ã—ã¦ä¿å­˜
  â†’ version=1 ã§ä¿å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  â†’ DBã®versionã‚‚1ãªã®ã§ä¿å­˜æˆåŠŸ
  â†’ version=2 ã«æ›´æ–°
â†“
ãƒ¦ãƒ¼ã‚¶ãƒ¼B: ç·¨é›†ã—ã¦ä¿å­˜
  â†’ version=1 ã§ä¿å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  â†’ DBã®versionã¯2ã«ãªã£ã¦ã„ã‚‹
  â†’ ç«¶åˆæ¤œå‡ºï¼
  â†’ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼Bã«é¸æŠè‚¢ã‚’æç¤º
     1. è‡ªåˆ†ã®å¤‰æ›´ã‚’ç ´æ£„ã—ã¦å†èª­ã¿è¾¼ã¿
     2. è‡ªåˆ†ã®å¤‰æ›´ã§ä¸Šæ›¸ãï¼ˆå¼·åˆ¶ä¿å­˜ï¼‰
     3. å·®åˆ†ã‚’ç¢ºèªã—ã¦æ‰‹å‹•ãƒãƒ¼ã‚¸
```

### å®Ÿè£…ã‚³ãƒ¼ãƒ‰

```php
// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¤‰æ›´
Schema::table('events', function (Blueprint $table) {
    $table->integer('version')->default(0)->after('created_by');
});

Schema::table('shared_notes', function (Blueprint $table) {
    $table->integer('version')->default(0)->after('author_id');
});

Schema::table('surveys', function (Blueprint $table) {
    $table->integer('version')->default(0)->after('created_by');
});

// Controller
public function update(UpdateEventRequest $request, Event $event)
{
    $currentVersion = $request->input('version');
    
    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
    if ($event->version !== $currentVersion) {
        return response()->json([
            'error' => 'conflict',
            'message' => 'ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç·¨é›†ã—ã¦ã„ã¾ã™',
            'current_data' => $event->fresh()->load(['creator', 'participants']),
            'your_changes' => $request->validated(),
        ], 409);
    }
    
    // æ›´æ–°
    $event->update([
        ...$request->validated(),
        'version' => $event->version + 1,
    ]);
    
    return response()->json(['success' => true]);
}

// å¼·åˆ¶ä¿å­˜
public function forceUpdate(UpdateEventRequest $request, Event $event)
{
    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å¼·åˆ¶ä¿å­˜
    $event->update([
        ...$request->validated(),
        'version' => $event->version + 1,
    ]);
    
    // ãƒ­ã‚°ã«è¨˜éŒ²
    UserLog::create([
        'action_type' => 'force_update',
        'action' => 'event_force_updated',
        'target_type' => 'Event',
        'target_id' => $event->event_id,
        'new_value' => json_encode(['reason' => 'ç«¶åˆã‚’ç„¡è¦–ã—ã¦å¼·åˆ¶ä¿å­˜']),
        'changed_by' => auth()->id(),
    ]);
    
    return response()->json(['success' => true]);
}
```

### UIå®Ÿè£…

```vue
<template>
  <!-- ç«¶åˆæ¤œå‡ºãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <Dialog v-model:open="showConflictDialog">
    <DialogContent class="max-w-3xl">
      <DialogHeader>
        <DialogTitle class="flex items-center gap-2 text-orange-600">
          <AlertTriangle class="h-5 w-5" />
          ç·¨é›†ã®ç«¶åˆãŒç™ºç”Ÿã—ã¾ã—ãŸ
        </DialogTitle>
        <DialogDescription>
          ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã“ã®äºˆå®šã‚’ç·¨é›†ã—ã¦ã„ã¾ã™
        </DialogDescription>
      </DialogHeader>
      
      <div class="space-y-4">
        <Alert variant="warning">
          <AlertCircle class="h-4 w-4" />
          <AlertDescription>
            {{ conflictData.updatedBy }}ã•ã‚“ãŒ {{ formatTime(conflictData.updatedAt) }} ã«ç·¨é›†ã—ã¾ã—ãŸ
          </AlertDescription>
        </Alert>
        
        <!-- å·®åˆ†è¡¨ç¤º -->
        <div class="grid grid-cols-2 gap-4">
          <div class="space-y-2">
            <h4 class="font-medium text-sm">ç¾åœ¨ã®å†…å®¹ï¼ˆä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç·¨é›†ï¼‰</h4>
            <div class="p-3 border rounded bg-red-50">
              <div class="text-sm">
                <div><strong>ã‚¿ã‚¤ãƒˆãƒ«:</strong> {{ conflictData.current.title }}</div>
                <div><strong>æ—¥æ™‚:</strong> {{ conflictData.current.date_range }}</div>
                <div><strong>å ´æ‰€:</strong> {{ conflictData.current.location }}</div>
              </div>
            </div>
          </div>
          
          <div class="space-y-2">
            <h4 class="font-medium text-sm">ã‚ãªãŸã®å¤‰æ›´</h4>
            <div class="p-3 border rounded bg-blue-50">
              <div class="text-sm">
                <div><strong>ã‚¿ã‚¤ãƒˆãƒ«:</strong> {{ conflictData.yours.title }}</div>
                <div><strong>æ—¥æ™‚:</strong> {{ conflictData.yours.date_range }}</div>
                <div><strong>å ´æ‰€:</strong> {{ conflictData.yours.location }}</div>
              </div>
            </div>
          </div>
        </div>
        
        <RadioGroup v-model="conflictResolution">
          <div class="space-y-2">
            <div class="flex items-start space-x-3 p-3 border rounded-lg hover:bg-gray-50">
              <RadioGroupItem value="reload" id="reload" />
              <Label for="reload" class="flex-1 cursor-pointer">
                <div class="font-medium">å¤‰æ›´ã‚’ç ´æ£„ã—ã¦å†èª­ã¿è¾¼ã¿</div>
                <div class="text-sm text-gray-500">
                  ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç·¨é›†å†…å®¹ã‚’æ¡ç”¨ã—ã¾ã™ï¼ˆã‚ãªãŸã®å¤‰æ›´ã¯å¤±ã‚ã‚Œã¾ã™ï¼‰
                </div>
              </Label>
            </div>
            
            <div class="flex items-start space-x-3 p-3 border rounded-lg hover:bg-gray-50">
              <RadioGroupItem value="force" id="force" />
              <Label for="force" class="flex-1 cursor-pointer">
                <div class="font-medium text-orange-600">è‡ªåˆ†ã®å¤‰æ›´ã§ä¸Šæ›¸ã</div>
                <div class="text-sm text-gray-500">
                  ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç·¨é›†ã‚’ç„¡è¦–ã—ã¦ã€ã‚ãªãŸã®å¤‰æ›´ã‚’ä¿å­˜ã—ã¾ã™
                </div>
              </Label>
            </div>
          </div>
        </RadioGroup>
      </div>
      
      <DialogFooter>
        <Button variant="outline" @click="showConflictDialog = false">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </Button>
        <Button @click="handleConflictResolution">
          {{ conflictResolution === 'reload' ? 'å†èª­ã¿è¾¼ã¿' : 'ä¸Šæ›¸ãä¿å­˜' }}
        </Button>
      </DialogFooter>
    </DialogContent>
  </Dialog>
</template>

<script setup lang="ts">
const conflictResolution = ref('reload')

const handleConflictResolution = async () => {
  if (conflictResolution.value === 'reload') {
    // å†èª­ã¿è¾¼ã¿
    router.reload()
  } else {
    // å¼·åˆ¶ä¿å­˜
    await axios.post(`/api/events/${event.value.event_id}/force-update`, {
      ...form.value,
    })
    
    toast({
      title: 'ä¿å­˜ã—ã¾ã—ãŸ',
      description: 'ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¤‰æ›´ã‚’ä¸Šæ›¸ãã—ã¾ã—ãŸ',
      variant: 'warning',
    })
  }
  
  showConflictDialog.value = false
}
</script>
```

---

## 23ä»¶ã®ç¢ºèªäº‹é …ã¨LINE WORKSä»•æ§˜ã®å®Œå…¨æ¯”è¼ƒ

### âœ… LINE WORKSã¨åŒã˜ä»•æ§˜ï¼ˆ13ä»¶ï¼‰

| # | é …ç›® | æœ¬ã‚¢ãƒ—ãƒª | LINE WORKS | çŠ¶æ…‹ |
|---|------|---------|-----------|------|
| 1 | éƒ¨ç½²ç®¡ç†è€…å¿…é ˆ | å¿…é ˆ | å¿…é ˆ | âœ… åŒã˜ |
| 3 | éƒ¨ç½²ç„¡åŠ¹åŒ–æ™‚ | é–²è¦§ã®ã¿ | é–²è¦§ã®ã¿ | âœ… åŒã˜ |
| 4 | ç¹°ã‚Šè¿”ã—äºˆå®šã®ç•°å‹•æ™‚ | å…ƒã®éƒ¨ç½²ã«æ®‹ã™ | å…ƒã®éƒ¨ç½²ã«æ®‹ã™ | âœ… åŒã˜ |
| 5 | ã‚´ãƒŸç®±è¡¨ç¤º | éƒ¨ç½²å†…+è¨­å®š | éƒ¨ç½²å†…+è¨­å®š | âœ… åŒã˜ |
| 6 | ä»–éƒ¨ç½²ã«ã¾ãŸãŒã‚‹äºˆå®š | å‚åŠ è€…ãƒ™ãƒ¼ã‚¹è¡¨ç¤º | å‚åŠ è€…ãƒ™ãƒ¼ã‚¹è¡¨ç¤º | âœ… åŒã˜ |
| 7 | éƒ¨ç½²å‰Šé™¤æ™‚ãƒã‚§ãƒƒã‚¯ | ãƒ‡ãƒ¼ã‚¿å­˜åœ¨æ™‚ã‚¨ãƒ©ãƒ¼ | ãƒ‡ãƒ¼ã‚¿å­˜åœ¨æ™‚ã‚¨ãƒ©ãƒ¼ | âœ… åŒã˜ |
| 8 | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¯¾ç­– | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹+ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹+ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | âœ… åŒã˜ |
| 10 | éƒ¨ç½²åå¤‰æ›´ | è‡ªå‹•åæ˜  | è‡ªå‹•åæ˜  | âœ… åŒã˜ |
| 12 | éƒ¨ç½²éšå±¤æ§‹é€  | ä¿ç•™ | å¯¾å¿œ | âš ï¸ å°†æ¥å¯¾å¿œ |
| 16 | é€šçŸ¥æ©Ÿèƒ½ | é‡è¦ãªäºˆå®šã®ã¿ | é‡è¦ãªäºˆå®šã®ã¿ | âœ… åŒã˜ |
| 17 | å¤–éƒ¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æº | ä¸è¦ | å¯¾å¿œ | âš ï¸ å°†æ¥å¯¾å¿œ |
| 18 | ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ | ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– | ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– | âœ… åŒã˜ |
| 19 | ç›£æŸ»ãƒ­ã‚° | é‡è¦ãªå¤‰æ›´ã®ã¿ | é‡è¦ãªå¤‰æ›´ã®ã¿ | âœ… åŒã˜ |

### ğŸ”„ æœ¬ã‚¢ãƒ—ãƒªç‹¬è‡ªã®ä»•æ§˜ï¼ˆã‚ˆã‚Šè‰¯ã„å®Ÿè£…ï¼‰ï¼ˆ4ä»¶ï¼‰

| # | é …ç›® | LINE WORKS | æœ¬ã‚¢ãƒ—ãƒª | ç†ç”± |
|---|------|-----------|---------|------|
| 11 | è¤‡æ•°éƒ¨ç½²ç®¡ç†è€… | å¯¾å¿œ | ä¸è¦ | 50åè¦æ¨¡ã§ã¯ä¸è¦ |
| 15 | é€€è·è€…é™¤å¤– | æ‰‹å‹• | è‡ªå‹• | 50åè¦æ¨¡ã§ã¯è‡ªå‹•åŒ–ãŒåŠ¹ç‡çš„ |
| 21 | éƒ¨ç½²çµ±å»ƒåˆ | æ‰‹å‹• | è‡ªå‹• | 50åè¦æ¨¡ã§ã¯è‡ªå‹•åŒ–ãŒåŠ¹ç‡çš„ |
| 23 | åŒæ™‚ç·¨é›†ç«¶åˆ | æœ€çµ‚æ›´æ–°å„ªå…ˆ | æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ | ã‚ˆã‚Šå®‰å…¨ |

### ğŸ”´ LINE WORKSã«åˆã‚ã›ã¦å¤‰æ›´ï¼ˆ3ä»¶ï¼‰

| # | é …ç›® | å½“åˆè¨­è¨ˆ | LINE WORKS | å¤‰æ›´å†…å®¹ |
|---|------|---------|-----------|---------|
| 13 | å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æŠ•ç¨¿ | ç›´æ¥æŠ•ç¨¿ | æ‰¿èªãƒ•ãƒ­ãƒ¼ | âœ… æ‰¿èªåˆ¶ã«å¤‰æ›´ |
| 14 | ä»–éƒ¨ç½²ãƒ‡ãƒ¼ã‚¿å…±æœ‰ | è¤‡è£½ | å…±æœ‰ | âœ… å…±æœ‰æ–¹å¼ã«å¤‰æ›´ |
| 22 | ç¹°ã‚Šè¿”ã—äºˆå®šå±•é–‹ | 3ãƒ¶æœˆäº‹å‰å±•é–‹ | å‹•çš„å±•é–‹ | âœ… å‹•çš„å±•é–‹ã«å¤‰æ›´ |

### âš ï¸ æœªç¢ºèªãƒ»ä¿ç•™ï¼ˆ3ä»¶ï¼‰

| # | é …ç›® | çŠ¶æ…‹ | å‚™è€ƒ |
|---|------|------|------|
| 9 | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ··ä¹± | å¯¾å¿œæ¸ˆã¿ | ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆå……å®Ÿ |
| 20 | ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— | è¦å¯¾å¿œ | XServer+æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— |
| - | å¤§é‡ãƒ‡ãƒ¼ã‚¿ | å¯¾å¿œæ¸ˆã¿ | å‹•çš„å±•é–‹ã§è§£æ±º |

---

## LINE WORKSã¨ã®æœ€çµ‚ä»•æ§˜å·®ç•°ï¼ˆé‡è¦ï¼‰

### å·®ç•°1: å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æŠ•ç¨¿ã®æ‰¿èªãƒ•ãƒ­ãƒ¼

**å®Ÿè£…ã®è¿½åŠ ãŒå¿…è¦**:

```sql
CREATE TABLE company_event_requests (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    event_data JSON NOT NULL,
    requested_by BIGINT NOT NULL,
    requested_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending',
    reviewed_by BIGINT NULL,
    reviewed_at TIMESTAMP NULL,
    review_comment TEXT NULL,
    FOREIGN KEY (requested_by) REFERENCES users(id),
    FOREIGN KEY (reviewed_by) REFERENCES users(id),
    INDEX idx_status (status),
    INDEX idx_requested_by (requested_by)
);
```

**ãƒ•ãƒ­ãƒ¼**:
```
1. éƒ¨ç½²ç®¡ç†è€…ãŒå…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¸ã®æŠ•ç¨¿ã‚’ç”³è«‹
2. å…¨ç¤¾ç®¡ç†è€…ã«é€šçŸ¥ãŒå±Šã
3. å…¨ç¤¾ç®¡ç†è€…ãŒæ‰¿èª/å´ä¸‹
4. æ‰¿èªã•ã‚ŒãŸå ´åˆã€å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«äºˆå®šãŒä½œæˆã•ã‚Œã‚‹
5. ç”³è«‹è€…ã«çµæœãŒé€šçŸ¥ã•ã‚Œã‚‹
```

### å·®ç•°2: å…±æœ‰æ–¹å¼ï¼ˆè¤‡è£½â†’å…±æœ‰ï¼‰

**å®Ÿè£…ã®è¿½åŠ ãŒå¿…è¦**:

```sql
CREATE TABLE calendar_event_shares (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    calendar_id BIGINT NOT NULL,
    event_id BIGINT NOT NULL,
    shared_by BIGINT NOT NULL,
    shared_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY unique_calendar_event (calendar_id, event_id),
    FOREIGN KEY (calendar_id) REFERENCES calendars(calendar_id) ON DELETE CASCADE,
    FOREIGN KEY (event_id) REFERENCES events(event_id) ON DELETE CASCADE,
    FOREIGN KEY (shared_by) REFERENCES users(id),
    INDEX idx_calendar (calendar_id),
    INDEX idx_event (event_id)
);
```

**å‹•ä½œ**:
- 1ã¤ã®äºˆå®šãŒè¤‡æ•°ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹
- ã©ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ç·¨é›†ã—ã¦ã‚‚ã€åŒã˜ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã‚‹
- å…±æœ‰ã‚’è§£é™¤ã™ã‚‹ã¨ã€ãã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ã¯è¦‹ãˆãªããªã‚‹

### å·®ç•°3: ç¹°ã‚Šè¿”ã—äºˆå®šã®å‹•çš„å±•é–‹

**å®Ÿè£…ã®å¤‰æ›´ãŒå¿…è¦**:

```php
// EventService ã®å¤‰æ›´
public function getExpandedEvents(string $startDate, string $endDate, ?int $memberId = null): array
{
    // è¡¨ç¤ºç¯„å›²ã®ã¿å±•é–‹ï¼ˆ3ãƒ¶æœˆåˆ¶é™ã‚’æ’¤å»ƒï¼‰
    // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ startDate, endDate ã®ç¯„å›²ã®ã¿å±•é–‹
    
    $events = Event::with(['creator', 'participants', 'recurrence'])
        ->where('is_exception', false)
        ->get();
    
    $expandedEvents = [];
    
    foreach ($events as $event) {
        if ($event->recurrence) {
            // æŒ‡å®šç¯„å›²ã®ã¿å±•é–‹
            $expandedEvents = array_merge(
                $expandedEvents, 
                $this->expandRecurringEvent($event, $startDate, $endDate)
            );
        } else {
            if ($event->start_date <= $endDate && $event->end_date >= $startDate) {
                $expandedEvents[] = $this->formatExpandedEvent($event, $event->event_id);
            }
        }
    }
    
    return $expandedEvents;
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è‚¥å¤§åŒ–ã‚’é˜²ã
- ä»»æ„ã®æœŸé–“ã‚’è¡¨ç¤ºå¯èƒ½
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š

---

## é–‹ç™ºæœŸé–“ã®å†è¦‹ç©ã‚‚ã‚Š

### è¿½åŠ å®Ÿè£…ã«ã‚ˆã‚‹å½±éŸ¿

**è¿½åŠ æ©Ÿèƒ½**:
1. å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ‰¿èªãƒ•ãƒ­ãƒ¼: +2é€±é–“
2. å…±æœ‰æ–¹å¼ã®å®Ÿè£…: +2é€±é–“
3. å‹•çš„å±•é–‹ã®å®Ÿè£…: +1é€±é–“ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®èª¿æ•´ã®ã¿ï¼‰

**åˆè¨ˆ**: 5.5ãƒ¶æœˆ â†’ **6.5ãƒ¶æœˆ**

### æ›´æ–°å¾Œã®ãƒ•ã‚§ãƒ¼ã‚º

- ãƒ•ã‚§ãƒ¼ã‚º1: åŸºç›¤æ•´å‚™ï¼ˆ1.5ãƒ¶æœˆï¼‰
- ãƒ•ã‚§ãƒ¼ã‚º2: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ‹¡å¼µï¼ˆ**2.5ãƒ¶æœˆ** â† +0.5ãƒ¶æœˆï¼‰
- ãƒ•ã‚§ãƒ¼ã‚º3: ãƒ¡ãƒ¢ãƒ»ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ‹¡å¼µï¼ˆ**1.5ãƒ¶æœˆ** â† +0.5ãƒ¶æœˆï¼‰
- ãƒ•ã‚§ãƒ¼ã‚º4: ã‚´ãƒŸç®±ãƒ»æœ€é©åŒ–ï¼ˆ1ãƒ¶æœˆï¼‰

**åˆè¨ˆé–‹ç™ºæœŸé–“: 6.5ãƒ¶æœˆ**

---

## å…¨ç¢ºèªäº‹é …ã®æœ€çµ‚ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ç¢ºå®šæ¸ˆã¿ï¼ˆ23ä»¶å…¨ã¦ï¼‰

- [x] 1. éƒ¨ç½²ç®¡ç†è€…å¿…é ˆè¨­å®š
- [x] 2. å…¨ç¤¾ç®¡ç†è€…æ¨©é™ç¯„å›²
- [x] 3. éƒ¨ç½²ç„¡åŠ¹åŒ–æ™‚ã®æ‰±ã„
- [x] 4. ç¹°ã‚Šè¿”ã—äºˆå®šã®ç•°å‹•æ™‚
- [x] 5. ã‚´ãƒŸç®±è¡¨ç¤ºè¨­å®š
- [x] 6. ä»–éƒ¨ç½²ã«ã¾ãŸãŒã‚‹äºˆå®š
- [x] 7. ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ä¿è¨¼
- [x] 8. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¯¾ç­–
- [x] 9. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ··ä¹±é˜²æ­¢
- [x] 10. éƒ¨ç½²åå¤‰æ›´æ™‚ã®å½±éŸ¿
- [x] 11. è¤‡æ•°éƒ¨ç½²ç®¡ç†è€…ï¼ˆä¸è¦ï¼‰
- [x] 12. éƒ¨ç½²éšå±¤æ§‹é€ ï¼ˆä¿ç•™ï¼‰
- [x] 13. å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æŠ•ç¨¿ï¼ˆæ‰¿èªåˆ¶ï¼‰
- [x] 14. ãƒ‡ãƒ¼ã‚¿å…±æœ‰æ–¹å¼ï¼ˆå…±æœ‰ï¼‰
- [x] 15. é€€è·è€…ãƒ‡ãƒ¼ã‚¿æ‰±ã„ï¼ˆè‡ªå‹•ï¼‰
- [x] 16. é€šçŸ¥æ©Ÿèƒ½ï¼ˆé‡è¦ã®ã¿ï¼‰
- [x] 17. å¤–éƒ¨é€£æºï¼ˆä¸è¦ï¼‰
- [x] 18. ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ï¼‰
- [x] 19. ç›£æŸ»ãƒ­ã‚°ï¼ˆé‡è¦å¤‰æ›´ã®ã¿ï¼‰
- [x] 20. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆXServer+æ‰‹å‹•ï¼‰
- [x] 21. éƒ¨ç½²çµ±å»ƒåˆï¼ˆè‡ªå‹•ï¼‰
- [x] 22. å¤§é‡ãƒ‡ãƒ¼ã‚¿ï¼ˆå‹•çš„å±•é–‹ï¼‰
- [x] 23. åŒæ™‚ç·¨é›†ç«¶åˆï¼ˆæ¥½è¦³çš„ãƒ­ãƒƒã‚¯ï¼‰

### LINE WORKSã¨ã®å·®ç•°ï¼ˆæœ€çµ‚ç‰ˆï¼‰

**å®Œå…¨ä¸€è‡´**: 13ä»¶
**æœ¬ã‚¢ãƒ—ãƒªç‹¬è‡ªï¼ˆã‚ˆã‚Šè‰¯ã„ï¼‰**: 4ä»¶
**LINE WORKSã«åˆã‚ã›ã¦å¤‰æ›´**: 3ä»¶
**å°†æ¥å¯¾å¿œ**: 2ä»¶
**ä¸è¦**: 1ä»¶

---

**æ›´æ–°æ—¥**: 2025å¹´1æœˆ
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.3ï¼ˆæœ€çµ‚ç‰ˆï¼‰
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: å…¨ç¢ºèªäº‹é …å®Œäº†ã€å®Ÿè£…æº–å‚™å®Œäº†
