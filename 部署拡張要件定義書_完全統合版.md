# éƒ¨ç½²æ‹¡å¼µè¦ä»¶å®šç¾©æ›¸ï¼ˆå®Œå…¨çµ±åˆç‰ˆï¼‰

## ğŸ“‹ ç›®æ¬¡

### 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦
- [1.1 èƒŒæ™¯ã¨ç›®çš„](#11-èƒŒæ™¯ã¨ç›®çš„)
- [1.2 ç¢ºå®šäº‹é …](#12-ç¢ºå®šäº‹é …)
- [1.3 é–‹ç™ºã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«](#13-é–‹ç™ºã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«)

### 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ
- [2.1 æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«](#21-æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«)
- [2.2 å¤‰æ›´ãƒ†ãƒ¼ãƒ–ãƒ«](#22-å¤‰æ›´ãƒ†ãƒ¼ãƒ–ãƒ«)
- [2.3 ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥](#23-ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥)
- [2.4 ãƒ‡ãƒ¼ã‚¿ç§»è¡Œè¨ˆç”»](#24-ãƒ‡ãƒ¼ã‚¿ç§»è¡Œè¨ˆç”»)

### 3. ä¸»è¦æ©Ÿèƒ½ã®å®Ÿè£…
- [3.1 å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ‰¿èªãƒ•ãƒ­ãƒ¼](#31-å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ‰¿èªãƒ•ãƒ­ãƒ¼)
- [3.2 ãƒ‡ãƒ¼ã‚¿å…±æœ‰æ©Ÿèƒ½](#32-ãƒ‡ãƒ¼ã‚¿å…±æœ‰æ©Ÿèƒ½)
- [3.3 ç¹°ã‚Šè¿”ã—äºˆå®šã®å‹•çš„å±•é–‹](#33-ç¹°ã‚Šè¿”ã—äºˆå®šã®å‹•çš„å±•é–‹)
- [3.4 åŒæ™‚ç·¨é›†ç«¶åˆå‡¦ç†](#34-åŒæ™‚ç·¨é›†ç«¶åˆå‡¦ç†)
- [3.5 ç›£æŸ»ãƒ­ã‚°](#35-ç›£æŸ»ãƒ­ã‚°)

### 4. æ¨©é™ç®¡ç†
- [4.1 æ¨©é™ãƒãƒˆãƒªã‚¯ã‚¹](#41-æ¨©é™ãƒãƒˆãƒªã‚¯ã‚¹)
- [4.2 æ¨©é™ãƒã‚§ãƒƒã‚¯å®Ÿè£…](#42-æ¨©é™ãƒã‚§ãƒƒã‚¯å®Ÿè£…)

### 5. é‹ç”¨è©³ç´°
- [5.1 éƒ¨ç½²ç•°å‹•æ™‚ã®å‡¦ç†](#51-éƒ¨ç½²ç•°å‹•æ™‚ã®å‡¦ç†)
- [5.2 é€€è·è€…ãƒ‡ãƒ¼ã‚¿å‡¦ç†](#52-é€€è·è€…ãƒ‡ãƒ¼ã‚¿å‡¦ç†)
- [5.3 éƒ¨ç½²çµ±å»ƒåˆ](#53-éƒ¨ç½²çµ±å»ƒåˆ)
- [5.4 éƒ¨ç½²ç®¡ç†è€…é‹ç”¨](#54-éƒ¨ç½²ç®¡ç†è€…é‹ç”¨)

### 6. UI/UXè¨­è¨ˆ
- [6.1 å…±æœ‰äºˆå®šç®¡ç†UI](#61-å…±æœ‰äºˆå®šç®¡ç†ui)
- [6.2 ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¸æŠUI](#62-ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¸æŠui)
- [6.3 ç«¶åˆè§£æ±ºUI](#63-ç«¶åˆè§£æ±ºui)

### 7. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
- [7.1 N+1å•é¡Œã®é˜²æ­¢](#71-n1å•é¡Œã®é˜²æ­¢)
- [7.2 ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥](#72-ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥)
- [7.3 ã‚¯ã‚¨ãƒªæœ€é©åŒ–](#73-ã‚¯ã‚¨ãƒªæœ€é©åŒ–)

### 8. ãƒªã‚¹ã‚¯ç®¡ç†
- [8.1 æŠ€è¡“çš„ãƒªã‚¹ã‚¯](#81-æŠ€è¡“çš„ãƒªã‚¹ã‚¯)
- [8.2 é‹ç”¨çš„ãƒªã‚¹ã‚¯](#82-é‹ç”¨çš„ãƒªã‚¹ã‚¯)

### 9. å…ˆæ–¹ç¢ºèªäº‹é …
- [9.1 é‹ç”¨é¢ã®ç¢ºèªï¼ˆ8é …ç›®ï¼‰](#91-é‹ç”¨é¢ã®ç¢ºèª)
- [9.2 æŠ€è¡“é¢ã®ç¢ºèªï¼ˆ8é …ç›®ï¼‰](#92-æŠ€è¡“é¢ã®ç¢ºèª)

### 10. è£œè¶³è³‡æ–™
- [10.1 Observerå®Ÿè£…](#101-observerå®Ÿè£…)
- [10.2 ç§»è¡Œã‚³ãƒãƒ³ãƒ‰å®Ÿè£…](#102-ç§»è¡Œã‚³ãƒãƒ³ãƒ‰å®Ÿè£…)
- [10.3 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥](#103-ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥)

### 11. è©³ç´°æ©Ÿèƒ½ä»•æ§˜
- [11.1 ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»ãƒ¡ãƒ¢ãƒ»ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯](#111-ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ¡ãƒ¢ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯)
- [11.2 ã‚´ãƒŸç®±ã®éƒ¨ç½²ç®¡ç†](#112-ã‚´ãƒŸç®±ã®éƒ¨ç½²ç®¡ç†)
- [11.3 ä»–éƒ¨ç½²ã«ã¾ãŸãŒã‚‹äºˆå®šã®æ‰±ã„](#113-ä»–éƒ¨ç½²ã«ã¾ãŸãŒã‚‹äºˆå®šã®æ‰±ã„)
- [11.4 æ¨ªæ–­æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼](#114-æ¨ªæ–­æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼)

### 12. LINE WORKSã¨ã®ä»•æ§˜å·®ç•°
- [12.1 å®Œå…¨ä¸€è‡´](#121-å®Œå…¨ä¸€è‡´)
- [12.2 æœ¬ã‚¢ãƒ—ãƒªç‹¬è‡ª](#122-æœ¬ã‚¢ãƒ—ãƒªç‹¬è‡ª)
- [12.3 LINE WORKSã«åˆã‚ã›ã¦å¤‰æ›´](#123-line-worksã«åˆã‚ã›ã¦å¤‰æ›´)

### 13. è¿½åŠ ã®UIå®Ÿè£…ä¾‹
- [13.1 éƒ¨ç½²ç•°å‹•ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°](#131-éƒ¨ç½²ç•°å‹•ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°)
- [13.2 é€€è·è€…ç„¡åŠ¹åŒ–ãƒ€ã‚¤ã‚¢ãƒ­ã‚°](#132-é€€è·è€…ç„¡åŠ¹åŒ–ãƒ€ã‚¤ã‚¢ãƒ­ã‚°)
- [13.3 éƒ¨ç½²çµ±å»ƒåˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°](#133-éƒ¨ç½²çµ±å»ƒåˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°)

### 14. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ãƒ»UIè©³ç´°ä»•æ§˜
- [14.1 æ–°è¦ç™»éŒ²æ™‚ã®éƒ¨ç½²é¸æŠ](#141-æ–°è¦ç™»éŒ²æ™‚ã®éƒ¨ç½²é¸æŠ)
- [14.2 ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šã®åç§°å¤‰æ›´](#142-ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šã®åç§°å¤‰æ›´)
- [14.3 éƒ¨ç½²åå¤‰æ›´ã‚’é¸æŠå¼ã«](#143-éƒ¨ç½²åå¤‰æ›´ã‚’é¸æŠå¼ã«)
- [14.4 åˆæœŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ](#144-åˆæœŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ)
- [14.5 éƒ¨ç½²ãƒ¡ãƒ³ãƒãƒ¼è¡¨ç¤º](#145-éƒ¨ç½²ãƒ¡ãƒ³ãƒãƒ¼è¡¨ç¤º)
- [14.6 ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆ‡ã‚Šæ›¿ãˆã¨æ¨©é™ã®è©³ç´°](#146-ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆ‡ã‚Šæ›¿ãˆã¨æ¨©é™ã®è©³ç´°)
- [14.7 å…±æœ‰ãƒ¡ãƒ¢ã®åˆ‡ã‚Šæ›¿ãˆé€£å‹•](#147-å…±æœ‰ãƒ¡ãƒ¢ã®åˆ‡ã‚Šæ›¿ãˆé€£å‹•)
- [14.8 é€šçŸ¥ã‚»ãƒ³ã‚¿ãƒ¼è¨­å®š](#148-é€šçŸ¥ã‚»ãƒ³ã‚¿ãƒ¼è¨­å®š)

### 15. è¿½åŠ ã®ãƒªã‚¹ã‚¯ã¨å¯¾ç­–
- [15.1 ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®ãƒªã‚¹ã‚¯](#151-ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®ãƒªã‚¹ã‚¯)
- [15.2 æ¤œç´¢æ©Ÿèƒ½ã®éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼](#152-æ¤œç´¢æ©Ÿèƒ½ã®éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼)
- [15.3 æ¨©é™é™æ ¼æ™‚ã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†](#153-æ¨©é™é™æ ¼æ™‚ã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†)
- [15.4 ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ](#154-ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
- [15.5 éƒ¨ç½²æ•°å¢—åŠ æ™‚ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹](#155-éƒ¨ç½²æ•°å¢—åŠ æ™‚ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹)

---

## 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

### 1.1 èƒŒæ™¯ã¨ç›®çš„

**èƒŒæ™¯**: ç·å‹™éƒ¨ã§ã®å˜ä¸€éƒ¨ç½²é‹ç”¨ã‹ã‚‰ã€å…¨ç¤¾å±•é–‹ï¼ˆ50åè¦æ¨¡ï¼‰ã¸ã®æ‹¡å¼µ

**ç›®çš„**:
- éƒ¨ç½²ã”ã¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»ãƒ¡ãƒ¢ãƒ»ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç®¡ç†
- å…¨ç¤¾å…¬é–‹ã¨éƒ¨ç½²é™å®šã®ä½¿ã„åˆ†ã‘
- éƒ¨ç½²é–“ã®ãƒ‡ãƒ¼ã‚¿å…±æœ‰ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã®ä¸¡ç«‹

### 1.2 ç¢ºå®šäº‹é …

#### âœ… å®Ÿè£…ã™ã‚‹æ©Ÿèƒ½

| æ©Ÿèƒ½ | æ–¹é‡ | ç†ç”± |
|------|------|------|
| å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æŠ•ç¨¿ | æ‰¿èªãƒ•ãƒ­ãƒ¼å¿…é ˆ | å“è³ªç®¡ç†ãƒ»çµ±åˆ¶ |
| ãƒ‡ãƒ¼ã‚¿å…±æœ‰ | å…±æœ‰æ–¹å¼ï¼ˆåŒä¸€ãƒ‡ãƒ¼ã‚¿ï¼‰ | æ•´åˆæ€§ä¿è¨¼ |
| ç¹°ã‚Šè¿”ã—äºˆå®š | å‹•çš„å±•é–‹ | DBè‚¥å¤§åŒ–é˜²æ­¢ |
| åŒæ™‚ç·¨é›†ç«¶åˆ | æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ | ãƒ‡ãƒ¼ã‚¿æå¤±é˜²æ­¢ |
| ç›£æŸ»ãƒ­ã‚° | å…±æœ‰äºˆå®šã®ã¿è¨˜éŒ² | æœ€å°é™ã®è¿½è·¡ |
| éƒ¨ç½²ç®¡ç†è€…é‹ç”¨ | å¿…é ˆè¨­å®šãƒ»è‡ªå‹•é€šçŸ¥ | ç®¡ç†ä¸å…¨é˜²æ­¢ |
| ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— | XServer + AWS S3 | äºŒé‡åŒ–ï¼ˆå¹´360å††ï¼‰ |

#### âŒ å®Ÿè£…ã—ãªã„æ©Ÿèƒ½

| æ©Ÿèƒ½ | ç†ç”± |
|------|------|
| è¤‡æ•°äººã®éƒ¨ç½²ç®¡ç†è€… | 50åè¦æ¨¡ã§ã¯ä¸è¦ |
| éƒ¨ç½²éšå±¤æ§‹é€  | ç¾æ™‚ç‚¹ã§ä¸è¦ |
| PWAåŒ– | ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã§ååˆ† |
| å¤–éƒ¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æº | è¦æœ›ãªã— |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° | æ—¢ã«èª¬æ˜ä¼šå®Ÿæ–½æ¸ˆã¿ |

### 1.3 é–‹ç™ºã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

| ãƒ•ã‚§ãƒ¼ã‚º | æœŸé–“ | å†…å®¹ |
|---------|------|------|
| ãƒ•ã‚§ãƒ¼ã‚º0 | äº‹å‰ | ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æº–å‚™ãƒ»ãƒ†ã‚¹ãƒˆ |
| ãƒ•ã‚§ãƒ¼ã‚º1 | 1.5ãƒ¶æœˆ | åŸºç›¤æ•´å‚™ï¼ˆéƒ¨ç½²ãƒã‚¹ã‚¿ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å¯¾å¿œï¼‰ |
| ãƒ•ã‚§ãƒ¼ã‚º2 | 2.5ãƒ¶æœˆ | ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ‹¡å¼µï¼ˆæ‰¿èªãƒ•ãƒ­ãƒ¼ã€å…±æœ‰ã€å‹•çš„å±•é–‹ã€ç«¶åˆå‡¦ç†ï¼‰ |
| ãƒ•ã‚§ãƒ¼ã‚º3 | 1.5ãƒ¶æœˆ | ãƒ¡ãƒ¢ãƒ»ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ‹¡å¼µ |
| ãƒ•ã‚§ãƒ¼ã‚º4 | 1ãƒ¶æœˆ | æœ€é©åŒ–ãƒ»ãƒ†ã‚¹ãƒˆ |
| **åˆè¨ˆ** | **6.5ãƒ¶æœˆ** | |

---

## 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 2.1 æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«

#### â‘  éƒ¨ç½²ãƒã‚¹ã‚¿

```sql
CREATE TABLE departments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL UNIQUE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_active (is_active)
);
```

#### â‘¡ å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ‰¿èª

```sql
CREATE TABLE company_event_requests (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    event_data JSON NOT NULL,
    requested_by BIGINT NOT NULL,
    requested_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending',
    reviewed_by BIGINT NULL,
    reviewed_at TIMESTAMP NULL,
    review_comment TEXT NULL,
    FOREIGN KEY (requested_by) REFERENCES users(id),
    FOREIGN KEY (reviewed_by) REFERENCES users(id),
    INDEX idx_status (status),
    INDEX idx_requested_by (requested_by)
);
```

#### â‘¢ äºˆå®šå…±æœ‰

```sql
CREATE TABLE calendar_event_shares (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    calendar_id BIGINT NOT NULL,
    event_id BIGINT NOT NULL,
    shared_by BIGINT NOT NULL,
    shared_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY unique_share (calendar_id, event_id),
    FOREIGN KEY (calendar_id) REFERENCES calendars(calendar_id) ON DELETE CASCADE,
    FOREIGN KEY (event_id) REFERENCES events(event_id) ON DELETE CASCADE,
    FOREIGN KEY (shared_by) REFERENCES users(id),
    INDEX idx_calendar (calendar_id),
    INDEX idx_event (event_id)
);
```

#### â‘£ ç›£æŸ»ãƒ­ã‚°

```sql
CREATE TABLE audit_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    action VARCHAR(50) NOT NULL,
    user_id BIGINT NOT NULL,
    event_id BIGINT NULL,
    calendar_id BIGINT NULL,
    details JSON NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_action (action),
    INDEX idx_event (event_id),
    INDEX idx_created_at (created_at)
);
```

### 2.2 å¤‰æ›´ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
-- users
ALTER TABLE users 
    ADD COLUMN department_id BIGINT NULL AFTER email,
    ADD COLUMN role_type ENUM('member', 'department_admin', 'company_admin') 
        DEFAULT 'member' AFTER role,
    ADD FOREIGN KEY fk_users_department (department_id) 
        REFERENCES departments(id) ON DELETE SET NULL;

-- calendars
ALTER TABLE calendars
    ADD COLUMN owner_type ENUM('department', 'company') 
        NOT NULL DEFAULT 'company' AFTER calendar_type,
    ADD COLUMN owner_id BIGINT NULL AFTER owner_type,
    ADD FOREIGN KEY fk_calendars_department (owner_id) 
        REFERENCES departments(id) ON DELETE CASCADE;

-- events
ALTER TABLE events
    ADD COLUMN visibility_type ENUM('public', 'department', 'custom', 'private') 
        NOT NULL DEFAULT 'custom' AFTER category,
    ADD COLUMN owner_department_id BIGINT NULL AFTER visibility_type,
    ADD COLUMN version INT DEFAULT 0 AFTER created_by,
    ADD FOREIGN KEY fk_events_department (owner_department_id) 
        REFERENCES departments(id) ON DELETE SET NULL;

-- shared_notes
ALTER TABLE shared_notes
    ADD COLUMN visibility_type ENUM('public', 'department', 'custom', 'private') 
        NOT NULL DEFAULT 'custom' AFTER priority,
    ADD COLUMN owner_department_id BIGINT NULL AFTER visibility_type,
    ADD COLUMN version INT DEFAULT 0 AFTER author_id,
    ADD FOREIGN KEY fk_notes_department (owner_department_id) 
        REFERENCES departments(id) ON DELETE SET NULL;

-- surveys
ALTER TABLE surveys
    ADD COLUMN visibility_type ENUM('public', 'department', 'custom', 'private') 
        NOT NULL DEFAULT 'custom' AFTER is_active,
    ADD COLUMN owner_department_id BIGINT NULL AFTER visibility_type,
    ADD COLUMN version INT DEFAULT 0 AFTER created_by,
    ADD FOREIGN KEY fk_surveys_department (owner_department_id) 
        REFERENCES departments(id) ON DELETE SET NULL;

-- trash_items
ALTER TABLE trash_items
    ADD COLUMN owner_department_id BIGINT NULL AFTER item_id,
    ADD COLUMN visibility_type VARCHAR(20) NULL AFTER owner_department_id,
    ADD FOREIGN KEY fk_trash_department (owner_department_id) 
        REFERENCES departments(id) ON DELETE SET NULL;

-- user_preferences
ALTER TABLE user_preferences
    ADD COLUMN show_company_calendar_in_trash BOOLEAN DEFAULT FALSE;
```

### 2.3 ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨ã¯**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã€Œç›®æ¬¡ã€ã€‚æ¤œç´¢ã‚’100å€é«˜é€ŸåŒ–ï¼ˆ500ms â†’ 5msï¼‰

#### å¿…é ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ15å€‹ï¼‰

```sql
-- éƒ¨ç½²é–¢é€£ï¼ˆ3å€‹ï¼‰
CREATE INDEX idx_users_department ON users(department_id);
CREATE INDEX idx_users_role_type ON users(role_type);
CREATE INDEX idx_departments_active ON departments(is_active);

-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–¢é€£ï¼ˆ5å€‹ï¼‰
CREATE INDEX idx_calendars_owner ON calendars(owner_type, owner_id);
CREATE INDEX idx_events_visibility_dept ON events(visibility_type, owner_department_id);
CREATE INDEX idx_events_dates ON events(start_date, end_date);
CREATE INDEX idx_events_created_by ON events(created_by);
CREATE INDEX idx_events_calendar ON events(calendar_id);

-- å…±æœ‰é–¢é€£ï¼ˆ2å€‹ï¼‰
CREATE INDEX idx_shares_calendar ON calendar_event_shares(calendar_id);
CREATE INDEX idx_shares_event ON calendar_event_shares(event_id);

-- å‚åŠ è€…é–¢é€£ï¼ˆ2å€‹ï¼‰
CREATE INDEX idx_participants_user ON event_participants(user_id);
CREATE INDEX idx_participants_event ON event_participants(event_id);

-- ãã®ä»–ï¼ˆ3å€‹ï¼‰
CREATE INDEX idx_notes_visibility_dept ON shared_notes(visibility_type, owner_department_id);
CREATE INDEX idx_surveys_visibility_dept ON surveys(visibility_type, owner_department_id);
CREATE INDEX idx_trash_department ON trash_items(owner_department_id);
```

### 2.4 ãƒ‡ãƒ¼ã‚¿ç§»è¡Œè¨ˆç”»

#### äº‹å‰æº–å‚™ï¼ˆå¿…é ˆï¼‰

```bash
# 1. å®Œå…¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
mysqldump -u user -p database > backup_$(date +%Y%m%d_%H%M%S).sql

# 2. ãƒ†ã‚¹ãƒˆç’°å¢ƒã§3å›ä»¥ä¸Šæ¤œè¨¼
php artisan migrate:department-system --env=testing

# 3. å®Ÿè¡Œæ™‚é–“è¨ˆæ¸¬ï¼ˆç›®æ¨™: 1-2åˆ†ä»¥å†…ï¼‰

# 4. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ç¢ºèª
mysql -u user -p database < backup_20250120_020000.sql
```

#### æœ¬ç•ªå®Ÿè¡Œæ‰‹é †

```bash
# 1. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰
php artisan down --message="ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ä¸­ï¼ˆç´„5åˆ†ï¼‰"

# 2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
php artisan migrate:department-system

# 3. å‹•ä½œç¢ºèª
php artisan tinker
>>> User::with('department')->first()
>>> Event::with('calendar')->first()

# 4. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰è§£é™¤
php artisan up
```

---

## 3. ä¸»è¦æ©Ÿèƒ½ã®å®Ÿè£…

### 3.1 å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ‰¿èªãƒ•ãƒ­ãƒ¼

#### ãƒ•ãƒ­ãƒ¼

```
éƒ¨ç½²ç®¡ç†è€…ãŒç”³è«‹ â†’ å…¨ç¤¾ç®¡ç†è€…ã«é€šçŸ¥ â†’ æ‰¿èª/å´ä¸‹ â†’ çµæœé€šçŸ¥
```

#### å®Ÿè£…

```php
// ç”³è«‹
public function requestCompanyEvent(Request $request)
{
    CompanyEventRequest::create([
        'event_data' => json_encode($request->validated()),
        'requested_by' => auth()->id(),
    ]);
    
    Notification::send(
        User::where('role_type', 'company_admin')->get(),
        new CompanyEventRequested()
    );
}

// æ‰¿èª
public function approve(CompanyEventRequest $request)
{
    Event::create([
        ...json_decode($request->event_data, true),
        'calendar_id' => $this->getCompanyCalendar()->id,
    ]);
    
    $request->update([
        'status' => 'approved',
        'reviewed_by' => auth()->id(),
        'reviewed_at' => now(),
    ]);
}

// å´ä¸‹
public function reject(CompanyEventRequest $request, string $comment)
{
    $request->update([
        'status' => 'rejected',
        'reviewed_by' => auth()->id(),
        'reviewed_at' => now(),
        'review_comment' => $comment,
    ]);
    
    Notification::send(
        User::find($request->requested_by),
        new CompanyEventRejected($request)
    );
}
```

### 3.2 ãƒ‡ãƒ¼ã‚¿å…±æœ‰æ©Ÿèƒ½

#### å®Ÿè£…

```php
// å…±æœ‰
public function shareToCalendar(Event $event, int $calendarId)
{
    CalendarEventShare::create([
        'calendar_id' => $calendarId,
        'event_id' => $event->event_id,
        'shared_by' => auth()->id(),
    ]);
    
    // ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²
    AuditLog::create([
        'action' => 'event_shared',
        'user_id' => auth()->id(),
        'event_id' => $event->event_id,
        'calendar_id' => $calendarId,
        'details' => json_encode([
            'event_title' => $event->title,
            'shared_to' => Calendar::find($calendarId)->calendar_name,
        ]),
    ]);
}

// è¡¨ç¤º
public function getEventsForCalendar(int $calendarId)
{
    return Event::where('calendar_id', $calendarId)
        ->orWhereHas('shares', fn($q) => $q->where('calendar_id', $calendarId))
        ->with(['creator', 'participants', 'calendar'])
        ->get();
}

// å…±æœ‰è§£é™¤
public function unshare(int $shareId)
{
    $share = CalendarEventShare::findOrFail($shareId);
    
    AuditLog::create([
        'action' => 'event_unshared',
        'user_id' => auth()->id(),
        'event_id' => $share->event_id,
        'calendar_id' => $share->calendar_id,
    ]);
    
    $share->delete();
}
```

### 3.3 ç¹°ã‚Šè¿”ã—äºˆå®šã®å‹•çš„å±•é–‹

#### å®Ÿè£…

```php
public function getExpandedEvents(string $start, string $end, ?int $memberId = null)
{
    $events = Event::with(['creator', 'participants', 'recurrence'])
        ->where('is_exception', false)
        ->get();
    
    $expanded = [];
    
    foreach ($events as $event) {
        if ($event->recurrence) {
            // è¡¨ç¤ºç¯„å›²ã®ã¿å±•é–‹
            $expanded = array_merge(
                $expanded,
                $this->expandRecurrence($event, $start, $end)
            );
        } else {
            if ($event->start_date <= $end && $event->end_date >= $start) {
                $expanded[] = $this->formatExpandedEvent($event, $event->event_id);
            }
        }
    }
    
    return $expanded;
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- DBã«1ä»¶ã®ã¿ä¿å­˜ï¼ˆè‚¥å¤§åŒ–é˜²æ­¢ï¼‰
- ä»»æ„æœŸé–“ã‚’è¡¨ç¤ºå¯èƒ½
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š

### 3.4 åŒæ™‚ç·¨é›†ç«¶åˆå‡¦ç†

#### ãƒ•ãƒ­ãƒ¼

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼A: äºˆå®šã‚’é–‹ã (version=1)
ãƒ¦ãƒ¼ã‚¶ãƒ¼B: äºˆå®šã‚’é–‹ã (version=1)
  â†“
ãƒ¦ãƒ¼ã‚¶ãƒ¼A: ä¿å­˜ â†’ æˆåŠŸ (version=2)
  â†“
ãƒ¦ãƒ¼ã‚¶ãƒ¼B: ä¿å­˜ â†’ ç«¶åˆæ¤œå‡ºï¼
  â†“
ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º:
  1. å†èª­ã¿è¾¼ã¿ï¼ˆå¤‰æ›´ç ´æ£„ï¼‰
  2. å¼·åˆ¶ä¿å­˜ï¼ˆä¸Šæ›¸ãï¼‰
```

#### å®Ÿè£…

```php
public function update(Request $request, Event $event)
{
    if ($event->version !== $request->input('version')) {
        return response()->json([
            'conflict' => true,
            'current_data' => $event->fresh()->load(['creator', 'participants']),
            'your_changes' => $request->validated(),
        ], 409);
    }
    
    $event->update([
        ...$request->validated(),
        'version' => $event->version + 1,
    ]);
    
    return response()->json(['success' => true]);
}

// å¼·åˆ¶ä¿å­˜
public function forceUpdate(Request $request, Event $event)
{
    $event->update([
        ...$request->validated(),
        'version' => $event->version + 1,
    ]);
    
    // ç›£æŸ»ãƒ­ã‚°ã«è¨˜éŒ²
    AuditLog::create([
        'action' => 'force_update',
        'user_id' => auth()->id(),
        'event_id' => $event->event_id,
        'details' => json_encode(['reason' => 'ç«¶åˆã‚’ç„¡è¦–ã—ã¦å¼·åˆ¶ä¿å­˜']),
    ]);
    
    return response()->json(['success' => true]);
}
```

### 3.5 ç›£æŸ»ãƒ­ã‚°

#### è¨˜éŒ²å¯¾è±¡ï¼ˆæœ€å°é™ï¼‰

- âœ… ä»–éƒ¨ç½²ã¸ã®äºˆå®šå…±æœ‰
- âœ… å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ‰¿èª/å´ä¸‹
- âœ… å¼·åˆ¶ä¿å­˜ï¼ˆç«¶åˆæ™‚ï¼‰
- âŒ é€šå¸¸ã®ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤ï¼ˆè¨˜éŒ²ã—ãªã„ï¼‰

#### ä¿æŒæœŸé–“

- 3ãƒ¶æœˆï¼ˆæ³•çš„è¦ä»¶ã«å¿œã˜ã¦èª¿æ•´å¯èƒ½ï¼‰
- è‡ªå‹•å‰Šé™¤ãƒãƒƒãƒå‡¦ç†

---

**ç¶šãã¯ãƒ‘ãƒ¼ãƒˆ2ã§ä½œæˆã—ã¾ã™**

## 4. æ¨©é™ç®¡ç†

### 4.1 æ¨©é™ãƒãƒˆãƒªã‚¯ã‚¹

#### ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼äºˆå®šï¼‰ã®æ¨©é™

| æ“ä½œ | ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼ | éƒ¨ç½²ç®¡ç†è€… | å…¨ç¤¾ç®¡ç†è€… |
|------|------------|-----------|-----------|
| å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–²è¦§ | âœ… | âœ… | âœ… |
| å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä½œæˆ | âŒ | âŒ | âœ… |
| å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç·¨é›† | âŒ | âŒ | âœ… |
| å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å‰Šé™¤ | âŒ | âŒ | âœ… |
| è‡ªéƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–²è¦§ | âœ… | âœ… | âœ… |
| è‡ªéƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä½œæˆ | âœ… | âœ… | âœ… |
| è‡ªéƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç·¨é›† | âœ…â€»1 | âœ…â€»2 | âŒâ€»3 |
| è‡ªéƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å‰Šé™¤ | âœ…â€»1 | âœ…â€»2 | âŒâ€»3 |
| ä»–éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–²è¦§ | âœ…â€»4 | âœ…â€»4 | âœ… |
| ä»–éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç·¨é›† | âœ…â€»5 | âŒ | âŒâ€»3 |

**æ³¨é‡ˆ:**
- â€»1: è‡ªåˆ†ãŒä½œæˆã—ãŸäºˆå®šã€ã¾ãŸã¯å‚åŠ è€…ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹äºˆå®šã®ã¿
- â€»2: è‡ªéƒ¨ç½²ã®å…¨ã¦ã®äºˆå®š
- â€»3: å…¨ç¤¾ç®¡ç†è€…ã¯éƒ¨ç½²ã®è‡ªå¾‹æ€§ã‚’å°Šé‡ã—ã€éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯ç·¨é›†ä¸å¯
- â€»4: å…¬é–‹ç¯„å›²ã«å¿œã˜ã¦é–²è¦§å¯èƒ½
- â€»5: å‚åŠ è€…ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿

#### å…±æœ‰ãƒ¡ãƒ¢ã®æ¨©é™

| æ“ä½œ | ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼ | éƒ¨ç½²ç®¡ç†è€… | å…¨ç¤¾ç®¡ç†è€… |
|------|------------|-----------|-----------|
| å…¨ç¤¾å…¬é–‹ãƒ¡ãƒ¢é–²è¦§ | âœ… | âœ… | âœ… |
| å…¨ç¤¾å…¬é–‹ãƒ¡ãƒ¢ç·¨é›† | âœ…â€»1 | âœ…â€»1 | âœ… |
| éƒ¨ç½²é™å®šãƒ¡ãƒ¢é–²è¦§ | âœ…â€»2 | âœ…â€»2 | âœ… |
| éƒ¨ç½²é™å®šãƒ¡ãƒ¢ç·¨é›† | âœ…â€»1 | âœ…â€»3 | âŒ |

**æ³¨é‡ˆ:**
- â€»1: è‡ªåˆ†ãŒä½œæˆã—ãŸãƒ¡ãƒ¢ã€ã¾ãŸã¯å‚åŠ è€…ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ¢ã®ã¿
- â€»2: åŒã˜éƒ¨ç½²ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿
- â€»3: è‡ªéƒ¨ç½²ã®å…¨ã¦ã®ãƒ¡ãƒ¢

#### ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®æ¨©é™

| æ“ä½œ | ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼ | éƒ¨ç½²ç®¡ç†è€… | å…¨ç¤¾ç®¡ç†è€… |
|------|------------|-----------|-----------|
| ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé–²è¦§ | âœ…â€»1 | âœ…â€»2 | âœ… |
| ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç·¨é›† | âœ…â€»3 | âœ…â€»2 | âœ… |
| å›ç­”é–²è¦§ | âœ…â€»3 | âœ…â€»2 | âœ… |

**æ³¨é‡ˆ:**
- â€»1: å›ç­”å¯¾è±¡è€…ã¨ã—ã¦æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®ã¿
- â€»2: è‡ªéƒ¨ç½²ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå…¨ã¦
- â€»3: è‡ªåˆ†ãŒä½œæˆã—ãŸã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®ã¿

### 4.2 æ¨©é™ãƒã‚§ãƒƒã‚¯å®Ÿè£…

```php
// app/Policies/EventPolicy.php
class EventPolicy
{
    public function update(User $user, Event $event): bool
    {
        $calendar = $event->calendar;
        
        // å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å ´åˆ
        if ($calendar->owner_type === 'company') {
            return $user->role_type === 'company_admin';
        }
        
        // éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å ´åˆ
        // 1. ä½œæˆè€…æœ¬äºº
        if ($event->created_by === $user->id) {
            return true;
        }
        
        // 2. å‚åŠ è€…ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹
        if ($event->participants->contains($user->id)) {
            return true;
        }
        
        // 3. éƒ¨ç½²ç®¡ç†è€…ï¼ˆåŒã˜éƒ¨ç½²ã®ã¿ï¼‰
        if ($user->role_type === 'department_admin' 
            && $event->owner_department_id === $user->department_id) {
            return true;
        }
        
        return false;
    }
    
    public function view(User $user, Event $event): bool
    {
        // 1. å…¨ç¤¾å…¬é–‹
        if ($event->visibility_type === 'public') {
            return true;
        }
        
        // 2. éƒ¨ç½²é™å®šï¼ˆåŒã˜éƒ¨ç½²ã®ã¿ï¼‰
        if ($event->visibility_type === 'department' 
            && $event->owner_department_id === $user->department_id) {
            return true;
        }
        
        // 3. ã‚«ã‚¹ã‚¿ãƒ ï¼ˆå‚åŠ è€…ã®ã¿ï¼‰
        if ($event->visibility_type === 'custom' 
            && $event->participants->contains($user->id)) {
            return true;
        }
        
        // 4. éå…¬é–‹ï¼ˆä½œæˆè€…ã®ã¿ï¼‰
        if ($event->visibility_type === 'private' 
            && $event->created_by === $user->id) {
            return true;
        }
        
        // 5. å…¨ç¤¾ç®¡ç†è€…ã¯å…¨ã¦é–²è¦§å¯èƒ½
        if ($user->role_type === 'company_admin') {
            return true;
        }
        
        return false;
    }
}
```

---

## 5. é‹ç”¨è©³ç´°

### 5.1 éƒ¨ç½²ç•°å‹•æ™‚ã®å‡¦ç†

#### åŸºæœ¬æ–¹é‡

```
éå»ã®äºˆå®š â†’ å…ƒã®éƒ¨ç½²ã«æ®‹ã™ + æ‰€æœ‰æ¨©ç§»è­²
ç¹°ã‚Šè¿”ã—äºˆå®š â†’ å…ƒã®éƒ¨ç½²ã«æ®‹ã™ï¼ˆéƒ¨ç½²ã®å®šä¾‹ä¼šè­°ã®ãŸã‚ï¼‰
å˜ç™ºäºˆå®šï¼ˆæœ¬äººã®ã¿ï¼‰ â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèª
å˜ç™ºäºˆå®šï¼ˆè¤‡æ•°äººï¼‰ â†’ æ–°éƒ¨ç½²ã«ç§»å‹•
```

#### å®Ÿè£…

```php
// app/Services/UserDepartmentTransferService.php
public function transferDepartment(User $user, int $newDepartmentId): array
{
    $oldDepartmentId = $user->department_id;
    $today = Carbon::today();
    
    DB::beginTransaction();
    
    try {
        // 1. éå»ã®äºˆå®š: å…ƒã®éƒ¨ç½²ã«æ®‹ã™ + æ‰€æœ‰æ¨©ç§»è­²
        $this->transferPastEvents($user, $oldDepartmentId, $today);
        
        // 2. ç¹°ã‚Šè¿”ã—äºˆå®š: å…ƒã®éƒ¨ç½²ã«æ®‹ã™
        $this->keepRecurringEvents($user, $oldDepartmentId);
        
        // 3. æœªæ¥ã®å˜ç™ºäºˆå®š: å‚åŠ è€…ã‚’ãƒã‚§ãƒƒã‚¯
        $soloEvents = $this->checkSoloEvents($user, $oldDepartmentId, $today);
        
        if ($soloEvents->isNotEmpty()) {
            DB::rollBack();
            return [
                'requires_confirmation' => true,
                'solo_events' => $soloEvents,
            ];
        }
        
        // 4. æœªæ¥ã®äºˆå®šï¼ˆå‚åŠ è€…ãŒè¤‡æ•°ï¼‰: æ–°ã—ã„éƒ¨ç½²ã«ç§»å‹•
        $this->transferFutureEvents($user, $oldDepartmentId, $newDepartmentId, $today);
        
        // 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éƒ¨ç½²ã‚’æ›´æ–°
        $user->update(['department_id' => $newDepartmentId]);
        
        DB::commit();
        return ['success' => true];
        
    } catch (\Exception $e) {
        DB::rollBack();
        throw $e;
    }
}

private function transferPastEvents(User $user, int $oldDepartmentId, Carbon $today): void
{
    $departmentAdmin = $this->getDepartmentAdmin($oldDepartmentId);
    
    Event::where('created_by', $user->id)
        ->where('owner_department_id', $oldDepartmentId)
        ->where('end_date', '<', $today)
        ->update(['created_by' => $departmentAdmin->id]);
}

private function keepRecurringEvents(User $user, int $oldDepartmentId): void
{
    $departmentAdmin = $this->getDepartmentAdmin($oldDepartmentId);
    
    Event::where('created_by', $user->id)
        ->where('owner_department_id', $oldDepartmentId)
        ->whereHas('recurrence')
        ->update(['created_by' => $departmentAdmin->id]);
}
```

### 5.2 é€€è·è€…ãƒ‡ãƒ¼ã‚¿å‡¦ç†

#### å‡¦ç†å†…å®¹

**ãƒˆãƒªã‚¬ãƒ¼**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç„¡åŠ¹åŒ–æ™‚ï¼ˆ`is_active = false`ã«å¤‰æ›´ï¼‰

**è‡ªå‹•å‡¦ç†**:
1. æœªæ¥ã®äºˆå®šã®æ‰€æœ‰æ¨© â†’ éƒ¨ç½²ç®¡ç†è€…ã«ç§»è­²
2. å…±æœ‰ãƒ¡ãƒ¢ â†’ éƒ¨ç½²ç®¡ç†è€…ã«ç§»è­²
3. ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ â†’ éƒ¨ç½²ç®¡ç†è€…ã«ç§»è­²
4. æœªæ¥ã®äºˆå®šã‹ã‚‰å‚åŠ è€…é™¤å¤– â†’ è‡ªå‹•å®Ÿè¡Œ

#### å®Ÿè£…

```php
// app/Services/UserDeactivationService.php
public function deactivateUser(User $user, string $reason): array
{
    $stats = [
        'transferred_events' => 0,
        'transferred_notes' => 0,
        'transferred_surveys' => 0,
        'removed_from_events' => 0,
    ];
    
    DB::transaction(function() use ($user, $reason, &$stats) {
        $today = Carbon::today();
        $departmentAdmin = $this->getDepartmentAdmin($user->department_id);
        
        // 1. æœªæ¥ã®äºˆå®šã®æ‰€æœ‰æ¨©ã‚’ç§»è­²
        $stats['transferred_events'] = Event::where('created_by', $user->id)
            ->where('start_date', '>=', $today)
            ->update(['created_by' => $departmentAdmin->id]);
        
        // 2. å…±æœ‰ãƒ¡ãƒ¢ã®æ‰€æœ‰æ¨©ã‚’ç§»è­²
        $stats['transferred_notes'] = SharedNote::where('author_id', $user->id)
            ->where('is_deleted', false)
            ->update(['author_id' => $departmentAdmin->id]);
        
        // 3. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®æ‰€æœ‰æ¨©ã‚’ç§»è­²
        $stats['transferred_surveys'] = Survey::where('created_by', $user->id)
            ->where('is_active', true)
            ->where('is_deleted', false)
            ->update(['created_by' => $departmentAdmin->id]);
        
        // 4. æœªæ¥ã®äºˆå®šã‹ã‚‰å‚åŠ è€…ã¨ã—ã¦é™¤å¤–
        $stats['removed_from_events'] = DB::table('event_participants')
            ->where('user_id', $user->id)
            ->whereIn('event_id', function($query) use ($today) {
                $query->select('event_id')
                      ->from('events')
                      ->where('start_date', '>=', $today);
            })
            ->delete();
        
        // 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç„¡åŠ¹åŒ–
        $user->update([
            'is_active' => false,
            'deactivated_at' => now(),
            'reason' => $reason,
        ]);
        
        // 6. ãƒ­ã‚°ã‚’è¨˜éŒ²
        AuditLog::create([
            'action' => 'user_deactivated',
            'user_id' => $user->id,
            'details' => json_encode(['reason' => $reason, 'stats' => $stats]),
        ]);
    });
    
    return $stats;
}
```

### 5.3 éƒ¨ç½²çµ±å»ƒåˆ

#### å‡¦ç†å†…å®¹

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ çµ±åˆå…ˆã«ç§»å‹•
äºˆå®šãƒ»ãƒ¡ãƒ¢ãƒ»ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ â†’ çµ±åˆå…ˆã«ç§»å‹•
ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ â†’ çµ±åˆå…ˆã«çµ±åˆ
çµ±åˆå…ƒã®éƒ¨ç½² â†’ ç„¡åŠ¹åŒ–ï¼ˆå±¥æ­´ä¿æŒï¼‰
```

#### å®Ÿè£…

```php
// app/Services/DepartmentMergeService.php
public function mergeDepartments(
    array $sourceDepartmentIds, 
    int $targetDepartmentId,
    string $reason = ''
): array
{
    $stats = [
        'moved_users' => 0,
        'moved_events' => 0,
        'moved_notes' => 0,
        'moved_surveys' => 0,
    ];
    
    DB::transaction(function() use ($sourceDepartmentIds, $targetDepartmentId, $reason, &$stats) {
        
        // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç§»å‹•
        $stats['moved_users'] = User::whereIn('department_id', $sourceDepartmentIds)
            ->update(['department_id' => $targetDepartmentId]);
        
        // 2. äºˆå®šã‚’ç§»å‹•
        $targetCalendar = $this->getTargetCalendar($targetDepartmentId);
        $stats['moved_events'] = Event::whereIn('owner_department_id', $sourceDepartmentIds)
            ->update([
                'owner_department_id' => $targetDepartmentId,
                'calendar_id' => $targetCalendar->calendar_id,
            ]);
        
        // 3. å…±æœ‰ãƒ¡ãƒ¢ã‚’ç§»å‹•
        $stats['moved_notes'] = SharedNote::whereIn('owner_department_id', $sourceDepartmentIds)
            ->update(['owner_department_id' => $targetDepartmentId]);
        
        // 4. ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’ç§»å‹•
        $stats['moved_surveys'] = Survey::whereIn('owner_department_id', $sourceDepartmentIds)
            ->update(['owner_department_id' => $targetDepartmentId]);
        
        // 5. çµ±åˆå…ƒã®éƒ¨ç½²ã‚’ç„¡åŠ¹åŒ–
        foreach ($sourceDepartmentIds as $sourceId) {
            $sourceDept = Department::find($sourceId);
            $sourceDept->update(['is_active' => false]);
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å‰Šé™¤
            Calendar::where('owner_type', 'department')
                ->where('owner_id', $sourceId)
                ->delete();
            
            // ãƒ­ã‚°ã‚’è¨˜éŒ²
            AuditLog::create([
                'action' => 'department_merged',
                'user_id' => auth()->id(),
                'details' => json_encode([
                    'source_department_id' => $sourceId,
                    'target_department_id' => $targetDepartmentId,
                    'reason' => $reason,
                    'stats' => $stats,
                ]),
            ]);
        }
    });
    
    return $stats;
}
```

### 5.4 éƒ¨ç½²ç®¡ç†è€…é‹ç”¨

#### é‹ç”¨æ–¹é‡

```
ã€éƒ¨ç½²ç®¡ç†è€…ã®å¿…é ˆè¨­å®šãƒ«ãƒ¼ãƒ«ã€‘

1. éƒ¨ç½²ä½œæˆæ™‚
   - éƒ¨ç½²ä½œæˆã¨åŒæ™‚ã«ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ
   - ç®¡ç†è€…ãŒè¨­å®šã•ã‚Œã‚‹ã¾ã§éƒ¨ç½²ã¯æœ‰åŠ¹åŒ–ã•ã‚Œãªã„

2. ç®¡ç†è€…é€€è·æ™‚
   ã‚¹ãƒ†ãƒƒãƒ—1: æ¬¡æœŸç®¡ç†è€…ã‚’é¸å®š
   ã‚¹ãƒ†ãƒƒãƒ—2: æ¬¡æœŸç®¡ç†è€…ã‚’ã€Œéƒ¨ç½²ç®¡ç†è€…ã€ã«æ˜‡æ ¼
   ã‚¹ãƒ†ãƒƒãƒ—3: é€€è·äºˆå®šè€…ã‚’ã€Œä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼ã€ã«é™æ ¼
   ã‚¹ãƒ†ãƒƒãƒ—4: é€€è·æ—¥ã«é€€è·äºˆå®šè€…ã‚’ç„¡åŠ¹åŒ–

3. ç®¡ç†è€…ä¸åœ¨ã®æ¤œçŸ¥
   - æ¯æœˆ1æ—¥ã«è‡ªå‹•ãƒã‚§ãƒƒã‚¯
   - ç®¡ç†è€…ä¸åœ¨ã®éƒ¨ç½²ãŒã‚ã‚Œã°å…¨ç¤¾ç®¡ç†è€…ã«é€šçŸ¥
```

#### å®Ÿè£…

```php
// éƒ¨ç½²ä½œæˆæ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
public function store(Request $request)
{
    $validated = $request->validate([
        'name' => 'required|unique:departments',
        'admin_user_id' => 'required|exists:users,id',
    ]);
    
    DB::transaction(function() use ($validated) {
        $department = Department::create(['name' => $validated['name']]);
        
        User::find($validated['admin_user_id'])->update([
            'department_id' => $department->id,
            'role_type' => 'department_admin',
        ]);
    });
}

// ç®¡ç†è€…ä¸åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆæœˆæ¬¡ãƒãƒƒãƒï¼‰
public function checkMissingAdmins()
{
    $departmentsWithoutAdmin = Department::where('is_active', true)
        ->whereDoesntHave('users', function($q) {
            $q->where('role_type', 'department_admin')
              ->where('is_active', true);
        })
        ->get();
    
    if ($departmentsWithoutAdmin->isNotEmpty()) {
        Notification::send(
            User::where('role_type', 'company_admin')->get(),
            new MissingDepartmentAdmins($departmentsWithoutAdmin)
        );
    }
}
```

---

## 6. UI/UXè¨­è¨ˆ

### 6.1 å…±æœ‰äºˆå®šç®¡ç†UI

```vue
<template>
  <Card>
    <CardHeader>
      <CardTitle class="flex items-center justify-between">
        <span>å…±æœ‰å…ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</span>
        <Button size="sm" @click="showShareDialog = true">
          <Plus class="h-4 w-4 mr-2" />
          å…±æœ‰å…ˆã‚’è¿½åŠ 
        </Button>
      </CardTitle>
    </CardHeader>
    <CardContent>
      <div class="space-y-2">
        <!-- å…ƒã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
        <div class="flex items-center gap-2 p-2 bg-blue-50 rounded">
          <Calendar class="h-4 w-4 text-blue-600" />
          <div class="flex-1">
            <div class="font-medium">{{ event.calendar.name }}</div>
            <div class="text-xs text-gray-500">å…ƒã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
          </div>
          <Badge>ç·¨é›†å¯èƒ½</Badge>
        </div>
        
        <!-- å…±æœ‰å…ˆ -->
        <div v-for="share in event.shares" :key="share.id"
             class="flex items-center gap-2 p-2 border rounded">
          <Share2 class="h-4 w-4 text-gray-400" />
          <div class="flex-1">
            <div class="font-medium">{{ share.calendar.name }}</div>
            <div class="text-xs text-gray-500">
              {{ share.shared_by.name }}ãŒ{{ formatDate(share.shared_at) }}ã«å…±æœ‰
            </div>
          </div>
          <Badge variant="outline">é–²è¦§ã®ã¿</Badge>
          <Button variant="ghost" size="sm" @click="unshare(share.id)">
            <X class="h-4 w-4" />
          </Button>
        </div>
      </div>
    </CardContent>
  </Card>
</template>
```

### 6.2 ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¸æŠUI

```vue
<template>
  <form @submit.prevent="handleSubmit">
    <div class="space-y-2">
      <Label>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é¸æŠ</Label>
      <RadioGroup v-model="form.calendar_id">
        <!-- è‡ªåˆ†ã®éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ -->
        <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
          <RadioGroupItem :value="userDepartmentCalendar.calendar_id" id="dept-calendar" />
          <Label for="dept-calendar" class="flex-1 cursor-pointer">
            <div class="flex items-center gap-2">
              <Building class="h-4 w-4 text-blue-600" />
              <span class="font-medium">{{ userDepartmentCalendar.calendar_name }}</span>
            </div>
            <div class="text-sm text-gray-500 mt-1">
              é€šå¸¸ã®æ¥­å‹™äºˆå®šã€ä¼šè­°ãªã©ã¯ã“ã¡ã‚‰
            </div>
          </Label>
        </div>
        
        <!-- å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
        <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50">
          <RadioGroupItem :value="companyCalendar.calendar_id" id="company-calendar" />
          <Label for="company-calendar" class="flex-1 cursor-pointer">
            <div class="flex items-center gap-2">
              <Globe class="h-4 w-4 text-green-600" />
              <span class="font-medium">{{ companyCalendar.calendar_name }}</span>
            </div>
            <div class="text-sm text-gray-500 mt-1">
              å…¨ä½“é€£çµ¡ã€ä¼šç¤¾è¡Œäº‹ã€ä¼‘æ—¥ã®ã¿
            </div>
          </Label>
        </div>
      </RadioGroup>
      
      <!-- å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¸æŠæ™‚ã®æ³¨æ„ -->
      <Alert v-if="form.calendar_id === companyCalendar.calendar_id" variant="warning">
        <AlertCircle class="h-4 w-4" />
        <AlertTitle>å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ã¤ã„ã¦</AlertTitle>
        <AlertDescription>
          å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯å…¨å“¡ãŒé–²è¦§ã—ã¾ã™ã€‚å…¨ä½“é€£çµ¡ã‚„ä¼šç¤¾è¡Œäº‹ã®ã¿ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
        </AlertDescription>
      </Alert>
    </div>
  </form>
</template>
```

### 6.3 ç«¶åˆè§£æ±ºUI

```vue
<template>
  <Dialog v-model:open="showConflictDialog">
    <DialogContent class="max-w-3xl">
      <DialogHeader>
        <DialogTitle class="flex items-center gap-2 text-orange-600">
          <AlertTriangle class="h-5 w-5" />
          ç·¨é›†ã®ç«¶åˆãŒç™ºç”Ÿã—ã¾ã—ãŸ
        </DialogTitle>
        <DialogDescription>
          ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã“ã®äºˆå®šã‚’ç·¨é›†ã—ã¦ã„ã¾ã™
        </DialogDescription>
      </DialogHeader>
      
      <div class="space-y-4">
        <Alert variant="warning">
          <AlertCircle class="h-4 w-4" />
          <AlertDescription>
            {{ conflictData.updatedBy }}ã•ã‚“ãŒ {{ formatTime(conflictData.updatedAt) }} ã«ç·¨é›†ã—ã¾ã—ãŸ
          </AlertDescription>
        </Alert>
        
        <!-- å·®åˆ†è¡¨ç¤º -->
        <div class="grid grid-cols-2 gap-4">
          <div class="space-y-2">
            <h4 class="font-medium text-sm">ç¾åœ¨ã®å†…å®¹ï¼ˆä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç·¨é›†ï¼‰</h4>
            <div class="p-3 border rounded bg-red-50">
              <div class="text-sm">
                <div><strong>ã‚¿ã‚¤ãƒˆãƒ«:</strong> {{ conflictData.current.title }}</div>
                <div><strong>æ—¥æ™‚:</strong> {{ conflictData.current.date_range }}</div>
                <div><strong>å ´æ‰€:</strong> {{ conflictData.current.location }}</div>
              </div>
            </div>
          </div>
          
          <div class="space-y-2">
            <h4 class="font-medium text-sm">ã‚ãªãŸã®å¤‰æ›´</h4>
            <div class="p-3 border rounded bg-blue-50">
              <div class="text-sm">
                <div><strong>ã‚¿ã‚¤ãƒˆãƒ«:</strong> {{ conflictData.yours.title }}</div>
                <div><strong>æ—¥æ™‚:</strong> {{ conflictData.yours.date_range }}</div>
                <div><strong>å ´æ‰€:</strong> {{ conflictData.yours.location }}</div>
              </div>
            </div>
          </div>
        </div>
        
        <RadioGroup v-model="conflictResolution">
          <div class="space-y-2">
            <div class="flex items-start space-x-3 p-3 border rounded-lg hover:bg-gray-50">
              <RadioGroupItem value="reload" id="reload" />
              <Label for="reload" class="flex-1 cursor-pointer">
                <div class="font-medium">å¤‰æ›´ã‚’ç ´æ£„ã—ã¦å†èª­ã¿è¾¼ã¿</div>
                <div class="text-sm text-gray-500">
                  ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç·¨é›†å†…å®¹ã‚’æ¡ç”¨ã—ã¾ã™ï¼ˆã‚ãªãŸã®å¤‰æ›´ã¯å¤±ã‚ã‚Œã¾ã™ï¼‰
                </div>
              </Label>
            </div>
            
            <div class="flex items-start space-x-3 p-3 border rounded-lg hover:bg-gray-50">
              <RadioGroupItem value="force" id="force" />
              <Label for="force" class="flex-1 cursor-pointer">
                <div class="font-medium text-orange-600">è‡ªåˆ†ã®å¤‰æ›´ã§ä¸Šæ›¸ã</div>
                <div class="text-sm text-gray-500">
                  ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç·¨é›†ã‚’ç„¡è¦–ã—ã¦ã€ã‚ãªãŸã®å¤‰æ›´ã‚’ä¿å­˜ã—ã¾ã™
                </div>
              </Label>
            </div>
          </div>
        </RadioGroup>
      </div>
      
      <DialogFooter>
        <Button variant="outline" @click="showConflictDialog = false">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </Button>
        <Button @click="handleConflictResolution">
          {{ conflictResolution === 'reload' ? 'å†èª­ã¿è¾¼ã¿' : 'ä¸Šæ›¸ãä¿å­˜' }}
        </Button>
      </DialogFooter>
    </DialogContent>
  </Dialog>
</template>
```

---

**ç¶šãã¯ãƒ‘ãƒ¼ãƒˆ3ã§ä½œæˆã—ã¾ã™**

## 7. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 7.1 N+1å•é¡Œã®é˜²æ­¢

#### å•é¡Œã®ä¾‹

```php
// æ‚ªã„ä¾‹: N+1å•é¡ŒãŒç™ºç”Ÿ
$events = Event::where('visibility_type', 'public')->get();

foreach ($events as $event) {
    echo $event->creator->name;  // Nå›ã®ã‚¯ã‚¨ãƒª
    echo $event->participants->count();  // Nå›ã®ã‚¯ã‚¨ãƒª
    echo $event->calendar->calendar_name;  // Nå›ã®ã‚¯ã‚¨ãƒª
}
// åˆè¨ˆ: 1 + N + N + N = 3N + 1 å›ã®ã‚¯ã‚¨ãƒª
// 100ä»¶ã®ã‚¤ãƒ™ãƒ³ãƒˆãªã‚‰301å›ã®ã‚¯ã‚¨ãƒªï¼
```

#### è§£æ±ºç­–: Eager Loading

```php
// è‰¯ã„ä¾‹: Eager Loadingã§æœ€é©åŒ–
$events = Event::with(['creator', 'participants', 'calendar'])
    ->where('visibility_type', 'public')
    ->get();

foreach ($events as $event) {
    echo $event->creator->name;  // ã‚¯ã‚¨ãƒªãªã—ï¼ˆæ—¢ã«ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ï¼‰
    echo $event->participants->count();  // ã‚¯ã‚¨ãƒªãªã—
    echo $event->calendar->calendar_name;  // ã‚¯ã‚¨ãƒªãªã—
}
// åˆè¨ˆ: 4å›ã®ã‚¯ã‚¨ãƒªã®ã¿ï¼ˆEvent + creator + participants + calendarï¼‰
// 100ä»¶ã®ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚‚4å›ã®ã‚¯ã‚¨ãƒªï¼
```

**åŠ¹æœ**: 301å› â†’ 4å›ï¼ˆç´„75å€é«˜é€ŸåŒ–ï¼‰

### 7.2 ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

```php
// app/Services/CacheService.php
class CacheService
{
    /**
     * éƒ¨ç½²ã®å…¬é–‹äºˆå®šã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ10åˆ†é–“ï¼‰
     */
    public function getDepartmentPublicEvents(int $departmentId, string $start, string $end)
    {
        $cacheKey = "dept_{$departmentId}_public_events_{$start}_{$end}";
        
        return Cache::remember($cacheKey, now()->addMinutes(10), function() use ($departmentId, $start, $end) {
            return Event::with(['creator', 'participants'])
                ->where(function($q) use ($departmentId) {
                    $q->where('visibility_type', 'public')
                      ->orWhere(function($subQ) use ($departmentId) {
                          $subQ->where('visibility_type', 'department')
                               ->where('owner_department_id', $departmentId);
                      });
                })
                ->whereBetween('start_date', [$start, $end])
                ->get();
        });
    }
    
    /**
     * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
     */
    public function clearDepartmentCache(int $departmentId)
    {
        Cache::tags(["department_{$departmentId}"])->flush();
    }
}

// ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆãƒ»æ›´æ–°æ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
public function store(StoreEventRequest $request)
{
    $event = $this->eventService->createEvent($request->validated());
    
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
    app(CacheService::class)->clearDepartmentCache($event->owner_department_id);
    
    return redirect()->back();
}
```

### 7.3 ã‚¯ã‚¨ãƒªæœ€é©åŒ–

```php
// è¤‡é›‘ãªã‚¯ã‚¨ãƒªã‚’æœ€é©åŒ–
public function getEventsApi(Request $request)
{
    $user = auth()->user();
    
    // å¿…è¦ãªã‚«ãƒ©ãƒ ã®ã¿å–å¾—ã—ã¦ãƒ¡ãƒ¢ãƒªç¯€ç´„
    $events = Event::with([
            'creator:id,name',
            'participants:id,name',
            'calendar:calendar_id,calendar_name'
        ])
        ->where(function($query) use ($user) {
            $query
                ->where('visibility_type', 'public')
                ->orWhere(function($q) use ($user) {
                    $q->where('visibility_type', 'department')
                      ->where('owner_department_id', $user->department_id);
                })
                ->orWhere('created_by', $user->id)
                ->orWhereHas('participants', function($q) use ($user) {
                    $q->where('user_id', $user->id);
                });
        })
        ->whereBetween('start_date', [$request->start, $request->end])
        ->get();
    
    return response()->json($events);
}
```

---

## 8. ãƒªã‚¹ã‚¯ç®¡ç†

### 8.1 æŠ€è¡“çš„ãƒªã‚¹ã‚¯

#### ğŸ”´ é«˜ãƒªã‚¹ã‚¯

##### 1. ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå¤±æ•—

**ãƒªã‚¹ã‚¯**: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ï¼ˆæ•°ç™¾ä»¶ï¼‰ã®ç§»è¡Œæ™‚ã«ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ

**å½±éŸ¿**: ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ å»¶é•·ï¼ˆäºˆå®š1-2åˆ† â†’ æœ€æ‚ª30åˆ†ä»¥ä¸Šï¼‰ã€ãƒ‡ãƒ¼ã‚¿æå¤±

**å¯¾ç­–**:
- å®Œå…¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå¿…é ˆï¼‰
- ãƒ†ã‚¹ãƒˆç’°å¢ƒã§3å›ä»¥ä¸Šæ¤œè¨¼
- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †æº–å‚™
- æ®µéšçš„ç§»è¡Œï¼ˆéƒ¨ç½²ã”ã¨ï¼‰

**ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**:
- [ ] æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å–å¾—
- [ ] ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã®ç§»è¡ŒæˆåŠŸï¼ˆ3å›ï¼‰
- [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ã®ç¢ºèª
- [ ] ç§»è¡Œæ™‚é–“ã®è¨ˆæ¸¬
- [ ] ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹é€šçŸ¥ã®é€ä¿¡

##### 2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ–

**ãƒªã‚¹ã‚¯**: è¤‡é›‘ãªã‚¯ã‚¨ãƒªã§è¡¨ç¤ºé…å»¶

**å½±éŸ¿**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ä½ä¸‹

**å¯¾ç­–**:
- 15å€‹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
- Eager Loadingå¾¹åº•
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ï¼ˆ10åˆ†é–“ï¼‰
- ã‚¯ã‚¨ãƒªå®Ÿè¡Œè¨ˆç”»ã®ç¢ºèª

##### 3. å…±æœ‰æ©Ÿèƒ½ã®è¤‡é›‘æ€§

**ãƒªã‚¹ã‚¯**: å…±æœ‰å…ˆã§ã®ç·¨é›†æ¨©é™ãŒä¸æ˜ç¢º

**å½±éŸ¿**: æ··ä¹±ã€èª¤æ“ä½œ

**å¯¾ç­–**:
- æ˜ç¢ºãªUIè¡¨ç¤ºï¼ˆãƒãƒƒã‚¸ãƒ»ä¸€è¦§ï¼‰
- ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆå……å®Ÿ
- ç·¨é›†æ¨©é™ã®æ˜ç¤º

#### ğŸŸ¡ ä¸­ãƒªã‚¹ã‚¯

##### 4. æ‰¿èªãƒ•ãƒ­ãƒ¼ã®é…å»¶

**ãƒªã‚¹ã‚¯**: å…¨ç¤¾ç®¡ç†è€…ãŒæ‰¿èªã‚’å¿˜ã‚Œã‚‹

**å½±éŸ¿**: å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¸ã®æŠ•ç¨¿é…å»¶

**å¯¾ç­–**:
- ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€šçŸ¥ï¼ˆ24æ™‚é–“å¾Œï¼‰
- æ‰¿èªå¾…ã¡ä¸€è¦§ç”»é¢
- æœŸé™è¨­å®šï¼ˆ3æ—¥ä»¥å†…ï¼‰

##### 5. å‹•çš„å±•é–‹ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

**ãƒªã‚¹ã‚¯**: ç¹°ã‚Šè¿”ã—äºˆå®šãŒå¤šã„ã¨å±•é–‹ã«æ™‚é–“ãŒã‹ã‹ã‚‹

**å½±éŸ¿**: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºé…å»¶

**å¯¾ç­–**:
- è¡¨ç¤ºç¯„å›²ã‚’1ãƒ¶æœˆã«åˆ¶é™
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨

##### 6. åŒæ™‚ç·¨é›†ç«¶åˆã®é »åº¦

**ãƒªã‚¹ã‚¯**: ç«¶åˆãŒé »ç™ºã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¸æº€

**å½±éŸ¿**: ä¿å­˜å¤±æ•—ã®å¢—åŠ 

**å¯¾ç­–**:
- ç·¨é›†ä¸­è¡¨ç¤ºæ©Ÿèƒ½ï¼ˆWebSocketï¼‰
- è‡ªå‹•ä¿å­˜ï¼ˆä¸‹æ›¸ãï¼‰
- å·®åˆ†ãƒãƒ¼ã‚¸UI

### 8.2 é‹ç”¨çš„ãƒªã‚¹ã‚¯

#### ğŸ”´ é«˜ãƒªã‚¹ã‚¯

##### 1. éƒ¨ç½²ç®¡ç†è€…ä¸åœ¨

**ãƒªã‚¹ã‚¯**: éƒ¨ç½²ã«ç®¡ç†è€…ãŒè¨­å®šã•ã‚Œãªã„

**å½±éŸ¿**: éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒç®¡ç†ä¸èƒ½

**å¯¾ç­–**:
- éƒ¨ç½²ä½œæˆæ™‚ã«ç®¡ç†è€…å¿…é ˆåŒ–
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§å¼·åˆ¶
- æœˆæ¬¡è‡ªå‹•ãƒã‚§ãƒƒã‚¯
- å…¨ç¤¾ç®¡ç†è€…ã«é€šçŸ¥

##### 2. å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä¹±ç”¨

**ãƒªã‚¹ã‚¯**: ä¸é©åˆ‡ãªå†…å®¹ãŒç”³è«‹ã•ã‚Œã‚‹

**å½±éŸ¿**: æ‰¿èªä½œæ¥­ã®å¢—åŠ 

**å¯¾ç­–**:
- ç”³è«‹æ™‚ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³è¡¨ç¤º
- å´ä¸‹ç†ç”±ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
- ç”³è«‹å±¥æ­´ã®ç¢ºèª

##### 3. å…±æœ‰äºˆå®šã®ç®¡ç†ä¸å…¨

**ãƒªã‚¹ã‚¯**: ã©ã“ã«å…±æœ‰ã—ãŸã‹åˆ†ã‹ã‚‰ãªããªã‚‹

**å½±éŸ¿**: ãƒ‡ãƒ¼ã‚¿ã®ä¸æ•´åˆ

**å¯¾ç­–**:
- å…±æœ‰å…ˆä¸€è¦§ã®è¡¨ç¤º
- å…±æœ‰è§£é™¤æ©Ÿèƒ½
- ç›£æŸ»ãƒ­ã‚°ã§è¿½è·¡

#### ğŸŸ¡ ä¸­ãƒªã‚¹ã‚¯

##### 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ··ä¹±

**ãƒªã‚¹ã‚¯**: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¸æŠã€å…¬é–‹ç¯„å›²ã§æ··ä¹±

**å½±éŸ¿**: èª¤è¨­å®šã€å•ã„åˆã‚ã›å¢—åŠ 

**å¯¾ç­–**:
- ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
- ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆ
- æ®µéšçš„ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ

##### 5. ç›£æŸ»ãƒ­ã‚°ã®è‚¥å¤§åŒ–

**ãƒªã‚¹ã‚¯**: ãƒ­ã‚°ãŒå¢—ãˆã™ãã‚‹

**å½±éŸ¿**: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åœ§è¿«

**å¯¾ç­–**:
- æœ€å°é™ã®è¨˜éŒ²ï¼ˆå…±æœ‰ã®ã¿ï¼‰
- 3ãƒ¶æœˆã§è‡ªå‹•å‰Šé™¤
- å®šæœŸçš„ãªã‚¢ãƒ¼ã‚«ã‚¤ãƒ–

---

## 9. å…ˆæ–¹ç¢ºèªäº‹é …

### 9.1 é‹ç”¨é¢ã®ç¢ºèª

| # | é …ç›® | ç¢ºèªå†…å®¹ | å½±éŸ¿ç¯„å›² |
|---|------|---------|---------|
| 1 | éƒ¨ç½²çµ±å»ƒåˆã®é »åº¦ | å¹´ã«ä½•å›ç¨‹åº¦ç™ºç”Ÿã™ã‚‹ã‹ï¼Ÿ | è‡ªå‹•ç§»è¡Œæ©Ÿèƒ½ã®å„ªå…ˆåº¦ |
| 2 | é€€è·è€…å‡¦ç†ã‚¿ã‚¤ãƒŸãƒ³ã‚° | é€€è·æ—¥å½“æ—¥ï¼Ÿäº‹å‰å‡¦ç†ï¼Ÿ | äºˆå®šã®æ‰€æœ‰æ¨©ç§»è­²ã‚¿ã‚¤ãƒŸãƒ³ã‚° |
| 3 | å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ‰¿èªæœŸé™ | ä½•æ—¥ä»¥å†…ã«æ‰¿èªãŒå¿…è¦ï¼Ÿ | ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼è¨­å®š |
| 4 | å…±æœ‰äºˆå®šã®ç·¨é›†æ¨©é™ | å…±æœ‰å…ˆã§ã‚‚ç·¨é›†å¯èƒ½ï¼Ÿé–²è¦§ã®ã¿ï¼Ÿ | æ¨©é™è¨­è¨ˆ |
| 5 | å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ | ã©ã®ã‚ˆã†ãªå†…å®¹ã‚’æŠ•ç¨¿å¯èƒ½ã¨ã™ã‚‹ã‹ï¼Ÿ | UIè¡¨ç¤ºå†…å®¹ |
| 6 | éƒ¨ç½²ç®¡ç†è€…ã®é¸å®šåŸºæº– | ã©ã®ã‚ˆã†ãªåŸºæº–ã§é¸å®šã™ã‚‹ã‹ï¼Ÿ | é‹ç”¨ãƒ«ãƒ¼ãƒ« |
| 7 | éƒ¨ç½²ç•°å‹•ã®é »åº¦ | å¹´ã«ä½•å›ç¨‹åº¦ç™ºç”Ÿã™ã‚‹ã‹ï¼Ÿ | ç•°å‹•å‡¦ç†ã®å„ªå…ˆåº¦ |
| 8 | å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®é‹ç”¨è²¬ä»»è€… | èª°ãŒæ‰¿èªã‚’è¡Œã†ã‹ï¼Ÿ | é€šçŸ¥å…ˆã®è¨­å®š |

### 9.2 æŠ€è¡“é¢ã®ç¢ºèª

| # | é …ç›® | ç¢ºèªå†…å®¹ | å½±éŸ¿ç¯„å›² |
|---|------|---------|---------|
| 1 | ç›£æŸ»ãƒ­ã‚°ä¿æŒæœŸé–“ | ä½•ãƒ¶æœˆä¿æŒã™ã‚‹ã‹ï¼Ÿ | ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ |
| 2 | ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é »åº¦ | æ¯æ—¥ï¼Ÿé€±1å›ï¼Ÿ | å¾©æ—§å¯èƒ½ãªç¯„å›² |
| 3 | ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜å…ˆ | XServerã®ã¿ï¼ŸAWS S3ã‚‚ï¼Ÿ | ã‚³ã‚¹ãƒˆãƒ»å®‰å…¨æ€§ |
| 4 | ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ç”¨æ„ | æœ¬ç•ªã¨åŒã˜ç’°å¢ƒã‚’ç”¨æ„ã§ãã‚‹ã‹ï¼Ÿ | ç§»è¡Œãƒ†ã‚¹ãƒˆã®ç²¾åº¦ |
| 5 | ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“å¸¯ | ã„ã¤ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚’å®Ÿæ–½ã™ã‚‹ã‹ï¼Ÿ | ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ã®å½±éŸ¿ |
| 6 | ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã®å®Ÿæ–½æ—¥ | ã„ã¤å®Ÿæ–½ã™ã‚‹ã‹ï¼Ÿ | ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª¿æ•´ |
| 7 | ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯åˆ¤æ–­åŸºæº– | ã©ã®æ™‚ç‚¹ã§ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹ã‹ï¼Ÿ | éšœå®³å¯¾å¿œ |
| 8 | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™ | ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã¯ä½•ç§’ä»¥å†…ï¼Ÿ | æœ€é©åŒ–ã®ç›®æ¨™å€¤ |

---

## 10. è£œè¶³è³‡æ–™

### 10.1 Observerå®Ÿè£…

```php
// app/Observers/DepartmentObserver.php
class DepartmentObserver
{
    /**
     * éƒ¨ç½²ä½œæˆæ™‚ã«è‡ªå‹•çš„ã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ä½œæˆ
     */
    public function created(Department $department)
    {
        Calendar::create([
            'calendar_name' => $department->name . 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼',
            'calendar_type' => 'shared',
            'owner_type' => 'department',
            'owner_id' => $department->id,
        ]);
    }
    
    /**
     * éƒ¨ç½²åå¤‰æ›´æ™‚ã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åã‚‚æ›´æ–°
     */
    public function updated(Department $department)
    {
        if ($department->isDirty('name')) {
            Calendar::where('owner_type', 'department')
                ->where('owner_id', $department->id)
                ->update(['calendar_name' => $department->name . 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼']);
        }
    }
    
    /**
     * éƒ¨ç½²å‰Šé™¤æ™‚ã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚‚å‰Šé™¤
     */
    public function deleting(Department $department)
    {
        // é–¢é€£ãƒ‡ãƒ¼ã‚¿ã®ãƒã‚§ãƒƒã‚¯
        $hasUsers = $department->users()->exists();
        $hasEvents = Event::where('owner_department_id', $department->id)->exists();
        
        if ($hasUsers || $hasEvents) {
            throw new \Exception('éƒ¨ç½²ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯äºˆå®šãŒå­˜åœ¨ã™ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“');
        }
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å‰Šé™¤
        Calendar::where('owner_type', 'department')
            ->where('owner_id', $department->id)
            ->delete();
    }
}
```

### 10.2 ç§»è¡Œã‚³ãƒãƒ³ãƒ‰å®Ÿè£…

```php
// app/Console/Commands/MigrateToDepartmentSystem.php
class MigrateToDepartmentSystem extends Command
{
    protected $signature = 'migrate:department-system';
    protected $description = 'éƒ¨ç½²ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ç§»è¡Œ';
    
    public function handle()
    {
        $this->info('ç§»è¡Œã‚’é–‹å§‹ã—ã¾ã™...');
        
        // ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹
        Artisan::call('down', [
            '--message' => 'ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ä¸­ï¼ˆç´„5åˆ†ï¼‰',
            '--retry' => 60,
        ]);
        
        try {
            DB::transaction(function() {
                $this->migrateEvents();
                $this->migrateSharedNotes();
                $this->migrateSurveys();
            });
            
            $this->info('ç§»è¡ŒãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        } catch (\Exception $e) {
            $this->error('ç§»è¡Œã«å¤±æ•—ã—ã¾ã—ãŸ: ' . $e->getMessage());
            throw $e;
        } finally {
            // ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰è§£é™¤
            Artisan::call('up');
        }
    }
    
    private function migrateEvents()
    {
        $somubuDept = Department::where('name', 'ç·å‹™éƒ¨')->first();
        $somubuCalendar = Calendar::where('owner_type', 'department')
            ->where('owner_id', $somubuDept->id)
            ->first();
        
        Event::whereNull('owner_department_id')
            ->chunkById(100, function($events) use ($somubuDept, $somubuCalendar) {
                foreach ($events as $event) {
                    $creator = User::find($event->created_by);
                    
                    $event->update([
                        'calendar_id' => $somubuCalendar->calendar_id,
                        'owner_department_id' => $creator?->department_id ?? $somubuDept->id,
                        'visibility_type' => $this->determineVisibilityType($event),
                    ]);
                }
            });
        
        $this->info('Events: ' . Event::count() . 'ä»¶ã‚’ç§»è¡Œ');
    }
    
    private function determineVisibilityType($model): string
    {
        // å‚åŠ è€…ãŒ0äºº â†’ publicï¼ˆå…¨å“¡ãŒé–²è¦§å¯èƒ½ã ã£ãŸï¼‰
        if (!$model->participants()->exists()) {
            return 'public';
        }
        
        // å‚åŠ è€…ãŒã„ã‚‹ â†’ customï¼ˆç‰¹å®šã®ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ï¼‰
        return 'custom';
    }
}
```

### 10.3 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥

#### æ¨å¥¨æ§‹æˆï¼ˆäºŒé‡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰

```
1. XServeræ¨™æº–ï¼ˆç„¡æ–™ï¼‰
   - éå»7æ—¥åˆ†ã‚’è‡ªå‹•ä¿å­˜
   - çŸ­æœŸå¾©æ—§ç”¨

2. AWS S3ï¼ˆæœˆé¡30å††ï¼‰
   - éå»3ãƒ¶æœˆåˆ†ã‚’ä¿å­˜
   - é•·æœŸä¿å­˜ãƒ»ç½å®³å¯¾ç­–ç”¨
   - æ¯æ—¥æ·±å¤œ2æ™‚ã«è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

åˆè¨ˆã‚³ã‚¹ãƒˆ: å¹´é–“360å††
```

#### å®Ÿè£…

```bash
# cron ã§æ¯æ—¥å®Ÿè¡Œ
0 2 * * * /path/to/backup-script.sh

# backup-script.sh
#!/bin/bash
DATE=$(date +%Y%m%d)
BACKUP_DIR="/path/to/backups"

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
mysqldump -u user -p database > $BACKUP_DIR/db_$DATE.sql

# åœ§ç¸®
gzip $BACKUP_DIR/db_$DATE.sql

# AWS S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
aws s3 cp $BACKUP_DIR/db_$DATE.sql.gz s3://your-bucket/backups/

# 7æ—¥ä»¥ä¸Šå‰ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤
find $BACKUP_DIR -name "db_*.sql.gz" -mtime +7 -delete
```

---

## ã¾ã¨ã‚

### âœ… ç¢ºå®šäº‹é …

- å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ‰¿èªãƒ•ãƒ­ãƒ¼: å®Ÿè£…
- ãƒ‡ãƒ¼ã‚¿å…±æœ‰æ–¹å¼: å®Ÿè£…ï¼ˆå…±æœ‰å…ˆä¸€è¦§UIå«ã‚€ï¼‰
- ç¹°ã‚Šè¿”ã—äºˆå®šå‹•çš„å±•é–‹: å®Ÿè£…
- åŒæ™‚ç·¨é›†ç«¶åˆå‡¦ç†: å®Ÿè£…
- ç›£æŸ»ãƒ­ã‚°: å…±æœ‰äºˆå®šã®ã¿è¨˜éŒ²
- éƒ¨ç½²ç®¡ç†è€…é‹ç”¨: å¿…é ˆè¨­å®šãƒ»è‡ªå‹•é€šçŸ¥
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: XServer + AWS S3ï¼ˆå¹´360å††ï¼‰

### ğŸ“Š é–‹ç™ºè¦æ¨¡

- æœŸé–“: 6.5ãƒ¶æœˆ
- æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«: 4å€‹
- å¤‰æ›´ãƒ†ãƒ¼ãƒ–ãƒ«: 6å€‹
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: 15å€‹

### âš ï¸ ä¸»è¦ãƒªã‚¹ã‚¯

1. ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã®å¤±æ•—
2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ–
3. éƒ¨ç½²ç®¡ç†è€…ä¸åœ¨
4. å…±æœ‰æ©Ÿèƒ½ã®è¤‡é›‘æ€§
5. æ‰¿èªãƒ•ãƒ­ãƒ¼ã®é…å»¶

### ğŸ¯ æˆåŠŸã®ã‚«ã‚®

1. æ®µéšçš„ãƒªãƒªãƒ¼ã‚¹
2. ååˆ†ãªãƒ†ã‚¹ãƒˆï¼ˆ3å›ä»¥ä¸Šï¼‰
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•™è‚²
4. ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†
5. å®Œå…¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

### ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **å…ˆæ–¹ç¢ºèªäº‹é …ã¸ã®å›ç­”** - 16é …ç›®
2. **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æº–å‚™** - ãƒ†ã‚¹ãƒˆç’°å¢ƒã§æ¤œè¨¼
3. **å®Ÿè£…é–‹å§‹** - ãƒ•ã‚§ãƒ¼ã‚º1ã‹ã‚‰
4. **å®šæœŸãƒ¬ãƒ“ãƒ¥ãƒ¼** - å„ãƒ•ã‚§ãƒ¼ã‚ºçµ‚äº†æ™‚

---

**ä½œæˆæ—¥**: 2025å¹´1æœˆ  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: å®Œå…¨çµ±åˆç‰ˆ  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: å…ˆæ–¹ç¢ºèªå¾…ã¡  
**çµ±åˆå…ƒ**: éƒ¨ç½²æ‹¡å¼µè¦ä»¶å®šç¾©æ›¸.mdã€_v2.mdã€_v3_æœ€çµ‚ç‰ˆ.mdã€_æœ€çµ‚ç‰ˆ.md


---

## 11. è©³ç´°æ©Ÿèƒ½ä»•æ§˜

### 11.1 ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»ãƒ¡ãƒ¢ãƒ»ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯

#### ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è¡¨ç¤º

**çµ±åˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰**: å…¨ã¦ã®äºˆå®šã‚’1ã¤ã®ãƒ“ãƒ¥ãƒ¼ã«è¡¨ç¤ºã—ã€ãƒ€ãƒ–ãƒ«ãƒ–ãƒƒã‚­ãƒ³ã‚°ã‚’é˜²æ­¢

```php
// app/Http/Controllers/CalendarController.php
public function getEventsApi(Request $request)
{
    $user = auth()->user();
    $start = $request->query('start');
    $end = $request->query('end');
    
    // é–²è¦§å¯èƒ½ãªå…¨ã¦ã®äºˆå®šã‚’å–å¾—
    $events = Event::with(['creator', 'participants', 'calendar', 'recurrence'])
        ->where(function($query) use ($user) {
            $query
                // 1. å…¨ç¤¾å…¬é–‹
                ->where('visibility_type', 'public')
                
                // 2. è‡ªåˆ†ã®éƒ¨ç½²ã®éƒ¨ç½²é™å®š
                ->orWhere(function($q) use ($user) {
                    $q->where('visibility_type', 'department')
                      ->where('owner_department_id', $user->department_id);
                })
                
                // 3. å‚åŠ è€…ã¨ã—ã¦ç™»éŒ²
                ->orWhereHas('participants', function($q) use ($user) {
                    $q->where('user_id', $user->id);
                })
                
                // 4. è‡ªåˆ†ãŒä½œæˆ
                ->orWhere('created_by', $user->id);
        })
        ->whereBetween('start_date', [$start, $end])
        ->get();
    
    // ç¹°ã‚Šè¿”ã—äºˆå®šã‚’å±•é–‹
    $expandedEvents = $this->eventService->getExpandedEvents($start, $end, null);
    
    return response()->json($expandedEvents);
}
```

**ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°**:

```vue
<template>
  <div class="calendar-view">
    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¸æŠ -->
    <div class="calendar-selector">
      <Select v-model="selectedCalendar">
        <SelectTrigger>
          <SelectValue placeholder="ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é¸æŠ" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="all">
            <Globe class="h-4 w-4 inline mr-2" />
            å…¨ã¦ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
          </SelectItem>
          <SelectItem value="company">
            <Building class="h-4 w-4 inline mr-2" />
            å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
          </SelectItem>
          <SelectItem :value="`dept-${user.department_id}`">
            <Users class="h-4 w-4 inline mr-2" />
            {{ user.department.name }}ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
          </SelectItem>
        </SelectContent>
      </Select>
    </div>
    
    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º -->
    <FullCalendar :options="calendarOptions" />
  </div>
</template>
```

#### å…±æœ‰ãƒ¡ãƒ¢ã®è¡¨ç¤º

```php
// app/Http/Controllers/SharedNoteController.php
public function index(Request $request)
{
    $user = auth()->user();
    $filter = $request->query('filter', 'all'); // all, company, department, my
    
    $query = SharedNote::with(['author', 'tags', 'participants'])
        ->where('is_deleted', false);
    
    switch ($filter) {
        case 'company':
            $query->where('visibility_type', 'public');
            break;
            
        case 'department':
            $query->where('visibility_type', 'department')
                  ->where('owner_department_id', $user->department_id);
            break;
            
        case 'my':
            $query->where('author_id', $user->id);
            break;
            
        default:
            // å…¨ã¦ï¼ˆé–²è¦§å¯èƒ½ãªã‚‚ã®ï¼‰
            $query->where(function($q) use ($user) {
                $q->where('visibility_type', 'public')
                  ->orWhere(function($subQ) use ($user) {
                      $subQ->where('visibility_type', 'department')
                           ->where('owner_department_id', $user->department_id);
                  })
                  ->orWhereHas('participants', function($subQ) use ($user) {
                      $subQ->where('user_id', $user->id);
                  })
                  ->orWhere('author_id', $user->id);
            });
    }
    
    $notes = $query->orderBy('created_at', 'desc')->paginate(20);
    
    return Inertia::render('SharedNotes/Index', [
        'notes' => $notes,
        'filter' => $filter,
    ]);
}
```

**UIå®Ÿè£…**:

```vue
<template>
  <div class="shared-notes">
    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <Tabs v-model="activeFilter">
      <TabsList>
        <TabsTrigger value="all">
          å…¨ã¦
          <Badge class="ml-2">{{ counts.all }}</Badge>
        </TabsTrigger>
        <TabsTrigger value="company">
          å…¨ç¤¾
          <Badge class="ml-2">{{ counts.company }}</Badge>
        </TabsTrigger>
        <TabsTrigger value="department">
          {{ user.department.name }}
          <Badge class="ml-2">{{ counts.department }}</Badge>
        </TabsTrigger>
        <TabsTrigger value="my">
          è‡ªåˆ†ã®ãƒ¡ãƒ¢
          <Badge class="ml-2">{{ counts.my }}</Badge>
        </TabsTrigger>
      </TabsList>
    </Tabs>
    
    <!-- ãƒ¡ãƒ¢ä¸€è¦§ -->
    <div class="notes-grid">
      <NoteCard
        v-for="note in notes"
        :key="note.note_id"
        :note="note"
      />
    </div>
  </div>
</template>
```

#### ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®è¡¨ç¤º

```php
// app/Http/Controllers/SurveyController.php
public function index(Request $request)
{
    $user = auth()->user();
    $scope = $request->query('scope', 'my'); // my, department, company
    
    $query = Survey::with(['creator', 'questions', 'responses'])
        ->where('is_deleted', false)
        ->where('is_active', true);
    
    switch ($scope) {
        case 'company':
            $query->where('visibility_type', 'public');
            break;
            
        case 'department':
            $query->where('visibility_type', 'department')
                  ->where('owner_department_id', $user->department_id);
            break;
            
        case 'my':
            // è‡ªåˆ†ãŒå›ç­”å¯¾è±¡ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ
            $query->whereHas('respondents', function($q) use ($user) {
                $q->where('user_id', $user->id);
            });
            break;
    }
    
    $surveys = $query->orderBy('created_at', 'desc')->get();
    
    return Inertia::render('Surveys/Index', [
        'surveys' => $surveys,
        'scope' => $scope,
    ]);
}
```

### 11.2 ã‚´ãƒŸç®±ã®éƒ¨ç½²ç®¡ç†

#### åŸºæœ¬æ–¹é‡

1. **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**: è‡ªéƒ¨ç½²ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ã¿è¡¨ç¤º
2. **è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³**: å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚‚å«ã‚ã‚‹ã‹é¸æŠå¯èƒ½
3. **æ¨©é™**: éƒ¨ç½²ç®¡ç†è€…ã¯è‡ªéƒ¨ç½²ã®å…¨ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç®¡ç†ã€ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼ã¯è‡ªåˆ†ãŒå‰Šé™¤ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã®ã¿

#### å‰Šé™¤æ™‚ã®å‡¦ç†

```php
// app/Services/EventService.php
public function deleteEvent(Event $event)
{
    $user = auth()->user();
    
    // ã‚´ãƒŸç®±ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆ
    TrashItem::create([
        'user_id' => $user->id,
        'item_type' => 'event',
        'is_shared' => true,
        'item_id' => $event->event_id,
        'original_title' => $event->title,
        'owner_department_id' => $event->owner_department_id,
        'visibility_type' => $event->visibility_type,
        'deleted_at' => now(),
        'permanent_delete_at' => now()->addDays(30),
    ]);
    
    $event->delete();
}
```

#### ã‚´ãƒŸç®±ã®è¡¨ç¤º

```php
// app/Http/Controllers/TrashController.php
public function index(Request $request)
{
    $user = auth()->user();
    $preferences = $user->preferences ?? new UserPreference();
    
    $query = TrashItem::with(['user'])
        ->where(function($q) use ($user, $preferences) {
            // 1. è‡ªåˆ†ãŒå‰Šé™¤ã—ãŸã‚¢ã‚¤ãƒ†ãƒ 
            $q->where('user_id', $user->id);
            
            // 2. éƒ¨ç½²ç®¡ç†è€…ã®å ´åˆ: è‡ªéƒ¨ç½²ã®å…¨ã‚¢ã‚¤ãƒ†ãƒ 
            if ($user->role_type === 'department_admin') {
                $q->orWhere('owner_department_id', $user->department_id);
            }
            
            // 3. å…¨ç¤¾ç®¡ç†è€…ã®å ´åˆ: å…¨ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ 
            if ($user->role_type === 'company_admin') {
                $q->orWhereNotNull('id');
            }
        });
    
    // è¨­å®šã«å¿œã˜ã¦å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å«ã‚ã‚‹
    if (!$preferences->show_company_calendar_in_trash) {
        $query->where(function($q) {
            $q->where('visibility_type', '!=', 'public')
              ->orWhereNull('visibility_type');
        });
    }
    
    $trashItems = $query->orderBy('deleted_at', 'desc')->get();
    
    return Inertia::render('Trash/Index', [
        'trashItems' => $trashItems,
        'showCompanyItems' => $preferences->show_company_calendar_in_trash,
    ]);
}
```

#### ã‚´ãƒŸç®±è¨­å®šUI

```vue
<template>
  <div class="trash-view">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold">ã‚´ãƒŸç®±</h1>
      
      <!-- è¨­å®š -->
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button variant="outline" size="sm">
            <Settings class="h-4 w-4 mr-2" />
            è¡¨ç¤ºè¨­å®š
          </Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent align="end">
          <DropdownMenuLabel>è¡¨ç¤ºã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ </DropdownMenuLabel>
          <DropdownMenuSeparator />
          <DropdownMenuCheckboxItem
            :checked="showCompanyItems"
            @update:checked="toggleCompanyItems"
          >
            å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚‚è¡¨ç¤º
          </DropdownMenuCheckboxItem>
        </DropdownMenuContent>
      </DropdownMenu>
    </div>
    
    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <Tabs v-model="activeFilter">
      <TabsList>
        <TabsTrigger value="all">å…¨ã¦</TabsTrigger>
        <TabsTrigger value="event">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</TabsTrigger>
        <TabsTrigger value="note">ãƒ¡ãƒ¢</TabsTrigger>
        <TabsTrigger value="survey">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</TabsTrigger>
      </TabsList>
    </Tabs>
    
    <!-- ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§ -->
    <div class="space-y-2 mt-4">
      <TrashItemCard
        v-for="item in filteredItems"
        :key="item.id"
        :item="item"
        @restore="handleRestore"
        @delete="handlePermanentDelete"
      />
    </div>
  </div>
</template>
```

### 11.3 ä»–éƒ¨ç½²ã«ã¾ãŸãŒã‚‹äºˆå®šã®æ‰±ã„

#### è§£æ±ºç­–: å‚åŠ è€…ãƒ™ãƒ¼ã‚¹ã®è¡¨ç¤º

ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ ã›ãšã€**å‚åŠ è€…ãŒã„ã‚Œã°ã€ãã®äººã®éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ã‚‚è¡¨ç¤º**ã™ã‚‹æ–¹å¼ã‚’æ¡ç”¨ã€‚

```php
// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºæ™‚ã®ã‚¯ã‚¨ãƒª
public function getEventsForCalendar(int $calendarId, User $user)
{
    $calendar = Calendar::findOrFail($calendarId);
    
    $events = Event::with(['creator', 'participants', 'calendar'])
        ->where(function($query) use ($calendar, $user) {
            // 1. ã“ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç›´æ¥ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹äºˆå®š
            $query->where('calendar_id', $calendarId);
            
            // 2. å‚åŠ è€…ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹äºˆå®šï¼ˆä»–éƒ¨ç½²ã®äºˆå®šã‚‚å«ã‚€ï¼‰
            if ($calendar->owner_type === 'department') {
                $query->orWhereHas('participants', function($q) use ($calendar) {
                    $q->whereHas('user', function($subQ) use ($calendar) {
                        $subQ->where('department_id', $calendar->owner_id);
                    });
                });
            }
            
            // 3. å…¨ç¤¾å…¬é–‹ã®äºˆå®š
            $query->orWhere('visibility_type', 'public');
        })
        ->get();
    
    return $events;
}
```

**å…±åŒç·¨é›†**: å‚åŠ è€…ã¯å…¨å“¡ç·¨é›†å¯èƒ½

```php
// app/Policies/EventPolicy.php
public function update(User $user, Event $event): bool
{
    // 1. ä½œæˆè€…æœ¬äºº
    if ($event->created_by === $user->id) {
        return true;
    }
    
    // 2. å‚åŠ è€…ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ï¼ˆä»–éƒ¨ç½²ã§ã‚‚ç·¨é›†å¯èƒ½ï¼‰
    if ($event->participants->contains($user->id)) {
        return true;
    }
    
    // 3. éƒ¨ç½²ç®¡ç†è€…ï¼ˆåŒã˜éƒ¨ç½²ã®ã¿ï¼‰
    if ($user->role_type === 'department_admin' 
        && $event->owner_department_id === $user->department_id) {
        return true;
    }
    
    return false;
}
```

### 11.4 æ¨ªæ–­æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼

```php
// ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…
public function search(Request $request)
{
    $query = Event::query();
    
    // éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨ï¼‰
    if ($request->department_id) {
        $query->where('owner_department_id', $request->department_id);
    }
    
    // å…¬é–‹ç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨ï¼‰
    if ($request->visibility_type) {
        $query->where('visibility_type', $request->visibility_type);
    }
    
    // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨ï¼‰
    if ($request->start_date && $request->end_date) {
        $query->whereBetween('start_date', [$request->start_date, $request->end_date]);
    }
    
    // ä½œæˆè€…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨ï¼‰
    if ($request->created_by) {
        $query->where('created_by', $request->created_by);
    }
    
    return $query->with(['creator', 'calendar', 'participants'])->get();
}
```

```vue
<template>
  <div class="space-y-4">
    <div class="grid grid-cols-4 gap-4">
      <!-- éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
      <Select v-model="filters.department_id">
        <SelectTrigger>
          <SelectValue placeholder="éƒ¨ç½²" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem :value="null">å…¨éƒ¨ç½²</SelectItem>
          <SelectItem v-for="dept in departments" :key="dept.id" :value="dept.id">
            {{ dept.name }}
          </SelectItem>
        </SelectContent>
      </Select>
      
      <!-- å…¬é–‹ç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
      <Select v-model="filters.visibility_type">
        <SelectTrigger>
          <SelectValue placeholder="å…¬é–‹ç¯„å›²" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem :value="null">å…¨ã¦</SelectItem>
          <SelectItem value="public">å…¨ç¤¾å…¬é–‹</SelectItem>
          <SelectItem value="department">éƒ¨ç½²é™å®š</SelectItem>
          <SelectItem value="custom">ç‰¹å®šãƒ¡ãƒ³ãƒãƒ¼</SelectItem>
          <SelectItem value="private">éå…¬é–‹</SelectItem>
        </SelectContent>
      </Select>
      
      <!-- æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
      <DateRangePicker v-model="filters.dateRange" />
      
      <!-- ä½œæˆè€…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
      <UserSelect v-model="filters.created_by" placeholder="ä½œæˆè€…" />
    </div>
    
    <!-- æ¤œç´¢çµæœ -->
    <div class="space-y-2">
      <EventCard v-for="event in searchResults" :key="event.id" :event="event" />
    </div>
  </div>
</template>
```

---

## 12. LINE WORKSã¨ã®ä»•æ§˜å·®ç•°

### å®Œå…¨ä¸€è‡´ï¼ˆ13ä»¶ï¼‰

| é …ç›® | çŠ¶æ…‹ |
|------|------|
| éƒ¨ç½²ç®¡ç†è€…å¿…é ˆ | âœ… åŒã˜ |
| éƒ¨ç½²ç„¡åŠ¹åŒ–æ™‚ | âœ… åŒã˜ï¼ˆé–²è¦§ã®ã¿ï¼‰ |
| ç¹°ã‚Šè¿”ã—äºˆå®šã®ç•°å‹•æ™‚ | âœ… åŒã˜ï¼ˆå…ƒã®éƒ¨ç½²ã«æ®‹ã™ï¼‰ |
| ã‚´ãƒŸç®±è¡¨ç¤º | âœ… åŒã˜ï¼ˆéƒ¨ç½²å†…+è¨­å®šï¼‰ |
| ä»–éƒ¨ç½²ã«ã¾ãŸãŒã‚‹äºˆå®š | âœ… åŒã˜ï¼ˆå‚åŠ è€…ãƒ™ãƒ¼ã‚¹è¡¨ç¤ºï¼‰ |
| éƒ¨ç½²å‰Šé™¤æ™‚ãƒã‚§ãƒƒã‚¯ | âœ… åŒã˜ï¼ˆãƒ‡ãƒ¼ã‚¿å­˜åœ¨æ™‚ã‚¨ãƒ©ãƒ¼ï¼‰ |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¯¾ç­– | âœ… åŒã˜ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹+ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ |
| éƒ¨ç½²åå¤‰æ›´ | âœ… åŒã˜ï¼ˆè‡ªå‹•åæ˜ ï¼‰ |
| é€šçŸ¥æ©Ÿèƒ½ | âœ… åŒã˜ï¼ˆé‡è¦ãªäºˆå®šã®ã¿ï¼‰ |
| ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ | âœ… åŒã˜ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ï¼‰ |
| ç›£æŸ»ãƒ­ã‚° | âœ… åŒã˜ï¼ˆé‡è¦ãªå¤‰æ›´ã®ã¿ï¼‰ |

### æœ¬ã‚¢ãƒ—ãƒªç‹¬è‡ªï¼ˆã‚ˆã‚Šè‰¯ã„å®Ÿè£…ï¼‰ï¼ˆ4ä»¶ï¼‰

| é …ç›® | LINE WORKS | æœ¬ã‚¢ãƒ—ãƒª | ç†ç”± |
|------|-----------|---------|------|
| è¤‡æ•°éƒ¨ç½²ç®¡ç†è€… | å¯¾å¿œ | ä¸è¦ | 50åè¦æ¨¡ã§ã¯ä¸è¦ |
| é€€è·è€…é™¤å¤– | æ‰‹å‹• | è‡ªå‹• | 50åè¦æ¨¡ã§ã¯è‡ªå‹•åŒ–ãŒåŠ¹ç‡çš„ |
| éƒ¨ç½²çµ±å»ƒåˆ | æ‰‹å‹• | è‡ªå‹• | 50åè¦æ¨¡ã§ã¯è‡ªå‹•åŒ–ãŒåŠ¹ç‡çš„ |
| åŒæ™‚ç·¨é›†ç«¶åˆ | æœ€çµ‚æ›´æ–°å„ªå…ˆ | æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ | ã‚ˆã‚Šå®‰å…¨ |

### LINE WORKSã«åˆã‚ã›ã¦å¤‰æ›´ï¼ˆ3ä»¶ï¼‰

| é …ç›® | å½“åˆè¨­è¨ˆ | LINE WORKS | å¤‰æ›´å†…å®¹ |
|------|---------|-----------|---------|
| å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æŠ•ç¨¿ | ç›´æ¥æŠ•ç¨¿ | æ‰¿èªãƒ•ãƒ­ãƒ¼ | âœ… æ‰¿èªåˆ¶ã«å¤‰æ›´ |
| ä»–éƒ¨ç½²ãƒ‡ãƒ¼ã‚¿å…±æœ‰ | è¤‡è£½ | å…±æœ‰ | âœ… å…±æœ‰æ–¹å¼ã«å¤‰æ›´ |
| ç¹°ã‚Šè¿”ã—äºˆå®šå±•é–‹ | 3ãƒ¶æœˆäº‹å‰å±•é–‹ | å‹•çš„å±•é–‹ | âœ… å‹•çš„å±•é–‹ã«å¤‰æ›´ |

---

## 13. è¿½åŠ ã®UIå®Ÿè£…ä¾‹

### 13.1 éƒ¨ç½²ç•°å‹•ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°

```vue
<Dialog v-model:open="showTransferConfirm">
  <DialogContent class="max-w-2xl">
    <DialogHeader>
      <DialogTitle>éƒ¨ç½²ç•°å‹•ã®ç¢ºèª</DialogTitle>
      <DialogDescription>
        ä»¥ä¸‹ã®äºˆå®šã¯å‚åŠ è€…ãŒã‚ãªãŸã®ã¿ã§ã™ã€‚ç•°å‹•å¾Œã®æ‰±ã„ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
      </DialogDescription>
    </DialogHeader>
    
    <div class="space-y-4">
      <div class="max-h-60 overflow-y-auto space-y-2 border rounded-lg p-4">
        <div v-for="event in soloEvents" :key="event.event_id" class="p-3 bg-gray-50 rounded">
          <div class="font-medium">{{ event.title }}</div>
          <div class="text-sm text-gray-500">
            {{ formatDate(event.start_date) }} - {{ formatDate(event.end_date) }}
          </div>
          <div class="text-xs text-gray-400 mt-1">
            {{ event.calendar.calendar_name }}
          </div>
        </div>
      </div>
      
      <RadioGroup v-model="transferOption">
        <div class="space-y-3">
          <div class="flex items-start space-x-3 p-3 border rounded-lg hover:bg-gray-50">
            <RadioGroupItem value="transfer" id="transfer" />
            <Label for="transfer" class="flex-1 cursor-pointer">
              <div class="font-medium">æ–°ã—ã„éƒ¨ç½²ã«ç§»å‹•</div>
              <div class="text-sm text-gray-500">
                {{ newDepartment.name }}ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç§»å‹•ã—ã€å¼•ãç¶šãç·¨é›†ã§ãã¾ã™
              </div>
            </Label>
          </div>
          
          <div class="flex items-start space-x-3 p-3 border rounded-lg hover:bg-gray-50">
            <RadioGroupItem value="keep" id="keep" />
            <Label for="keep" class="flex-1 cursor-pointer">
              <div class="font-medium">å…ƒã®éƒ¨ç½²ã«æ®‹ã™</div>
              <div class="text-sm text-gray-500">
                {{ oldDepartment.name }}ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«æ®‹ã—ã€æ‰€æœ‰æ¨©ã‚’éƒ¨ç½²ç®¡ç†è€…ã«ç§»è­²ã—ã¾ã™
                ï¼ˆã‚ãªãŸã¯ç·¨é›†ã§ããªããªã‚Šã¾ã™ï¼‰
              </div>
            </Label>
          </div>
        </div>
      </RadioGroup>
    </div>
    
    <DialogFooter>
      <Button variant="outline" @click="showTransferConfirm = false">
        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      </Button>
      <Button @click="confirmTransfer">
        ç¢ºå®š
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

### 13.2 é€€è·è€…ç„¡åŠ¹åŒ–ãƒ€ã‚¤ã‚¢ãƒ­ã‚°

```vue
<Dialog v-model:open="showDeactivateDialog">
  <DialogContent>
    <DialogHeader>
      <DialogTitle>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç„¡åŠ¹åŒ–</DialogTitle>
      <DialogDescription>
        {{ user.name }}ã•ã‚“ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™
      </DialogDescription>
    </DialogHeader>
    
    <div class="space-y-4">
      <Alert variant="warning">
        <AlertCircle class="h-4 w-4" />
        <AlertTitle>è‡ªå‹•å‡¦ç†ã•ã‚Œã‚‹å†…å®¹</AlertTitle>
        <AlertDescription>
          <ul class="list-disc list-inside space-y-1 mt-2">
            <li>ä½œæˆã—ãŸæœªæ¥ã®äºˆå®š â†’ éƒ¨ç½²ç®¡ç†è€…ã«ç§»è­²</li>
            <li>ä½œæˆã—ãŸå…±æœ‰ãƒ¡ãƒ¢ â†’ éƒ¨ç½²ç®¡ç†è€…ã«ç§»è­²</li>
            <li>ä½œæˆã—ãŸã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ â†’ éƒ¨ç½²ç®¡ç†è€…ã«ç§»è­²</li>
            <li>å‚åŠ äºˆå®šã®æœªæ¥ã®äºˆå®š â†’ è‡ªå‹•çš„ã«é™¤å¤–</li>
          </ul>
        </AlertDescription>
      </Alert>
      
      <div class="space-y-2">
        <Label for="reason">ç„¡åŠ¹åŒ–ã®ç†ç”±</Label>
        <Textarea
          id="reason"
          v-model="reason"
          placeholder="ä¾‹ï¼šé€€è·ã€ä¼‘è·ãªã©"
          rows="3"
        />
      </div>
    </div>
    
    <DialogFooter>
      <Button variant="outline" @click="showDeactivateDialog = false">
        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      </Button>
      <Button variant="destructive" @click="handleDeactivate">
        ç„¡åŠ¹åŒ–
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

### 13.3 éƒ¨ç½²çµ±å»ƒåˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°

```vue
<Dialog v-model:open="showMergeDialog">
  <DialogContent class="max-w-2xl">
    <DialogHeader>
      <DialogTitle>éƒ¨ç½²ã®çµ±åˆ</DialogTitle>
      <DialogDescription>
        è¤‡æ•°ã®éƒ¨ç½²ã‚’1ã¤ã«çµ±åˆã—ã¾ã™
      </DialogDescription>
    </DialogHeader>
    
    <div class="space-y-4">
      <div class="space-y-2">
        <Label>çµ±åˆå…ƒã®éƒ¨ç½²ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</Label>
        <MultiSelect
          v-model="sourceDepartments"
          :options="availableDepartments"
          placeholder="çµ±åˆã™ã‚‹éƒ¨ç½²ã‚’é¸æŠ..."
        />
      </div>
      
      <div class="space-y-2">
        <Label>çµ±åˆå…ˆã®éƒ¨ç½²</Label>
        <Select v-model="targetDepartment">
          <SelectTrigger>
            <SelectValue placeholder="çµ±åˆå…ˆã‚’é¸æŠ" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem
              v-for="dept in availableDepartments"
              :key="dept.id"
              :value="dept.id"
            >
              {{ dept.name }}
            </SelectItem>
          </SelectContent>
        </Select>
      </div>
      
      <div class="space-y-2">
        <Label>çµ±åˆã®ç†ç”±</Label>
        <Textarea
          v-model="reason"
          placeholder="ä¾‹ï¼šçµ„ç¹”å†ç·¨ã®ãŸã‚"
          rows="2"
        />
      </div>
      
      <Alert variant="warning">
        <AlertCircle class="h-4 w-4" />
        <AlertTitle>è‡ªå‹•å‡¦ç†ã•ã‚Œã‚‹å†…å®¹</AlertTitle>
        <AlertDescription>
          <ul class="list-disc list-inside space-y-1 mt-2">
            <li>çµ±åˆå…ƒã®å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ çµ±åˆå…ˆã«ç§»å‹•</li>
            <li>çµ±åˆå…ƒã®å…¨äºˆå®šãƒ»ãƒ¡ãƒ¢ãƒ»ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ â†’ çµ±åˆå…ˆã«ç§»å‹•</li>
            <li>çµ±åˆå…ƒã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ â†’ çµ±åˆå…ˆã«çµ±åˆ</li>
            <li>çµ±åˆå…ƒã®éƒ¨ç½² â†’ ç„¡åŠ¹åŒ–ï¼ˆå±¥æ­´ã¨ã—ã¦ä¿æŒï¼‰</li>
          </ul>
        </AlertDescription>
      </Alert>
      
      <Alert>
        <Info class="h-4 w-4" />
        <AlertDescription>
          ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚æ…é‡ã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
        </AlertDescription>
      </Alert>
    </div>
    
    <DialogFooter>
      <Button variant="outline" @click="showMergeDialog = false">
        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      </Button>
      <Button 
        variant="destructive" 
        @click="handleMerge"
        :disabled="!canMerge"
      >
        çµ±åˆã‚’å®Ÿè¡Œ
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

---

**æ›´æ–°æ—¥**: 2025å¹´1æœˆ  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: å®Œå…¨çµ±åˆç‰ˆ v2  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: å…¨å†…å®¹çµ±åˆå®Œäº†


---

## 14. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ãƒ»UIè©³ç´°ä»•æ§˜

### 14.1 æ–°è¦ç™»éŒ²æ™‚ã®éƒ¨ç½²é¸æŠ

#### å®Ÿè£…

```php
// app/Http/Controllers/Auth/RegisterController.php
protected function validator(array $data)
{
    return Validator::make($data, [
        'name' => ['required', 'string', 'max:255'],
        'email' => ['required', 'string', 'email', 'max:255', 'unique:users'],
        'password' => ['required', 'string', 'min:8', 'confirmed'],
        'department_id' => ['required', 'exists:departments,id'], // è¿½åŠ 
    ]);
}

protected function create(array $data)
{
    return User::create([
        'name' => $data['name'],
        'email' => $data['email'],
        'password' => Hash::make($data['password']),
        'department_id' => $data['department_id'],
        'role_type' => 'member', // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼
    ]);
}
```

#### UIå®Ÿè£…

```vue
<template>
  <form @submit.prevent="handleRegister">
    <div class="space-y-4">
      <div>
        <Label for="name">åå‰</Label>
        <Input id="name" v-model="form.name" required />
      </div>
      
      <div>
        <Label for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</Label>
        <Input id="email" type="email" v-model="form.email" required />
      </div>
      
      <!-- éƒ¨ç½²é¸æŠï¼ˆå¿…é ˆï¼‰ -->
      <div>
        <Label for="department">æ‰€å±éƒ¨ç½² <span class="text-red-500">*</span></Label>
        <Select v-model="form.department_id" required>
          <SelectTrigger id="department">
            <SelectValue placeholder="éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem 
              v-for="dept in activeDepartments" 
              :key="dept.id" 
              :value="dept.id"
            >
              {{ dept.name }}
            </SelectItem>
          </SelectContent>
        </Select>
      </div>
      
      <div>
        <Label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</Label>
        <Input id="password" type="password" v-model="form.password" required />
      </div>
      
      <div>
        <Label for="password_confirmation">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª</Label>
        <Input id="password_confirmation" type="password" v-model="form.password_confirmation" required />
      </div>
      
      <Button type="submit" class="w-full">ç™»éŒ²</Button>
    </div>
  </form>
</template>
```

### 14.2 ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šã®åç§°å¤‰æ›´

#### ç¾çŠ¶ã®å•é¡Œ

- ç¾åœ¨: ã€Œç·å‹™éƒ¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€ã¨å›ºå®šè¡¨ç¤º
- å•é¡Œ: éƒ¨ç½²ãŒå¢—ãˆã‚‹ã¨ä¸é©åˆ‡

#### è§£æ±ºç­–

```vue
<template>
  <div class="profile-section">
    <h2 class="text-xl font-bold">
      {{ user.department?.name || 'æœªæ‰€å±' }}ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
    </h2>
    
    <div class="space-y-4 mt-4">
      <div>
        <Label>åå‰</Label>
        <div class="text-lg">{{ user.name }}</div>
      </div>
      
      <div>
        <Label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</Label>
        <div class="text-lg">{{ user.email }}</div>
      </div>
      
      <div>
        <Label>æ‰€å±éƒ¨ç½²</Label>
        <div class="text-lg flex items-center gap-2">
          <Building class="h-4 w-4" />
          {{ user.department?.name || 'æœªæ‰€å±' }}
        </div>
      </div>
      
      <div>
        <Label>å½¹å‰²</Label>
        <div class="text-lg">
          <Badge :variant="getRoleVariant(user.role_type)">
            {{ getRoleLabel(user.role_type) }}
          </Badge>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
const getRoleLabel = (roleType) => {
  const labels = {
    'member': 'ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼',
    'department_admin': 'éƒ¨ç½²ç®¡ç†è€…',
    'company_admin': 'å…¨ç¤¾ç®¡ç†è€…'
  }
  return labels[roleType] || 'ä¸æ˜'
}

const getRoleVariant = (roleType) => {
  const variants = {
    'member': 'default',
    'department_admin': 'secondary',
    'company_admin': 'destructive'
  }
  return variants[roleType] || 'default'
}
</script>
```

### 14.3 éƒ¨ç½²åå¤‰æ›´ã‚’é¸æŠå¼ã«

#### å®Ÿè£…

```php
// app/Http/Controllers/ProfileController.php
public function update(Request $request)
{
    $validated = $request->validate([
        'name' => ['required', 'string', 'max:255'],
        'email' => ['required', 'email', 'max:255', Rule::unique('users')->ignore(auth()->id())],
        'department_id' => ['required', 'exists:departments,id'], // é¸æŠå¼ã«å¤‰æ›´
    ]);
    
    $user = auth()->user();
    
    // éƒ¨ç½²å¤‰æ›´ã®å ´åˆã¯ç•°å‹•å‡¦ç†ã‚’å®Ÿè¡Œ
    if ($user->department_id !== $validated['department_id']) {
        $transferService = app(UserDepartmentTransferService::class);
        $result = $transferService->transferDepartment($user, $validated['department_id']);
        
        if (isset($result['requires_confirmation'])) {
            return back()->with('transfer_confirmation', $result);
        }
    }
    
    $user->update($validated);
    
    return back()->with('success', 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
}
```

#### UIå®Ÿè£…

```vue
<template>
  <form @submit.prevent="handleUpdate">
    <div class="space-y-4">
      <div>
        <Label for="name">åå‰</Label>
        <Input id="name" v-model="form.name" required />
      </div>
      
      <div>
        <Label for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</Label>
        <Input id="email" type="email" v-model="form.email" required />
      </div>
      
      <!-- éƒ¨ç½²é¸æŠï¼ˆé¸æŠå¼ï¼‰ -->
      <div>
        <Label for="department">æ‰€å±éƒ¨ç½²</Label>
        <Select v-model="form.department_id" required>
          <SelectTrigger id="department">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem 
              v-for="dept in activeDepartments" 
              :key="dept.id" 
              :value="dept.id"
            >
              {{ dept.name }}
            </SelectItem>
          </SelectContent>
        </Select>
        
        <!-- éƒ¨ç½²å¤‰æ›´æ™‚ã®è­¦å‘Š -->
        <Alert v-if="isDepartmentChanged" variant="warning" class="mt-2">
          <AlertCircle class="h-4 w-4" />
          <AlertDescription>
            éƒ¨ç½²ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€äºˆå®šã®æ‰€æœ‰æ¨©ç§»è­²ãªã©ã®å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã¾ã™
          </AlertDescription>
        </Alert>
      </div>
      
      <Button type="submit">æ›´æ–°</Button>
    </div>
  </form>
</template>

<script setup>
const isDepartmentChanged = computed(() => {
  return form.value.department_id !== user.value.department_id
})
</script>
```

### 14.4 åˆæœŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ

#### å¿…è¦ãªã‚¢ã‚«ã‚¦ãƒ³ãƒˆ

```
1. å…¨ç¤¾ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆ1åï¼‰
   - å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ç®¡ç†
   - å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç®¡ç†
   - å…¨éƒ¨ç½²ã®é–²è¦§

2. å„éƒ¨ç½²ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆéƒ¨ç½²æ•°åˆ†ï¼‰
   - ç·å‹™éƒ¨ç®¡ç†è€…
   - å–¶æ¥­éƒ¨ç®¡ç†è€…
   - é–‹ç™ºéƒ¨ç®¡ç†è€…
   - çµŒç†éƒ¨ç®¡ç†è€…
   ãªã©

3. ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆæ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
   - æ—¢å­˜ã®ç·å‹™éƒ¨ãƒ¡ãƒ³ãƒãƒ¼
```

#### ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å®Ÿè£…

```php
// database/seeders/DepartmentSystemSeeder.php
class DepartmentSystemSeeder extends Seeder
{
    public function run()
    {
        DB::transaction(function() {
            // 1. éƒ¨ç½²ã‚’ä½œæˆ
            $departments = [
                ['name' => 'ç·å‹™éƒ¨'],
                ['name' => 'å–¶æ¥­éƒ¨'],
                ['name' => 'é–‹ç™ºéƒ¨'],
                ['name' => 'çµŒç†éƒ¨'],
            ];
            
            foreach ($departments as $dept) {
                Department::create($dept);
            }
            
            // 2. å…¨ç¤¾ç®¡ç†è€…ã‚’ä½œæˆ
            $companyAdmin = User::create([
                'name' => 'å…¨ç¤¾ç®¡ç†è€…',
                'email' => 'admin@company.com',
                'password' => Hash::make('password'),
                'department_id' => null, // å…¨ç¤¾ç®¡ç†è€…ã¯éƒ¨ç½²ã«æ‰€å±ã—ãªã„
                'role_type' => 'company_admin',
            ]);
            
            // 3. å„éƒ¨ç½²ç®¡ç†è€…ã‚’ä½œæˆ
            $departmentAdmins = [
                ['name' => 'ç·å‹™éƒ¨ç®¡ç†è€…', 'email' => 'soumu-admin@company.com', 'department' => 'ç·å‹™éƒ¨'],
                ['name' => 'å–¶æ¥­éƒ¨ç®¡ç†è€…', 'email' => 'eigyo-admin@company.com', 'department' => 'å–¶æ¥­éƒ¨'],
                ['name' => 'é–‹ç™ºéƒ¨ç®¡ç†è€…', 'email' => 'dev-admin@company.com', 'department' => 'é–‹ç™ºéƒ¨'],
                ['name' => 'çµŒç†éƒ¨ç®¡ç†è€…', 'email' => 'keiri-admin@company.com', 'department' => 'çµŒç†éƒ¨'],
            ];
            
            foreach ($departmentAdmins as $admin) {
                $dept = Department::where('name', $admin['department'])->first();
                
                User::create([
                    'name' => $admin['name'],
                    'email' => $admin['email'],
                    'password' => Hash::make('password'),
                    'department_id' => $dept->id,
                    'role_type' => 'department_admin',
                ]);
            }
            
            // 4. å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ä½œæˆ
            Calendar::create([
                'calendar_name' => 'å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼',
                'calendar_type' => 'shared',
                'owner_type' => 'company',
                'owner_id' => null,
            ]);
            
            // 5. å„éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯ DepartmentObserver ãŒè‡ªå‹•ä½œæˆ
        });
    }
}
```

#### å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰

```bash
# ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å®Ÿè¡Œ
php artisan db:seed --class=DepartmentSystemSeeder

# ã¾ãŸã¯ migrate ã¨åŒæ™‚ã«å®Ÿè¡Œ
php artisan migrate:fresh --seed
```

### 14.5 éƒ¨ç½²ãƒ¡ãƒ³ãƒãƒ¼è¡¨ç¤º

#### è¡¨ç¤ºãƒ«ãƒ¼ãƒ«

```
ã€éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã€‘
- è¡¨ç¤º: æ‰€å±ã™ã‚‹éƒ¨ç½²ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿
- ä¾‹: ç·å‹™éƒ¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ â†’ ç·å‹™éƒ¨ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿è¡¨ç¤º

ã€å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã€‘
- è¡¨ç¤º: å„éƒ¨ç½²ç®¡ç†è€… + å…¨ç¤¾ç®¡ç†è€…
- ç†ç”±: å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯ç®¡ç†è€…ã®ã¿ãŒæŠ•ç¨¿ã™ã‚‹ãŸã‚
```

#### å®Ÿè£…

```php
// app/Http/Controllers/CalendarController.php
public function getMembers(int $calendarId)
{
    $calendar = Calendar::findOrFail($calendarId);
    
    if ($calendar->owner_type === 'company') {
        // å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼: å„éƒ¨ç½²ç®¡ç†è€… + å…¨ç¤¾ç®¡ç†è€…
        $members = User::where('is_active', true)
            ->whereIn('role_type', ['department_admin', 'company_admin'])
            ->with('department')
            ->orderBy('role_type', 'desc')
            ->orderBy('department_id')
            ->get();
    } else {
        // éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼: æ‰€å±éƒ¨ç½²ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿
        $members = User::where('is_active', true)
            ->where('department_id', $calendar->owner_id)
            ->with('department')
            ->orderBy('role_type', 'desc')
            ->orderBy('name')
            ->get();
    }
    
    return response()->json($members);
}
```

#### UIå®Ÿè£…

```vue
<template>
  <div class="members-list">
    <h3 class="font-bold mb-2">
      {{ calendar.owner_type === 'company' ? 'ç®¡ç†è€…ä¸€è¦§' : 'ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§' }}
    </h3>
    
    <div class="space-y-2">
      <div 
        v-for="member in members" 
        :key="member.id"
        class="flex items-center gap-2 p-2 border rounded"
      >
        <Avatar>
          <AvatarFallback>{{ member.name.charAt(0) }}</AvatarFallback>
        </Avatar>
        
        <div class="flex-1">
          <div class="font-medium">{{ member.name }}</div>
          <div class="text-xs text-gray-500">
            {{ member.department?.name || 'å…¨ç¤¾' }}
          </div>
        </div>
        
        <Badge v-if="member.role_type !== 'member'">
          {{ getRoleLabel(member.role_type) }}
        </Badge>
      </div>
    </div>
  </div>
</template>
```

### 14.6 ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆ‡ã‚Šæ›¿ãˆã¨æ¨©é™ã®è©³ç´°

#### åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³

```vue
<template>
  <div class="calendar-switcher">
    <Tabs v-model="activeCalendar" @update:modelValue="handleCalendarSwitch">
      <TabsList class="grid w-full grid-cols-3">
        <!-- è‡ªéƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
        <TabsTrigger :value="`dept-${user.department_id}`">
          <Building class="h-4 w-4 mr-2" />
          {{ user.department.name }}
        </TabsTrigger>
        
        <!-- å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
        <TabsTrigger value="company">
          <Globe class="h-4 w-4 mr-2" />
          å…¨ç¤¾
        </TabsTrigger>
        
        <!-- ä»–éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
        <TabsTrigger value="other">
          <Users class="h-4 w-4 mr-2" />
          ä»–éƒ¨ç½²
        </TabsTrigger>
      </TabsList>
    </Tabs>
    
    <!-- ä»–éƒ¨ç½²é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
    <Select v-if="activeCalendar === 'other'" v-model="selectedOtherDepartment">
      <SelectTrigger>
        <SelectValue placeholder="éƒ¨ç½²ã‚’é¸æŠ" />
      </SelectTrigger>
      <SelectContent>
        <SelectItem 
          v-for="dept in otherDepartments" 
          :key="dept.id" 
          :value="dept.id"
        >
          {{ dept.name }}
        </SelectItem>
      </SelectContent>
    </Select>
  </div>
</template>
```

#### æ¨©é™ãƒãƒˆãƒªã‚¯ã‚¹ï¼ˆè©³ç´°ç‰ˆï¼‰

| ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ | ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼ | éƒ¨ç½²ç®¡ç†è€… | å…¨ç¤¾ç®¡ç†è€… |
|-----------|------------|-----------|-----------|
| **è‡ªéƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼** | | | |
| - é–²è¦§ | âœ… | âœ… | âœ… |
| - ä½œæˆ | âœ… | âœ… | âœ… |
| - ç·¨é›† | âœ…ï¼ˆè‡ªåˆ†ã®äºˆå®šã®ã¿ï¼‰ | âœ…ï¼ˆå…¨äºˆå®šï¼‰ | âŒ |
| - å‰Šé™¤ | âœ…ï¼ˆè‡ªåˆ†ã®äºˆå®šã®ã¿ï¼‰ | âœ…ï¼ˆå…¨äºˆå®šï¼‰ | âŒ |
| - è¤‡è£½ | âœ… | âœ… | âœ… |
| **ä»–éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼** | | | |
| - é–²è¦§ | âœ… | âœ… | âœ… |
| - ä½œæˆ | âŒ | âŒ | âŒ |
| - ç·¨é›† | âŒ | âŒ | âŒ |
| - å‰Šé™¤ | âŒ | âŒ | âŒ |
| - è¤‡è£½ | âŒ | âœ… | âœ… |
| **å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼** | | | |
| - é–²è¦§ | âœ… | âœ… | âœ… |
| - ä½œæˆ | âŒ | âŒï¼ˆæ‰¿èªç”³è«‹ã®ã¿ï¼‰ | âœ… |
| - ç·¨é›† | âŒ | âŒ | âœ… |
| - å‰Šé™¤ | âŒ | âŒ | âœ… |
| - è¤‡è£½ | âŒ | âŒ | âŒ |

#### å®Ÿè£…

```php
// app/Policies/EventPolicy.php
public function create(User $user, Calendar $calendar): bool
{
    // å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
    if ($calendar->owner_type === 'company') {
        return $user->role_type === 'company_admin';
    }
    
    // è‡ªéƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
    if ($calendar->owner_id === $user->department_id) {
        return true;
    }
    
    // ä»–éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
    return false;
}

public function duplicate(User $user, Event $event): bool
{
    // ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼: è‡ªéƒ¨ç½²ã®äºˆå®šã®ã¿è¤‡è£½å¯èƒ½
    if ($user->role_type === 'member') {
        return $event->owner_department_id === $user->department_id;
    }
    
    // éƒ¨ç½²ç®¡ç†è€…ãƒ»å…¨ç¤¾ç®¡ç†è€…: å…¨ã¦ã®äºˆå®šã‚’è¤‡è£½å¯èƒ½
    return in_array($user->role_type, ['department_admin', 'company_admin']);
}
```

### 14.7 å…±æœ‰ãƒ¡ãƒ¢ã®åˆ‡ã‚Šæ›¿ãˆé€£å‹•

#### å®Ÿè£…ï¼ˆæ—¢ã«è¨˜è¼‰æ¸ˆã¿ã ãŒå†æ²ï¼‰

```vue
<template>
  <div class="shared-notes-view">
    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆ‡ã‚Šæ›¿ãˆã«é€£å‹• -->
    <div class="mb-4">
      <Label>è¡¨ç¤ºç¯„å›²</Label>
      <div class="text-sm text-gray-500">
        ç¾åœ¨: {{ getCurrentScopeName() }}
      </div>
    </div>
    
    <!-- ãƒ¡ãƒ¢ä¸€è¦§ï¼ˆè‡ªå‹•ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼‰ -->
    <div class="notes-grid">
      <NoteCard
        v-for="note in filteredNotes"
        :key="note.note_id"
        :note="note"
      />
    </div>
  </div>
</template>

<script setup>
const filteredNotes = computed(() => {
  if (activeCalendar.value === 'company') {
    // å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ â†’ å…¨ç¤¾å…¬é–‹ãƒ¡ãƒ¢ã®ã¿
    return notes.value.filter(n => n.visibility_type === 'public')
  } else if (activeCalendar.value.startsWith('dept-')) {
    // éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ â†’ è©²å½“éƒ¨ç½²ã®ãƒ¡ãƒ¢ã®ã¿
    const deptId = parseInt(activeCalendar.value.split('-')[1])
    return notes.value.filter(n => 
      n.visibility_type === 'department' && n.owner_department_id === deptId
    )
  }
  return notes.value
})
</script>
```

---

## 15. è¿½åŠ ã®ãƒªã‚¹ã‚¯ã¨å¯¾ç­–

### 15.1 ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®ãƒªã‚¹ã‚¯

**ãƒªã‚¹ã‚¯**: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ãŒä¸æ•´åˆ

**å¯¾ç­–**:
```php
// ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ç¾åœ¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ä¿å­˜
session(['current_calendar_id' => $calendarId]);

// ãƒšãƒ¼ã‚¸é·ç§»æ™‚ã«å¾©å…ƒ
$currentCalendarId = session('current_calendar_id', $defaultCalendarId);
```

### 14.8 é€šçŸ¥ã‚»ãƒ³ã‚¿ãƒ¼è¨­å®š

#### é€šçŸ¥ç¯„å›²ã®è¨­å®š

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯é€šçŸ¥ã‚»ãƒ³ã‚¿ãƒ¼ã§å—ã‘å–ã‚‹é€šçŸ¥ã®ç¯„å›²ã‚’è¨­å®šå¯èƒ½ã€‚

**è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³**:
1. **æ‰€å±éƒ¨ç½²ã®ã¿** - è‡ªåˆ†ã®éƒ¨ç½²ã®é€šçŸ¥ã®ã¿å—ä¿¡
2. **å…¨ç¤¾ã®ã¿** - å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®é€šçŸ¥ã®ã¿å—ä¿¡
3. **æ‰€å±éƒ¨ç½²ã¨å…¨ç¤¾ä¸¡æ–¹** - ä¸¡æ–¹ã®é€šçŸ¥ã‚’å—ä¿¡ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

```sql
ALTER TABLE user_preferences
    ADD COLUMN notification_scope ENUM('department', 'company', 'both') 
        DEFAULT 'both' AFTER show_company_calendar_in_trash;
```

#### å®Ÿè£…

```php
// app/Services/NotificationService.php
class NotificationService
{
    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é€šçŸ¥è¨­å®šã«åŸºã¥ã„ã¦é€šçŸ¥ã‚’é€ä¿¡
     */
    public function sendEventNotification(Event $event, $notification)
    {
        $calendar = $event->calendar;
        
        // é€šçŸ¥å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
        $users = User::where('is_active', true)
            ->whereHas('preferences', function($q) use ($calendar) {
                if ($calendar->owner_type === 'company') {
                    // å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼: 'company' ã¾ãŸã¯ 'both' ã‚’è¨­å®šã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼
                    $q->whereIn('notification_scope', ['company', 'both']);
                } else {
                    // éƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼: è©²å½“éƒ¨ç½²ã§ 'department' ã¾ãŸã¯ 'both' ã‚’è¨­å®šã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼
                    $q->whereIn('notification_scope', ['department', 'both'])
                      ->where('department_id', $calendar->owner_id);
                }
            })
            ->get();
        
        Notification::send($users, $notification);
    }
    
    /**
     * éƒ¨ç½²ã®é€šçŸ¥ã‚’é€ä¿¡
     */
    public function notifyDepartment(int $departmentId, $notification)
    {
        $users = User::where('department_id', $departmentId)
            ->where('is_active', true)
            ->whereHas('preferences', function($q) {
                $q->whereIn('notification_scope', ['department', 'both']);
            })
            ->get();
        
        Notification::send($users, $notification);
    }
    
    /**
     * å…¨ç¤¾é€šçŸ¥ã‚’é€ä¿¡
     */
    public function notifyCompany($notification)
    {
        $users = User::where('is_active', true)
            ->whereHas('preferences', function($q) {
                $q->whereIn('notification_scope', ['company', 'both']);
            })
            ->get();
        
        Notification::send($users, $notification);
    }
}
```

#### UIå®Ÿè£…

```vue
<template>
  <div class="notification-settings">
    <h3 class="font-bold mb-4">é€šçŸ¥è¨­å®š</h3>
    
    <div class="space-y-4">
      <div>
        <Label>é€šçŸ¥ã‚’å—ã‘å–ã‚‹ç¯„å›²</Label>
        <RadioGroup v-model="notificationScope" @update:modelValue="updateSettings">
          <div class="space-y-3 mt-2">
            <div class="flex items-start space-x-3 p-3 border rounded-lg hover:bg-gray-50">
              <RadioGroupItem value="department" id="dept-only" />
              <Label for="dept-only" class="flex-1 cursor-pointer">
                <div class="font-medium">æ‰€å±éƒ¨ç½²ã®ã¿</div>
                <div class="text-sm text-gray-500">
                  {{ user.department.name }}ã®é€šçŸ¥ã®ã¿å—ä¿¡ã—ã¾ã™
                </div>
              </Label>
            </div>
            
            <div class="flex items-start space-x-3 p-3 border rounded-lg hover:bg-gray-50">
              <RadioGroupItem value="company" id="company-only" />
              <Label for="company-only" class="flex-1 cursor-pointer">
                <div class="font-medium">å…¨ç¤¾ã®ã¿</div>
                <div class="text-sm text-gray-500">
                  å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®é€šçŸ¥ã®ã¿å—ä¿¡ã—ã¾ã™
                </div>
              </Label>
            </div>
            
            <div class="flex items-start space-x-3 p-3 border rounded-lg hover:bg-gray-50">
              <RadioGroupItem value="both" id="both" />
              <Label for="both" class="flex-1 cursor-pointer">
                <div class="font-medium">æ‰€å±éƒ¨ç½²ã¨å…¨ç¤¾ä¸¡æ–¹</div>
                <div class="text-sm text-gray-500">
                  ä¸¡æ–¹ã®é€šçŸ¥ã‚’å—ä¿¡ã—ã¾ã™ï¼ˆæ¨å¥¨ï¼‰
                </div>
              </Label>
            </div>
          </div>
        </RadioGroup>
      </div>
      
      <Alert>
        <Info class="h-4 w-4" />
        <AlertDescription>
          è¨­å®šã¯å³åº§ã«åæ˜ ã•ã‚Œã¾ã™ã€‚é‡è¦ãªé€šçŸ¥ã‚’è¦‹é€ƒã•ãªã„ã‚ˆã†ã€Œä¸¡æ–¹ã€ã®è¨­å®šã‚’æ¨å¥¨ã—ã¾ã™ã€‚
        </AlertDescription>
      </Alert>
    </div>
  </div>
</template>

<script setup>
const notificationScope = ref(user.value.preferences?.notification_scope || 'both')

const updateSettings = async (value) => {
  await axios.post('/api/user/preferences', {
    notification_scope: value,
  })
  
  toast({
    title: 'è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ',
    description: 'é€šçŸ¥è¨­å®šãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ',
  })
}
</script>
```

---

## 15. è¿½åŠ ã®ãƒªã‚¹ã‚¯ã¨å¯¾ç­–

### 15.1 ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®ãƒªã‚¹ã‚¯

**ãƒªã‚¹ã‚¯**: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ãŒä¸æ•´åˆ

**å¯¾ç­–**:
```php
// ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ç¾åœ¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ä¿å­˜
session(['current_calendar_id' => $calendarId]);

// ãƒšãƒ¼ã‚¸é·ç§»æ™‚ã«å¾©å…ƒ
$currentCalendarId = session('current_calendar_id', $defaultCalendarId);
```

### 15.2 æ¤œç´¢æ©Ÿèƒ½ã®éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼

**ãƒªã‚¹ã‚¯**: æ¤œç´¢çµæœã«ä»–éƒ¨ç½²ã®éå…¬é–‹ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã‚‹

**å¯¾ç­–**:
```php
// æ¤œç´¢æ™‚ã«éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è‡ªå‹•é©ç”¨
public function search(Request $request)
{
    $user = auth()->user();
    
    $query = Event::query()
        ->where(function($q) use ($user) {
            // é–²è¦§å¯èƒ½ãªäºˆå®šã®ã¿
            $q->where('visibility_type', 'public')
              ->orWhere(function($subQ) use ($user) {
                  $subQ->where('visibility_type', 'department')
                       ->where('owner_department_id', $user->department_id);
              })
              ->orWhere('created_by', $user->id)
              ->orWhereHas('participants', fn($subQ) => $subQ->where('user_id', $user->id));
        });
    
    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢
    if ($request->keyword) {
        $query->where('title', 'like', "%{$request->keyword}%");
    }
    
    return $query->get();
}
```

### 15.3 æ¨©é™é™æ ¼æ™‚ã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†

**ãƒªã‚¹ã‚¯**: éƒ¨ç½²ç®¡ç†è€…ã‹ã‚‰ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼ã«é™æ ¼æ™‚ã€ç®¡ç†ã—ã¦ã„ãŸäºˆå®šã®æ‰±ã„

**å¯¾ç­–**:
```php
public function demoteToMember(User $user)
{
    DB::transaction(function() use ($user) {
        // æ–°ã—ã„éƒ¨ç½²ç®¡ç†è€…ã‚’æ¢ã™
        $newAdmin = User::where('department_id', $user->department_id)
            ->where('role_type', 'department_admin')
            ->where('id', '!=', $user->id)
            ->first();
        
        if (!$newAdmin) {
            throw new \Exception('ä»–ã«éƒ¨ç½²ç®¡ç†è€…ãŒã„ã¾ã›ã‚“ã€‚å…ˆã«æ–°ã—ã„ç®¡ç†è€…ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        }
        
        // ç®¡ç†ã—ã¦ã„ãŸäºˆå®šã‚’æ–°ç®¡ç†è€…ã«ç§»è­²
        Event::where('created_by', $user->id)
            ->where('owner_department_id', $user->department_id)
            ->update(['created_by' => $newAdmin->id]);
        
        // å½¹å‰²ã‚’å¤‰æ›´
        $user->update(['role_type' => 'member']);
    });
}
```

### 15.4 ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

**ãƒªã‚¹ã‚¯**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã©ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æœ€åˆã«è¦‹ã‚‹ã¹ãã‹ä¸æ˜ç¢º

**å¯¾ç­–**:
```php
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã«å¿œã˜ãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
public function getDefaultCalendar(User $user): Calendar
{
    if ($user->role_type === 'company_admin') {
        // å…¨ç¤¾ç®¡ç†è€… â†’ å…¨ç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
        return Calendar::where('owner_type', 'company')->first();
    }
    
    // ãã®ä»– â†’ è‡ªéƒ¨ç½²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
    return Calendar::where('owner_type', 'department')
        ->where('owner_id', $user->department_id)
        ->first();
}
```

### 15.5 éƒ¨ç½²æ•°å¢—åŠ æ™‚ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

**ãƒªã‚¹ã‚¯**: éƒ¨ç½²ãŒ10å€‹ä»¥ä¸Šã«ãªã‚‹ã¨ã‚¯ã‚¨ãƒªãŒé…å»¶

**å¯¾ç­–**:
```php
// éƒ¨ç½²ä¸€è¦§ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
public function getActiveDepartments()
{
    return Cache::remember('active_departments', now()->addHours(1), function() {
        return Department::where('is_active', true)
            ->orderBy('name')
            ->get();
    });
}

// éƒ¨ç½²ä½œæˆãƒ»æ›´æ–°æ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
public function store(Request $request)
{
    $department = Department::create($request->validated());
    Cache::forget('active_departments');
    return $department;
}
```

---

**æ›´æ–°æ—¥**: 2025å¹´1æœˆ  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: å®Œå…¨çµ±åˆç‰ˆ v3  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ãƒ»ãƒªã‚¹ã‚¯è¿½è¨˜å®Œäº†
